<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Collection Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --m-blue: #92a8d1; /* è«è˜­è¿ªè— */
            --m-green: #88b04b; /* è«è˜­è¿ªç¶  */
            --m-grey: #b5b5b5; /* è«è˜­è¿ªç° */
            --m-sage: #acc1ad; /* é¼ å°¾è‰ç¶  */
            --m-sand: #d5cabd; /* è«è˜­è¿ªç±³ */
            --bg: #f4f4f2;
            --text: #5f5f5f;
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }

        /* --- é«˜æ¸…å°é¢é  --- */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #dcdde1; background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: transform 0.6s ease-in-out;
        }
        #cover-page.open { transform: translateY(-100%); }
        
        .cover-upload-label { 
            position: absolute; top: 30px; left: 30px; font-size: 13px;
            background: rgba(255,255,255,0.7); color: var(--text); padding: 10px 20px; border-radius: 5px;
            cursor: pointer; border: 1px solid var(--m-grey);
        }

        .cover-menu { display: flex; flex-direction: column; gap: 15px; width: 280px; }
        .menu-btn { 
            background: var(--card-bg); border: 1px solid var(--m-sage); color: var(--text);
            padding: 16px; border-radius: 4px; font-size: 15px; cursor: pointer;
            text-align: center; letter-spacing: 1px; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .menu-btn:hover { background: var(--m-sage); color: white; }

        /* --- å…§å®¹å€åŸŸ --- */
        .main-content { padding: 25px; padding-bottom: 120px; min-height: 100vh; max-width: 600px; margin: 0 auto; }
        .back-to-cover { margin-bottom: 25px; cursor: pointer; color: var(--m-blue); font-weight: bold; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .glass-card { 
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        /* è¡¨å–® */
        label { display: block; font-size: 13px; margin: 15px 0 5px; color: var(--m-blue); font-weight: 600; }
        input, select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;
            background: #fafafa; color: var(--text); box-sizing: border-box;
        }

        /* ç•«å»Šå¡ç‰‡ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .item-card { background: white; border-radius: 10px; overflow: hidden; border: 1px solid #eee; position: relative; }
        .item-img { width: 100%; height: 150px; object-fit: cover; }
        .item-info { padding: 10px; }
        .price-tag { color: var(--m-green); font-weight: bold; font-size: 15px; }

        /* å°èˆª */
        .nav-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: white;
            display: flex; justify-content: space-around; padding: 15px;
            border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 1000;
        }
        .nav-item { border: none; background: none; color: #ccc; font-size: 20px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--m-blue); transform: scale(1.2); }

        /* åœ–è¡¨å®¹å™¨ */
        canvas { max-width: 100%; margin: 20px 0; }
        .stats-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ddd; font-size: 14px; }
    </style>
</head>
<body>

    <div id="cover-page">
        <label class="cover-upload-label">ğŸ“¸ æ›´æ›é«˜æ¸…å°é¢ <input type="file" id="cover-upload" hidden accept="image/*"></label>
        <div class="cover-menu">
            <h2 style="text-align: center; color: var(--text); font-weight: 300; margin-bottom: 30px;">COLLECTION LOG</h2>
            <div class="menu-btn" onclick="openPage('page-gallery')">é€²å…¥è—å“åº«</div>
            <div class="menu-btn" onclick="openPage('page-stats')">æ”¯å‡ºçµ±è¨ˆåˆ†æ</div>
            <div class="menu-btn" onclick="openPage('page-recent')">æ–°å¢/ç·¨è¼¯å‘¨é‚Š</div>
            <div class="menu-btn" onclick="openPage('page-pending')">å°‡åˆ°éç¾è²¨</div>
        </div>
    </div>

    <div class="main-content">
        <div class="back-to-cover" onclick="closePage()">â—€ è¿”å›å°é¢</div>

        <div id="page-gallery" class="page">
            <h3 style="color:var(--m-blue)">ğŸ’ ç¾è²¨é¤¨è—</h3>
            <div class="gallery" id="readyList"></div>
        </div>

        <div id="page-stats" class="page">
            <div class="glass-card">
                <h3 style="color:var(--m-sage)">ğŸ’° æ”¯å‡ºç¸½è¦½</h3>
                <div id="totalSpend" style="font-size: 24px; font-weight: bold; color: var(--m-green);">HKD 0</div>
                <canvas id="charPieChart"></canvas>
            </div>
            <div class="glass-card">
                <h4 style="color:var(--m-blue)">ğŸ“… æ¯æœˆæ”¯å‡ºçµ±è¨ˆ</h4>
                <div id="monthlyStats"></div>
            </div>
        </div>

        <div id="page-recent" class="page">
            <div class="glass-card">
                <h3 id="formTitle">ğŸ“ è¨˜éŒ„æ–°æˆå“¡</h3>
                <form id="merchForm">
                    <input type="hidden" id="editIndex" value="-1">
                    <label>è§’è‰²</label><input type="text" id="role" placeholder="ä¾‹å¦‚ï¼šåˆéŸ³æœªä¾†" required>
                    <label>æŸ„åœ–åå­—</label><input type="text" id="pattern" placeholder="ä¾‹å¦‚ï¼š2025ä¸»è¦–è¦º">
                    <label>å‘¨é‚Šåç¨±</label><input type="text" id="name" required placeholder="ä¾‹å¦‚ï¼šå¾½ç« ">
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>ç‹€æ…‹</label>
                            <select id="status"><option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option></select>
                        </div>
                        <div><label>æ•¸é‡</label><input type="number" id="qty" value="1" min="1"></div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                        <div><label>å¹£ç¨®</label><select id="currency"><option value="HKD">HKD</option><option value="RMB">RMB</option><option value="JPY">JPY</option></select></div>
                        <div><label>å–®åƒ¹ (åŸå¹£)</label><input type="number" id="inputPrice" step="0.01" required></div>
                    </div>

                    <label>è³¼å…¥æ—¥æœŸ</label><input type="date" id="buyDate">
                    <label>ç…§ç‰‡</label><input type="file" id="imgFile">
                    
                    <button type="submit" id="submitBtn" class="menu-btn" style="width:100%; margin-top:20px; background:var(--m-sage); color:white; border:none;">ç¢ºèªå­˜æª”</button>
                    <button type="button" id="cancelBtn" class="menu-btn" style="width:100%; margin-top:10px; display:none;" onclick="resetForm()">å–æ¶ˆç·¨è¼¯</button>
                </form>
            </div>
        </div>

        <div id="page-pending" class="page">
            <h3 style="color:var(--m-grey)">âŒ› éç¾è²¨æ¸…å–®</h3>
            <div class="gallery" id="waitList"></div>
        </div>
    </div>

    <nav class="nav-bar" id="bottom-nav" style="display:none;">
        <button class="nav-item active" onclick="switchTab('page-gallery', this)">ğŸ–¼ï¸</button>
        <button class="nav-item" onclick="switchTab('page-stats', this)">ğŸ“Š</button>
        <button class="nav-item" onclick="switchTab('page-recent', this)">â•</button>
        <button class="nav-item" onclick="switchTab('page-pending', this)">ğŸ“¦</button>
    </nav>

<script>
    let merchList = JSON.parse(localStorage.getItem('mm25_morandi_data')) || [];
    const rates = { RMB: 1.08, JPY: 0.052, HKD: 1.0 };
    let myChart = null;

    // å°é¢é‚è¼¯
    const coverPage = document.getElementById('cover-page');
    if(localStorage.getItem('mm25_hd_cover')) coverPage.style.backgroundImage = `url(${localStorage.getItem('mm25_hd_cover')})`;
    document.getElementById('cover-upload').onchange = e => {
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('mm25_hd_cover', r.result); coverPage.style.backgroundImage = `url(${r.result})`; };
        r.readAsDataURL(e.target.files[0]);
    };

    function openPage(id) { 
        document.getElementById('cover-page').classList.add('open');
        document.getElementById('bottom-nav').style.display = 'flex';
        switchTab(id, document.querySelector(`[onclick*="${id}"]`)); 
    }
    function closePage() { document.getElementById('cover-page').classList.remove('open'); document.getElementById('bottom-nav').style.display = 'none'; }

    function switchTab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(id === 'page-stats') renderStats();
        renderAll();
    }

    function renderAll() {
        const genHTML = (item, idx) => `
            <div class="item-card">
                <img src="${item.img || 'https://via.placeholder.com/150/efefef/999999?text=No+Photo'}" class="item-img">
                <div class="item-info">
                    <div style="font-size:11px; color:var(--m-blue)">${item.role}</div>
                    <div style="font-weight:bold; font-size:13px; margin:2px 0;">${item.name}</div>
                    <div class="price-tag">HK$ ${item.totalHkd}</div>
                    <div style="font-size:10px; opacity:0.6;">x ${item.qty} (${item.pattern})</div>
                    <div style="margin-top:8px; display:flex; gap:10px;">
                        <span style="font-size:11px; cursor:pointer; color:var(--m-blue)" onclick="editItem(${idx})">ç·¨è¼¯</span>
                        <span style="font-size:11px; cursor:pointer; color:#d9534f" onclick="deleteItem(${idx})">åˆªé™¤</span>
                    </div>
                </div>
            </div>`;

        document.getElementById('readyList').innerHTML = merchList.filter(i => i.status === 'ç¾è²¨').map(i => genHTML(i, merchList.indexOf(i))).join('');
        document.getElementById('waitList').innerHTML = merchList.filter(i => i.status === 'éç¾è²¨').map(i => genHTML(i, merchList.indexOf(i))).join('');
    }

    // æ•¸æ“šçµ±è¨ˆé‚è¼¯
    function renderStats() {
        let total = 0;
        let charData = {};
        let monthData = {};

        merchList.forEach(item => {
            const val = parseFloat(item.totalHkd);
            total += val;
            charData[item.role] = (charData[item.role] || 0) + val;
            
            if(item.buyDate) {
                const m = item.buyDate.substring(0, 7); // YYYY-MM
                monthData[m] = (monthData[m] || 0) + val;
            }
        });

        document.getElementById('totalSpend').innerText = `HKD ${total.toLocaleString()}`;

        // åœ“é¤…åœ–
        const ctx = document.getElementById('charPieChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(charData),
                datasets: [{
                    data: Object.values(charData),
                    backgroundColor: ['#92a8d1', '#acc1ad', '#d5cabd', '#b5b5b5', '#e1bee7', '#ffccbc']
                }]
            },
            options: { plugins: { title: { display: true, text: 'å„è§’è‰²æ”¯å‡ºåˆ†ä½ˆ' } } }
        });

        // æ¯æœˆçµ±è¨ˆåˆ—è¡¨
        document.getElementById('monthlyStats').innerHTML = Object.keys(monthData).sort().reverse().map(m => `
            <div class="stats-row"><span>${m}</span><b>HK$ ${monthData[m].toLocaleString()}</b></div>
        `).join('');
    }

    function editItem(idx) {
        const item = merchList[idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('role').value = item.role;
        document.getElementById('pattern').value = item.pattern;
        document.getElementById('name').value = item.name;
        document.getElementById('status').value = item.status;
        document.getElementById('qty').value = item.qty;
        document.getElementById('currency').value = item.originalCur;
        document.getElementById('inputPrice').value = item.originalPrice;
        document.getElementById('buyDate').value = item.buyDate || '';
        
        document.getElementById('formTitle').innerText = "âœï¸ ä¿®æ”¹å‘¨é‚Šè³‡æ–™";
        document.getElementById('submitBtn').innerText = "å„²å­˜ä¿®æ”¹";
        document.getElementById('cancelBtn').style.display = "block";
        switchTab('page-recent', document.querySelector(`[onclick*="page-recent"]`));
    }

    function resetForm() {
        document.getElementById('merchForm').reset();
        document.getElementById('editIndex').value = "-1";
        document.getElementById('formTitle').innerText = "ğŸ“ è¨˜éŒ„æ–°æˆå“¡";
        document.getElementById('submitBtn').innerText = "ç¢ºèªå­˜æª”";
        document.getElementById('cancelBtn').style.display = "none";
    }

    function deleteItem(idx) { if(confirm('åˆªé™¤ï¼Ÿ')) { merchList.splice(idx,1); save(); renderAll(); } }
    function save() { localStorage.setItem('mm25_morandi_data', JSON.stringify(merchList)); }

    document.getElementById('merchForm').onsubmit = function(e) {
        e.preventDefault();
        const cur = document.getElementById('currency').value;
        const price = document.getElementById('inputPrice').value;
        const qty = document.getElementById('qty').value;
        const totalHkd = (price * rates[cur] * qty).toFixed(2);
        const editIdx = parseInt(document.getElementById('editIndex').value);
        const file = document.getElementById('imgFile').files[0];

        const doSave = (b64) => {
            const data = {
                role: document.getElementById('role').value,
                pattern: document.getElementById('pattern').value,
                name: document.getElementById('name').value,
                status: document.getElementById('status').value,
                qty: qty,
                originalPrice: price,
                originalCur: cur,
                totalHkd: totalHkd,
                buyDate: document.getElementById('buyDate').value,
                img: b64 || (editIdx !== -1 ? merchList[editIdx].img : null)
            };
            if(editIdx === -1) merchList.unshift(data);
            else merchList[editIdx] = data;
            save(); resetForm(); renderAll(); switchTab('page-gallery', document.querySelector(`[onclick*="page-gallery"]`));
        };

        if(file) { const r = new FileReader(); r.onload = () => doSave(r.result); r.readAsDataURL(file); }
        else doSave(null);
    };

    renderAll();
</script>
</body>
</html>
