<script>
    // ... 前面的 init, save, renderAll 等函式保持不變 ...

    document.getElementById('merchForm').onsubmit = function(e) {
        e.preventDefault();
        const editIdx = parseInt(document.getElementById('editIndex').value);
        if(document.activeElement) document.activeElement.blur();

        const getV = (sid, iid, dk, def) => {
            let sVal = document.getElementById(sid).value;
            if(sVal === 'NEW') { 
                let v = document.getElementById(iid).value.trim(); 
                if(v && !def.includes(v) && !dict[dk].includes(v)) { dict[dk].push(v); dict[dk].sort(); } 
                return v; 
            }
            return sVal;
        };

        const work = getV('workSelect', 'workInput', 'works', DEFAULT_WORKS);
        const role = getV('roleSelect', 'roleInput', 'roles', []);
        const type = getV('typeSelect', 'typeInput', 'types', DEFAULT_TYPES);

        // 收集表單數據
        const data = {
            work, role, type, 
            status: document.getElementById('status').value,
            pattern: document.getElementById('pattern').value, 
            note: document.getElementById('note').value, 
            qty: parseInt(document.getElementById('qty').value) || 1, 
            buyDate: document.getElementById('buyDate').value,
            originalPrice: parseFloat(document.getElementById('inputPrice').value) || 0, 
            originalCur: document.getElementById('currency').value, 
            totalHkd: liveExchange(), 
            timestamp: editIdx === -1 ? Date.now() : merchList[editIdx].timestamp
        };

        // 定義資料寫入與 UI 反饋的最終步驟
        const finalizeSave = (imageData) => {
            data.img = imageData || (editIdx !== -1 ? merchList[editIdx].img : '');
            
            if(editIdx === -1) {
                // 【新增模式】
                merchList.unshift(data);
                save(); 
                updateDictData(); 
                renderAll();
                // 清空表單
                ['pattern', 'note', 'imgFile', 'workInput', 'roleInput', 'typeInput'].forEach(id => document.getElementById(id).value = "");
                document.getElementById('inputPrice').value = "0";
                liveExchange();
                setTimeout(() => { showModal("✨", "已成功上架"); }, 100);
            } else {
                // 【更新模式】
                merchList[editIdx] = data;
                save(); 
                updateDictData(); 
                renderAll();
                
                // 1. 重置編輯狀態
                document.getElementById('merchForm').reset();
                document.getElementById('editIndex').value = "-1";
                document.getElementById('delBtn').style.display = 'none';
                
                // 2. 切換回對應的列表頁面
                const targetPage = data.status === '現貨' ? 'page-gallery' : (data.status === '非現貨' ? 'page-pending' : 'page-wish');
                const navIdx = data.status === '現貨' ? 0 : (data.status === '非現貨' ? 1 : 2);
                switchTab(targetPage, document.querySelectorAll('.nav-item')[navIdx]);
                
                // 3. 確保分頁穩定後彈窗
                setTimeout(() => { showModal("✅", "已更新儲存"); }, 600); 
            }
        };

        // 處理圖片上傳的非同步邏輯
        const fileInput = document.getElementById('imgFile');
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
                finalizeSave(event.target.result); // 讀取完畢後寫入
            };
            reader.onerror = () => {
                alert("圖片讀取失敗，請重試");
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            finalizeSave(null); // 無新圖片則直接進入下一步
        }
    };
</script>
