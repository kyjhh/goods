<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Archive - Master V47</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- åŸºç¤è®Šæ•¸èˆ‡å…¨å±€è¨­å®š --- */
        :root {
            --m-deep-green: #6b7a63; 
            --m-sage: #acc1ad; 
            --m-brown: #a68b7c;
            --m-sand: #d5cabd; 
            --m-clay: #e5ddd5; 
            --bg: #f2efeb;
            --text: #4a4a4a; 
            --radius: 14px;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'PingFang HK', 'Heiti TC', sans-serif; 
            background: var(--bg); color: var(--text);
            overflow-x: hidden;
        }

        /* --- æ‰¹é‡æ“ä½œé¢æ¿ (éš±è—æ–¼é ‚éƒ¨) --- */
        #batch-panel { 
            display: none; background: var(--m-deep-green); color: white; 
            padding: 15px 25px; position: fixed; top: 0; left: 0; width: 100%; 
            z-index: 3500; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); animation: slideDown 0.3s;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        .batch-btn-group { display: flex; gap: 10px; }
        .batch-btn { 
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); 
            color: white; padding: 6px 15px; border-radius: 6px; font-size: 12px; cursor: pointer; 
        }
        .batch-btn.danger { background: #cc9999; border: none; font-weight: bold; }

        /* --- å°é¢èˆ‡å°èˆª --- */
        #cover-page { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #d2cdc1; z-index: 3000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1); 
        }
        #cover-page.open { transform: translateY(-110%); }
        .cover-title { margin-bottom: 60px; text-align: center; }
        .cover-title h1 { letter-spacing: 12px; color: var(--m-deep-green); font-size: 28px; margin: 0; }
        .cover-title p { font-size: 10px; color: var(--m-brown); letter-spacing: 4px; margin-top: 10px; }
        .cover-menu { width: 220px; display: flex; flex-direction: column; gap: 12px; }
        .menu-btn { 
            background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); 
            padding: 18px; text-align: center; cursor: pointer; border-radius: var(--radius); 
            font-size: 12px; font-weight: bold; color: var(--m-deep-green); 
            border: 1px solid rgba(255,255,255,0.3); transition: var(--transition);
        }
        .menu-btn:active { transform: scale(0.95); background: white; }

        /* --- ä¸»æ§åˆ¶åˆ— (æ¢å¾©æœå°‹/éæ¿¾/æ’åº) --- */
        .top-sticky-controls {
            background: rgba(242, 239, 235, 0.9); backdrop-filter: blur(10px);
            padding: 15px 20px; position: sticky; top: 0; z-index: 800;
        }
        .search-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-input { 
            flex: 1; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--m-clay); 
            background: white; font-size: 14px; outline: none;
        }
        .icon-btn { 
            width: 45px; height: 45px; background: white; border: 1px solid var(--m-clay); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 18px; transition: var(--transition);
        }
        .icon-btn:active { background: var(--m-clay); }

        .filter-scroll-wrapper { 
            display: flex; overflow-x: auto; gap: 8px; padding-bottom: 8px; 
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .filter-scroll-wrapper::-webkit-scrollbar { display: none; }
        .filter-chip { 
            background: white; padding: 8px 18px; border-radius: 25px; border: 1px solid var(--m-clay);
            font-size: 12px; white-space: nowrap; color: #888; cursor: pointer; transition: var(--transition);
        }
        .filter-chip.active { background: var(--m-sage); color: white; border-color: var(--m-sage); }

        .display-meta { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 11px; color: var(--m-brown); font-weight: bold; margin-top: 5px;
        }
        .sort-select { border: none; background: none; font-weight: bold; color: var(--m-deep-green); outline: none; cursor: pointer; }

        /* --- åˆ—è¡¨æ¸²æŸ“ --- */
        .main-content { padding: 0 20px 120px 20px; max-width: 1000px; margin: 0 auto; display: none; }
        .list-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 16px; margin-top: 10px; 
        }
        .list-grid.view-list { grid-template-columns: 1fr; }

        .item-card { 
            background: white; border-radius: var(--radius); overflow: hidden; 
            border: 1px solid var(--m-clay); position: relative; transition: var(--transition);
            box-shadow: var(--shadow);
        }
        .item-card.selected { border: 4px solid var(--m-deep-green); transform: scale(0.95); }
        
        .img-container { width: 100%; aspect-ratio: 1; background: #f9f9f9; overflow: hidden; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        
        .item-info { padding: 12px; }
        .item-info .tag { font-size: 9px; color: var(--m-sage); font-weight: 900; letter-spacing: 1px; }
        .item-info .title { 
            font-size: 14px; font-weight: bold; margin: 4px 0; color: #333; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .item-info .price { font-size: 12px; color: var(--m-deep-green); font-weight: bold; }

        /* æ¸…å–®æ¨¡å¼æ¨£å¼ */
        .view-list .item-card { display: flex; height: 100px; }
        .view-list .img-container { width: 100px; height: 100px; aspect-ratio: auto; }
        .view-list .item-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }

        /* --- è¡¨å–®é é¢ --- */
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-container { background: white; padding: 25px; border-radius: var(--radius); border: 1px solid var(--m-clay); }
        .input-box { margin-bottom: 18px; }
        .input-box label { display: block; font-size: 11px; font-weight: bold; color: var(--m-brown); margin-bottom: 8px; letter-spacing: 1px; }
        input, select, textarea { 
            width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--m-clay); 
            background: #fafafa; font-size: 15px; outline: none; transition: var(--transition);
        }
        input:focus { border-color: var(--m-sage); background: white; }
        .submit-btn { 
            width: 100%; padding: 18px; border: none; border-radius: 10px; 
            font-weight: bold; font-size: 15px; cursor: pointer; transition: var(--transition);
        }
        .btn-green { background: var(--m-deep-green); color: white; }
        .btn-brown { background: var(--m-brown); color: white; }
        .btn-outline { background: none; border: 1px solid var(--m-clay); color: #999; margin-top: 10px; }

        /* --- æ•¸æ“šçµ±è¨ˆå°ˆå€ --- */
        .stats-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .summary-card { 
            background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--m-clay); 
            text-align: center; box-shadow: var(--shadow);
        }
        .summary-card span { display: block; font-size: 10px; color: #aaa; margin-bottom: 5px; font-weight: bold; }
        .summary-card b { font-size: 20px; color: var(--m-deep-green); }

        .chart-box { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--m-clay); margin-bottom: 25px; }

        /* --- åº•éƒ¨å°è¦½ --- */
        .nav-bar { 
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 500px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); 
            display: flex; justify-content: space-around; padding: 12px 5px; 
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 1000; 
            display: none; border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-btn { 
            background: none; border: none; color: #bbb; font-size: 10px; font-weight: bold; 
            cursor: pointer; flex: 1; transition: var(--transition);
        }
        .nav-btn.active { color: var(--m-deep-green); transform: translateY(-2px); }

        /* --- å½ˆçª—æç¤º --- */
        #modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); 
            z-index: 9998; display: none; 
        }
        #alert-modal { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; width: 280px; padding: 40px 20px; border-radius: 25px; 
            text-align: center; z-index: 9999; display: none; box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
        }
        .modal-icon { font-size: 50px; margin-bottom: 20px; }
        .modal-msg { font-weight: bold; font-size: 18px; color: var(--m-deep-green); }

        /* --- è¨­å®šé é¢å°éƒ¨ä»¶ --- */
        .dict-manager { max-height: 200px; overflow-y: auto; border: 1px solid var(--m-clay); border-radius: 8px; padding: 10px; background: #fafafa; }
        .dict-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 12px; }
        .dict-del { color: #cc9999; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="batch-panel">
        <div id="batch-status" style="font-weight: bold; font-size: 14px; letter-spacing: 1px;">é¸æ“‡é …ç›® (0)</div>
        <div class="batch-btn-group">
            <button class="batch-btn" onclick="selectAllIndices()">å…¨é¸</button>
            <button class="batch-btn" onclick="setBatchMode(false)">å–æ¶ˆ</button>
            <button class="batch-btn danger" onclick="batchDeleteAction()">æ‰¹é‡åˆªé™¤</button>
        </div>
    </div>

    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="alert-modal">
        <div class="modal-icon" id="m-icon">âœ¨</div>
        <div class="modal-msg" id="m-text">æˆåŠŸ</div>
        <button class="submit-btn btn-green" onclick="closeModal()" style="margin-top:30px; padding:12px;">ç¢ºå®š</button>
    </div>

    <div id="cover-page">
        <div class="cover-title">
            <h1>M.ARCHIVE</h1>
            <p>MASTER COLLECTION V47</p>
        </div>
        <div class="cover-menu">
            <div class="menu-btn" onclick="enterApp('ç¾è²¨')">é€²å…¥é¤¨è— (ç¾è²¨)</div>
            <div class="menu-btn" onclick="enterApp('éç¾è²¨')">ç‰©æµç­‰å€™ (éç¾è²¨)</div>
            <div class="menu-btn" onclick="enterApp('é¡˜æœ›')">é¡˜æœ›æ¸…å–® (é è³¼)</div>
            <div class="menu-btn" onclick="openNavPage('page-stats')">æ•¸æ“šä¸­å¿ƒ</div>
            <div class="menu-btn" onclick="openNavPage('page-add')">è—å“ä¸Šæ¶</div>
        </div>
        <div style="position:absolute; bottom:40px; font-size:9px; color:var(--m-brown); letter-spacing:2px; opacity:0.6;">POWERED BY MORANDI SYSTEM</div>
    </div>

    <div class="main-content" id="app-body">
        
        <div id="back-nav" style="padding: 15px 0 5px 0;">
            <span onclick="exitApp()" style="font-size:12px; font-weight:bold; color:var(--m-brown); cursor:pointer;">â† è¿”å›ä¸»é¸å–®</span>
        </div>

        <div id="list-controls" class="top-sticky-controls">
            <div class="search-bar">
                <input type="text" id="main-search" class="search-input" placeholder="æœå°‹æ¬¾å¼ã€è§’è‰²ã€ä½œå“..." oninput="refreshUI()">
                <div class="icon-btn" onclick="toggleLayout()">ğŸ–¼ï¸</div>
                <div class="icon-btn" onclick="setBatchMode(true)">âœï¸</div>
            </div>
            <div id="dynamic-filters" class="filter-scroll-wrapper"></div>
            <div class="display-meta">
                <div id="total-count-display">é …ç›®æ•¸é‡: 0</div>
                <div>
                    æ’åº: 
                    <select id="main-sort" class="sort-select" onchange="refreshUI()">
                        <option value="ts_desc">æœ€æ–°åŠ å…¥</option>
                        <option value="ts_asc">æœ€æ—©åŠ å…¥</option>
                        <option value="price_desc">åƒ¹æ ¼: é«˜åˆ°ä½</option>
                        <option value="price_asc">åƒ¹æ ¼: ä½åˆ°é«˜</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="page-list" class="page active">
            <div id="main-grid" class="list-grid"></div>
        </div>

        <div id="page-add" class="page">
            <h3 style="color:var(--m-deep-green); letter-spacing:3px; margin-bottom:20px;">NEW ARRIVAL</h3>
            <div class="form-container">
                <form id="addForm">
                    <div class="input-box">
                        <label>ä½œå“åç¨± (Work)</label>
                        <select id="add-work" onchange="checkNewInput('add-work', 'add-work-new')"></select>
                        <input type="text" id="add-work-new" style="display:none; margin-top:10px;" placeholder="æ‰‹å‹•è¼¸å…¥æ–°ä½œå“">
                    </div>
                    <div class="input-box">
                        <label>è§’è‰²åç¨± (Role)</label>
                        <select id="add-role" onchange="checkNewInput('add-role', 'add-role-new')"></select>
                        <input type="text" id="add-role-new" style="display:none; margin-top:10px;" placeholder="æ‰‹å‹•è¼¸å…¥æ–°è§’è‰²">
                    </div>
                    <div class="input-box">
                        <label>æ¬¾å¼æè¿° (Pattern)</label>
                        <input type="text" id="add-pattern" required placeholder="ä¾‹å¦‚ï¼š2026é€±å¹´ç´€å¿µç«‹ç‰Œ">
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-box">
                            <label>ç•¶å‰ç‹€æ…‹</label>
                            <select id="add-status">
                                <option value="ç¾è²¨">ç¾è²¨</option>
                                <option value="éç¾è²¨">éç¾è²¨ (ç‰©æµä¸­)</option>
                                <option value="é¡˜æœ›">é¡˜æœ›æ¸…å–®</option>
                            </select>
                        </div>
                        <div class="input-box">
                            <label>æŒæœ‰æ•¸é‡</label>
                            <input type="number" id="add-qty" value="1" min="1">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px;">
                        <div class="input-box">
                            <label>è³¼å…¥å¹£ç¨®</label>
                            <select id="add-cur">
                                <option value="HKD">HKD</option>
                                <option value="RMB">RMB</option>
                                <option value="JPY">JPY</option>
                            </select>
                        </div>
                        <div class="input-box">
                            <label>è³¼å…¥åƒ¹æ ¼</label>
                            <input type="number" id="add-price" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="input-box">
                        <label>ä¸Šå‚³å¯¦ç‰©åœ–</label>
                        <input type="file" id="add-img" accept="image/*">
                    </div>
                    <button type="submit" class="submit-btn btn-green">ç¢ºèªæ–°å¢å­˜æª”</button>
                </form>
            </div>
        </div>

        <div id="page-edit" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:var(--m-brown); letter-spacing:3px; margin:0;">EDIT ITEM</h3>
                <span onclick="cancelEdit()" style="color:var(--m-brown); font-weight:bold; cursor:pointer;">å–æ¶ˆ Ã—</span>
            </div>
            <div class="form-container">
                <form id="editForm">
                    <input type="hidden" id="edit-index">
                    <div class="input-box">
                        <label>ä½œå“åç¨±</label>
                        <select id="edit-work" onchange="checkNewInput('edit-work', 'edit-work-new')"></select>
                        <input type="text" id="edit-work-new" style="display:none; margin-top:10px;">
                    </div>
                    <div class="input-box">
                        <label>è§’è‰²åç¨±</label>
                        <select id="edit-role" onchange="checkNewInput('edit-role', 'edit-role-new')"></select>
                        <input type="text" id="edit-role-new" style="display:none; margin-top:10px;">
                    </div>
                    <div class="input-box">
                        <label>æ¬¾å¼æè¿°</label>
                        <input type="text" id="edit-pattern" required>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-box">
                            <label>ç‹€æ…‹è®Šæ›´</label>
                            <select id="edit-status">
                                <option value="ç¾è²¨">ç¾è²¨</option>
                                <option value="éç¾è²¨">éç¾è²¨</option>
                                <option value="é¡˜æœ›">é¡˜æœ›</option>
                            </select>
                        </div>
                        <div class="input-box">
                            <label>æ•¸é‡</label>
                            <input type="number" id="edit-qty">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px;">
                        <div class="input-box">
                            <label>å¹£ç¨®</label>
                            <select id="edit-cur">
                                <option value="HKD">HKD</option>
                                <option value="RMB">RMB</option>
                                <option value="JPY">JPY</option>
                            </select>
                        </div>
                        <div class="input-box">
                            <label>å–®åƒ¹</label>
                            <input type="number" id="edit-price" step="0.01">
                        </div>
                    </div>
                    <div class="input-box">
                        <label>æ›´æ–°åœ–ç‰‡ (è‹¥ä¸æ›´æ”¹è«‹ç•™ç©º)</label>
                        <input type="file" id="edit-img" accept="image/*">
                    </div>
                    <button type="submit" class="submit-btn btn-brown">å„²å­˜ä¿®æ”¹å…§å®¹</button>
                    <button type="button" class="submit-btn btn-outline" style="color:#cc9999; border-color:#cc9999;" onclick="deleteSingleItem()">å¾é¤¨è—åˆªé™¤</button>
                    <button type="button" class="submit-btn btn-outline" onclick="cancelEdit()">å–æ¶ˆè¿”å›</button>
                </form>
            </div>
        </div>

        <div id="page-stats" class="page">
            <h3 style="color:var(--m-deep-green); letter-spacing:3px;">DATA CENTER</h3>
            <div class="stats-summary">
                <div class="summary-card"><span id="stat-title-qty">ç¸½è—å“æ•¸</span><b id="total-qty-val">0</b></div>
                <div class="summary-card"><span>ç¸½æŠ•è³‡ (HKD)</span><b id="total-cost-val">0</b></div>
            </div>
            <div class="chart-box">
                <p style="font-size:12px; font-weight:bold; color:var(--m-brown); margin-bottom:15px;">ä½œå“æ”¯å‡ºä½”æ¯” (Pie Chart)</p>
                <canvas id="mainChart"></canvas>
            </div>
            <div class="form-container">
                <p style="font-size:12px; font-weight:bold; color:var(--m-brown); margin-bottom:10px;">æ•¸æ“šè©³æƒ…æ¸…å–®</p>
                <div id="stats-table" style="font-size:11px;"></div>
            </div>
        </div>

        <div id="page-settings" class="page">
            <h3 style="color:var(--m-deep-green); letter-spacing:3px;">SYSTEM SETTINGS</h3>
            <div class="form-container">
                <div class="input-box">
                    <label>æ•¸æ“šå‚™ä»½èˆ‡é·ç§»</label>
                    <button class="submit-btn btn-brown" style="margin-bottom:12px;" onclick="exportBackup()">åŒ¯å‡ºæ•¸æ“š (JSON)</button>
                    <button class="submit-btn btn-green" onclick="document.getElementById('import-input').click()">é‚„åŸæ•¸æ“š (JSON)</button>
                    <input type="file" id="import-input" style="display:none" onchange="importBackup(this)">
                </div>
                <hr style="border:0.5px solid var(--m-clay); margin:25px 0;">
                <div class="input-box">
                    <label>ä½œå“å­—å…¸ç®¡ç† (é»æ“Šåˆªé™¤)</label>
                    <div id="dict-works-manager" class="dict-manager"></div>
                </div>
                <div class="input-box">
                    <label>è§’è‰²å­—å…¸ç®¡ç† (é»æ“Šåˆªé™¤)</label>
                    <div id="dict-roles-manager" class="dict-manager"></div>
                </div>
                <p style="text-align:center; font-size:10px; color:#ccc; margin-top:30px;">DATABASE: archive_master | VERSION: V47_FULL</p>
            </div>
        </div>

    </div>

    <nav class="nav-bar" id="bottom-nav">
        <button class="nav-btn" id="nav-ready" onclick="enterApp('ç¾è²¨')">é¤¨è—</button>
        <button class="nav-btn" id="nav-wait" onclick="enterApp('éç¾è²¨')">ç­‰å€™</button>
        <button class="nav-btn" id="nav-wish" onclick="enterApp('é¡˜æœ›')">é¡˜æœ›</button>
        <button class="nav-btn" id="nav-add" onclick="openNavPage('page-add')">ä¸Šæ¶</button>
        <button class="nav-btn" id="nav-stats" onclick="openNavPage('page-stats')">æ•¸æ“š</button>
        <button class="nav-btn" id="nav-settings" onclick="openNavPage('page-settings')">è¨­å®š</button>
    </nav>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const DB_NAME = 'archive_master';
    const DICT_NAME = 'archive_dict_master';
    const RATES = { HKD: 1.0, RMB: 1.08, JPY: 0.052 };

    let merchList = [];
    let dict = { works: [], roles: [] };
    let currentStatus = 'ç¾è²¨';
    let filterWork = 'all';
    let isListMode = false;
    let isBatch = false;
    let selectedIndices = [];

    // --- åˆå§‹åŒ– ---
    function init() {
        const localData = localStorage.getItem(DB_NAME);
        merchList = localData ? JSON.parse(localData) : [];
        
        const localDict = localStorage.getItem(DICT_NAME);
        dict = localDict ? JSON.parse(localDict) : { works: [], roles: [] };

        updateSelectOptions();
        updateFilterChips();
        refreshUI();
    }

    function saveToLocal() {
        localStorage.setItem(DB_NAME, JSON.stringify(merchList));
        localStorage.setItem(DICT_NAME, JSON.stringify(dict));
    }

    // --- å°èˆªæ§åˆ¶ ---
    function enterApp(status) {
        currentStatus = status;
        document.getElementById('cover-page').classList.add('open');
        document.getElementById('app-body').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'flex';
        
        // åˆ‡æ› active class
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(status === 'ç¾è²¨') document.getElementById('nav-ready').classList.add('active');
        if(status === 'éç¾è²¨') document.getElementById('nav-wait').classList.add('active');
        if(status === 'é¡˜æœ›') document.getElementById('nav-wish').classList.add('active');

        openNavPage('page-list');
        refreshUI();
    }

    function exitApp() {
        document.getElementById('cover-page').classList.remove('open');
        setTimeout(() => {
            document.getElementById('app-body').style.display = 'none';
            document.getElementById('bottom-nav').style.display = 'none';
        }, 800);
    }

    function openNavPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // æ§åˆ¶é ‚éƒ¨æœç´¢æ¬„é¡¯ç¤º
        document.getElementById('list-controls').style.display = (pageId === 'page-list') ? 'block' : 'none';
        
        // æ›´æ–°å°èˆªéˆ•
        document.querySelectorAll('.nav-btn').forEach(b => {
            if(b.onclick.toString().includes(pageId)) b.classList.add('active');
            else b.classList.remove('active');
        });

        if(pageId === 'page-stats') renderStats();
        if(pageId === 'page-settings') renderDictManager();
        if(isBatch) setBatchMode(false);
    }

    function toggleLayout() {
        isListMode = !isListMode;
        document.getElementById('main-grid').className = isListMode ? 'list-grid view-list' : 'list-grid';
    }

    // --- æ¸²æŸ“å¼•æ“ ---
    function refreshUI() {
        const grid = document.getElementById('main-grid');
        const searchVal = document.getElementById('main-search').value.toLowerCase();
        const sortVal = document.getElementById('main-sort').value;

        // éæ¿¾
        let filtered = merchList.map((item, index) => ({...item, originalIdx: index}))
            .filter(i => i.status === currentStatus)
            .filter(i => filterWork === 'all' || i.work === filterWork)
            .filter(i => (
                i.pattern.toLowerCase().includes(searchVal) || 
                i.role.toLowerCase().includes(searchVal) || 
                i.work.toLowerCase().includes(searchVal)
            ));

        // æ’åº
        if(sortVal === 'ts_desc') filtered.sort((a,b) => b.timestamp - a.timestamp);
        if(sortVal === 'ts_asc') filtered.sort((a,b) => a.timestamp - b.timestamp);
        if(sortVal === 'price_desc') filtered.sort((a,b) => b.totalHkd - a.totalHkd);
        if(sortVal === 'price_asc') filtered.sort((a,b) => a.totalHkd - b.totalHkd);

        grid.innerHTML = '';
        if(filtered.length === 0) {
            grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; padding:50px; color:#bbb; font-size:12px;">ç„¡ç›¸ç¬¦è—å“</div>`;
        }

        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = `item-card ${isBatch && selectedIndices.includes(item.originalIdx) ? 'selected' : ''}`;
            card.innerHTML = `
                <div class="img-container"><img src="${item.img || ''}" loading="lazy"></div>
                <div class="item-info">
                    <span class="tag">${item.role} / ${item.work}</span>
                    <div class="title">${item.pattern}</div>
                    <div class="price">HKD ${item.totalHkd} (x${item.qty})</div>
                </div>
            `;
            
            card.onclick = () => {
                if(isBatch) toggleSelect(item.originalIdx);
                else startEdit(item.originalIdx);
            };

            // é•·æŒ‰æ‰‹å‹¢æ”¯æ´
            let longPressTimer;
            card.ontouchstart = () => longPressTimer = setTimeout(() => { if(!isBatch) { setBatchMode(true); toggleSelect(item.originalIdx); } }, 800);
            card.ontouchend = () => clearTimeout(longPressTimer);
            card.onmousedown = () => longPressTimer = setTimeout(() => { if(!isBatch) { setBatchMode(true); toggleSelect(item.originalIdx); } }, 800);
            card.onmouseup = () => clearTimeout(longPressTimer);

            grid.appendChild(card);
        });

        document.getElementById('total-count-display').innerText = `é …ç›®æ•¸é‡: ${filtered.length}`;
    }

    // --- ğŸŒŸã€æ–°å¢é‚è¼¯ã€‘ ---
    document.getElementById('addForm').onsubmit = function(e) {
        e.preventDefault();
        saveProcess('add');
    };

    // --- ğŸŒŸã€ç·¨è¼¯é‚è¼¯ã€‘ ---
    document.getElementById('editForm').onsubmit = function(e) {
        e.preventDefault();
        saveProcess('edit');
    };

    async function saveProcess(mode) {
        const prefix = mode === 'add' ? 'add' : 'edit';
        const editIdx = parseInt(document.getElementById('edit-index').value);

        const getVal = (selectId, newId, dictKey) => {
            let v = document.getElementById(selectId).value;
            if(v === 'NEW') {
                v = document.getElementById(newId).value.trim();
                if(v && !dict[dictKey].includes(v)) {
                    dict[dictKey].push(v);
                    dict[dictKey].sort();
                }
            }
            return v;
        };

        const price = parseFloat(document.getElementById(`${prefix}-price`).value) || 0;
        const qty = parseInt(document.getElementById(`${prefix}-qty`).value) || 1;
        const cur = document.getElementById(`${prefix}-cur`).value;

        const data = {
            work: getVal(`${prefix}-work`, `${prefix}-work-new`, 'works'),
            role: getVal(`${prefix}-role`, `${prefix}-role-new`, 'roles'),
            pattern: document.getElementById(`${prefix}-pattern`).value,
            status: document.getElementById(`${prefix}-status`).value,
            qty: qty,
            originalPrice: price,
            originalCur: cur,
            totalHkd: (price * qty * RATES[cur]).toFixed(2),
            timestamp: mode === 'add' ? Date.now() : merchList[editIdx].timestamp
        };

        const fileInput = document.getElementById(`${prefix}-img`);
        
        // ğŸŒŸ åœ–ç‰‡è®€å– Bug ä¿®å¾©æ ¸å¿ƒ
        const executeSave = (imgData) => {
            if(mode === 'add') {
                data.img = imgData || '';
                merchList.unshift(data);
                document.getElementById('addForm').reset();
                showModal("âœ¨", "è—å“ä¸Šæ¶æˆåŠŸ");
            } else {
                // å¦‚æœç·¨è¼¯æ™‚æ²’é¸åœ–ï¼Œdata.img ç²å–åŸæœ‰çš„åœ–ç‰‡åœ°å€
                data.img = imgData || merchList[editIdx].img;
                merchList[editIdx] = data;
                showModal("âœ…", "è³‡æ–™æ›´æ–°æˆåŠŸ");
                setTimeout(() => openNavPage('page-list'), 500);
            }
            saveToLocal();
            updateSelectOptions();
            updateFilterChips();
            refreshUI();
        };

        if(fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (ev) => executeSave(ev.target.result);
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            executeSave(null);
        }
    }

    // --- ç·¨è¼¯åŠŸèƒ½è¼”åŠ© ---
    function startEdit(idx) {
        const item = merchList[idx];
        document.getElementById('edit-index').value = idx;
        
        // å¡«å……è¡¨å–®
        updateSelectOptions();
        document.getElementById('edit-work').value = item.work;
        document.getElementById('edit-role').value = item.role;
        document.getElementById('edit-pattern').value = item.pattern;
        document.getElementById('edit-status').value = item.status;
        document.getElementById('edit-qty').value = item.qty;
        document.getElementById('edit-price').value = item.originalPrice;
        document.getElementById('edit-cur').value = item.originalCur;
        
        // é‡è¨­æ–°è¼¸å…¥æ¡†
        document.getElementById('edit-work-new').style.display = 'none';
        document.getElementById('edit-role-new').style.display = 'none';
        
        openNavPage('page-edit');
    }

    function cancelEdit() {
        openNavPage('page-list');
    }

    function deleteSingleItem() {
        if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤è—å“å—ï¼Ÿ")) {
            const idx = document.getElementById('edit-index').value;
            merchList.splice(idx, 1);
            saveToLocal();
            openNavPage('page-list');
            refreshUI();
            showModal("ğŸ—‘ï¸", "å·²åˆªé™¤");
        }
    }

    // --- æ‰¹é‡ç®¡ç†é‚è¼¯ ---
    function setBatchMode(on) {
        isBatch = on;
        selectedIndices = [];
        document.getElementById('batch-panel').style.display = on ? 'flex' : 'none';
        refreshUI();
    }

    function toggleSelect(idx) {
        const i = selectedIndices.indexOf(idx);
        if(i > -1) selectedIndices.splice(i, 1);
        else selectedIndices.push(idx);
        document.getElementById('batch-status').innerText = `é¸æ“‡é …ç›® (${selectedIndices.length})`;
        refreshUI();
    }

    function selectAllIndices() {
        const searchVal = document.getElementById('main-search').value.toLowerCase();
        let filtered = merchList.map((item, index) => ({...item, originalIdx: index}))
            .filter(i => i.status === currentStatus && (filterWork === 'all' || i.work === filterWork))
            .filter(i => i.pattern.toLowerCase().includes(searchVal) || i.role.toLowerCase().includes(searchVal));
        
        selectedIndices = filtered.map(f => f.originalIdx);
        document.getElementById('batch-status').innerText = `é¸æ“‡é …ç›® (${selectedIndices.length})`;
        refreshUI();
    }

    function batchDeleteAction() {
        if(selectedIndices.length === 0) return;
        if(confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedIndices.length} é …å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚`)) {
            merchList = merchList.filter((_, idx) => !selectedIndices.includes(idx));
            saveToLocal();
            setBatchMode(false);
            refreshUI();
            showModal("ğŸ—‘ï¸", "æ‰¹é‡åˆªé™¤å®Œæˆ");
        }
    }

    // --- UI å·¥å…· ---
    function checkNewInput(sid, iid) {
        document.getElementById(iid).style.display = (document.getElementById(sid).value === 'NEW') ? 'block' : 'none';
    }

    function updateSelectOptions() {
        const fill = (targetId, list) => {
            const el = document.getElementById(targetId);
            el.innerHTML = '<option value="">è«‹é¸æ“‡...</option>' + 
                list.map(v => `<option value="${v}">${v}</option>`).join('') +
                '<option value="NEW">+ æ–°å¢æ¨™ç±¤...</option>';
        };
        fill('add-work', dict.works); fill('edit-work', dict.works);
        fill('add-role', dict.roles); fill('edit-role', dict.roles);
    }

    function updateFilterChips() {
        const box = document.getElementById('dynamic-filters');
        box.innerHTML = `<div class="filter-chip ${filterWork === 'all' ? 'active' : ''}" onclick="setWorkFilter('all')">å…¨éƒ¨</div>`;
        dict.works.forEach(w => {
            box.innerHTML += `<div class="filter-chip ${filterWork === w ? 'active' : ''}" onclick="setWorkFilter('${w}')">${w}</div>`;
        });
    }

    function setWorkFilter(w) {
        filterWork = w;
        updateFilterChips();
        refreshUI();
    }

    function showModal(icon, text) {
        document.getElementById('m-icon').innerText = icon;
        document.getElementById('m-text').innerText = text;
        document.getElementById('modal-overlay').style.display = 'block';
        document.getElementById('alert-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('alert-modal').style.display = 'none';
    }

    // --- æ•¸æ“šçµ±è¨ˆ Chart.js ---
    function renderStats() {
        const totalQty = merchList.reduce((acc, cur) => acc + (parseInt(cur.qty) || 0), 0);
        const totalCost = merchList.reduce((acc, cur) => acc + parseFloat(cur.totalHkd), 0);
        
        document.getElementById('total-qty-val').innerText = totalQty;
        document.getElementById('total-cost-val').innerText = totalCost.toLocaleString(undefined, {minimumFractionDigits: 2});

        const ctx = document.getElementById('mainChart').getContext('2d');
        const workGroups = {};
        merchList.forEach(i => workGroups[i.work] = (workGroups[i.work] || 0) + parseFloat(i.totalHkd));

        if(window.myPie) window.myPie.destroy();
        window.myPie = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(workGroups),
                datasets: [{
                    data: Object.values(workGroups),
                    backgroundColor: ['#6b7a63', '#acc1ad', '#a68b7c', '#d5cabd', '#e5ddd5', '#c2b2a9', '#8e9e82']
                }]
            },
            options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
        });

        // æ¸²æŸ“æ¸…å–®è¡¨æ ¼
        let html = '<table style="width:100%; border-collapse:collapse;">';
        html += '<tr style="border-bottom:1px solid #eee; color:#aaa;"><td>ä½œå“</td><td align="right">é‡‘é¡</td></tr>';
        Object.entries(workGroups).sort((a,b)=>b[1]-a[1]).forEach(([w, p]) => {
            html += `<tr style="border-bottom:1px solid #f9f9f9;"><td style="padding:8px 0;">${w}</td><td align="right">HKD ${p.toFixed(1)}</td></tr>`;
        });
        html += '</table>';
        document.getElementById('stats-table').innerHTML = html;
    }

    // --- å­—å…¸ç®¡ç†å™¨ ---
    function renderDictManager() {
        const render = (containerId, key) => {
            const container = document.getElementById(containerId);
            container.innerHTML = dict[key].map((item, idx) => `
                <div class="dict-item">
                    <span>${item}</span>
                    <span class="dict-del" onclick="deleteDictItem('${key}', ${idx})">åˆªé™¤</span>
                </div>
            `).join('');
        };
        render('dict-works-manager', 'works');
        render('dict-roles-manager', 'roles');
    }

    function deleteDictItem(key, idx) {
        if(confirm(`åˆªé™¤æ¨™ç±¤ã€Œ${dict[key][idx]}ã€ï¼Ÿé€™ä¸æœƒåˆªé™¤å·²å­˜åœ¨çš„è—å“ï¼Œä½†è©²æ¨™ç±¤å°‡å¾ä¸‹æ‹‰é¸å–®ç§»é™¤ã€‚`)) {
            dict[key].splice(idx, 1);
            saveToLocal();
            renderDictManager();
            updateSelectOptions();
        }
    }

    // --- å‚™ä»½ ---
    function exportBackup() {
        const data = { merchList, dict };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `Archive_V47_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function importBackup(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if(data.merchList && data.dict) {
                    merchList = data.merchList;
                    dict = data.dict;
                    saveToLocal(); init();
                    showModal("âœ…", "æ•¸æ“šé‚„åŸæˆåŠŸ");
                }
            } catch(e) { alert("ç„¡æ•ˆçš„ JSON æª”æ¡ˆ"); }
        };
        reader.readAsText(input.files[0]);
    }

    window.onload = init;
</script>
</body>
    </html>
