<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Morandi Archive - IndexedDB 版</title>
<!-- Cropper.js 樣式與腳本 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart.js 數據標籤插件 -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* 樣式與先前版本完全相同，為節省篇幅請直接使用之前的完整樣式 */
:root {
    --m-deep-green: #6b7a63; --m-sage: #acc1ad; --m-brown: #a68b7c;
    --m-sand: #d5cabd; --m-clay: #e5ddd5; --bg: #f2efeb;
    --text: #4a4a4a; --radius: 8px; --dynamic-grid: 160px;
    --info-scale: 1;
}
body.theme-1 { --m-deep-green: #9DC8C8; --m-sage: #58C9B9; --m-brown: #519D9E; --m-sand: #D1B6E1; --m-clay: #519D9E; --bg: #f2efeb; --text: #4a4a4a; }
body.theme-2 { --m-deep-green: #fe4365; --m-sage: #fc9d9a; --m-brown: #f9cdad; --m-sand: #c8c8a9; --m-clay: #fc9d9a; --bg: #faf0e6; --text: #4a3b2a; }
body.theme-3 { --m-deep-green: #D499B9; --m-sage: #9055A2; --m-brown: #2E294E; --m-sand: #011638; --m-clay: #2E294E; --bg: #f5f9ff; --text: #2c3e50; }
body.theme-3 .grid-range-slider { background: var(--m-deep-green); }
body.theme-4 { --m-deep-green: #67D5B5; --m-sage: #EE7785; --m-brown: #C89EC4; --m-sand: #84B1ED; --m-clay: #C89EC4; --bg: #fff7f2; --text: #5e4b46; }
body.theme-5 { --m-deep-green: #a3c9c7; --m-sage: #cb7575; --m-brown: #ef9e9f; --m-sand: #353848; --m-clay: #cb7575; --bg: #ecf7f0; --text: #1f3a2b; }
body.theme-5 .grid-range-slider { background: var(--m-brown); filter: brightness(1.3); }
body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
#batch-panel { display: none; background: var(--m-deep-green); color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 2500; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: 0.3s; }
.batch-btn { background: #cc9999; border: none; color: white; padding: 6px 15px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: bold; }
.edit-toggle-btn { font-size: 13px; color: var(--m-deep-green); border: 1px solid var(--m-deep-green); padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-left: 10px; font-weight: bold; transition: 0.2s; }
#cover-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
#cover-page.open { transform: translateY(-100%); }
.cover-upload-btn { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2100; border: 1px solid rgba(255,255,255,0.3); }
.cover-menu { width: 160px; display: flex; flex-direction: column; gap: 8px; }
.menu-btn { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(12px); padding: 14px; text-align: center; cursor: pointer; border-radius: var(--radius); font-size: 11px; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.2); }
.nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 5px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); z-index: 1000; transition: bottom 0.3s; }
.nav-item { border: none; background: none; color: #b5b5b5; font-size: 10px; font-weight: 600; cursor: pointer; padding: 10px; flex-grow: 1; text-align: center; }
.nav-item.active { color: var(--m-deep-green); }
.main-content { padding: 12px 12px 120px 12px; max-width: 800px; margin: 0 auto; transition: margin-top 0.3s; }
.page { display: none; }
.page.active { display: block; }
.page-header { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; position: relative; }
.back-btn-header { font-size: 20px; cursor: pointer; color: var(--m-brown); width: 40px; position: absolute; left: 0; }
.page-title { font-size: 18px; font-weight: bold; color: var(--m-deep-green); text-align: center; margin: 0 auto; }
.control-panel { background: #fff; padding: 15px; border-radius: var(--radius); margin-bottom: 10px; border: 1px solid var(--m-clay); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
.symbol-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; }
.symbol-group { display: flex; gap: 12px; color: #ccc; align-items: center; }
.symbol-btn { cursor: pointer; transition: color 0.3s; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 2px; }
.symbol-btn svg { width: 18px; height: 18px; fill: currentColor; }
.symbol-btn span { font-size: 8px; font-weight: bold; display: block; }
.symbol-btn.active { color: var(--m-deep-green); }
.sort-qty span { font-size: 8px; font-weight: bold; }
.sort-qty svg { display: none; }
.order-toggle { font-size: 11px; font-weight: bold; padding: 4px 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; color: var(--m-brown); background: #fafafa; }
.search-input { margin-bottom: 12px; padding: 10px 12px; font-size: 12px; border: 1px solid #eee; background: #fafafa; border-radius: 6px; width: 100%; box-sizing: border-box; outline: none; }
.filter-row { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; margin-bottom: 10px; scrollbar-width: none; }
.filter-chip { background: var(--m-clay); padding: 6px 14px; border-radius: 15px; font-size: 11px; cursor: pointer; color: #5D3A1A; user-select: none; transition: 0.2s; }
.filter-chip.active { background: var(--m-sage); color: white; box-shadow: 0 0 0 2px var(--m-deep-green); }
.count-tag { font-size: 10px; color: #aaa; text-align: right; margin-bottom: 5px; }
.count-tag .number { font-size: 14px; font-weight: bold; color: #aaa; }
.list-container.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr)); gap: 4px; }
.list-container.list { display: flex; flex-direction: column; gap: 4px; }
.list-container.list .item-card { min-height: 95px; height: auto; flex-direction: row; }
.list-container.list .img-box { width: calc(var(--dynamic-grid) * 0.6); height: auto; aspect-ratio: 1; flex-shrink: 0; }
.list-container.list .info { padding: 10px; overflow: hidden; }
.list-container.list .note { display: block; font-size: calc(9px * var(--info-scale)); color: #999; margin-top: calc(4px * var(--info-scale)); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-container.image { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr)); gap: 4px; }
.list-container.image .item-card .info { display: none; }
.item-card { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--m-clay); user-select: none; display: flex; flex-direction: column; cursor: pointer; position: relative; transition: 0.2s; }
.item-card.selected { border: 3px solid var(--m-deep-green); transform: scale(0.96); }
.item-card.selected::after { content: "✓"; position: absolute; top: 10px; right: 10px; background: var(--m-deep-green); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 10; }
.img-box { width: 100%; aspect-ratio: 1; background: #f5f5f5; pointer-events: none; }
.img-box img { width: 100%; height: 100%; object-fit: cover; }
.card-qty { position: absolute; bottom: 8px; right: 10px; font-size: calc(12px * var(--info-scale,1)); color: var(--m-deep-green); font-weight: bold; z-index: 2; }
.info { padding: 10px; flex-grow: 1; overflow: hidden; pointer-events: none; display: flex; flex-direction: column; }
.info .note { display: none; }
.input-group { margin-bottom: 5px; }
.input-label { font-size: 11px; color: var(--m-brown); font-weight: bold; margin-bottom: 5px; display: block; }
#exchangePreview { margin-bottom: 8px; }
.btn-main { background: var(--m-deep-green); color: white; border: none; padding: 12px; width: 100%; font-size: 13px; cursor: pointer; border-radius: var(--radius); margin-top: 5px; font-weight: bold; }
input, select, textarea { width: 100%; padding: 6px; border-radius: var(--radius); border: 1px solid var(--m-clay); background: #fafafa; font-size: 14px; box-sizing: border-box; outline: none; }
#success-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 15px; text-align: center; z-index: 9999; display: none; width: 240px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); }
.overlay { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9998; display: none; backdrop-filter: blur(3px); }
.filter-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: var(--radius); z-index: 10000; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; }
.filter-modal .filter-section { margin-bottom: 20px; }
.filter-modal .filter-section-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 10px; border-left: 4px solid var(--m-sage); padding-left: 8px; display: flex; justify-content: space-between; align-items: center; }
.filter-modal .filter-section-title .tip { font-size: 13px; font-weight: normal; color: #aaa; background: #f5f5f5; padding: 4px 8px; border-radius: 12px; pointer-events: none; }
.filter-modal .filter-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px; }
.filter-modal .filter-chip { margin: 2px; }
.filter-modal .close-btn { background: var(--m-clay); border: none; padding: 10px; width: 100%; border-radius: var(--radius); font-size: 13px; cursor: pointer; margin-top: 10px; color: white; }
.crop-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: var(--radius); z-index: 10000; width: 90%; max-width: 600px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column; }
.crop-modal .crop-container { max-height: 60vh; overflow: hidden; margin-bottom: 15px; position: relative; }
.crop-modal .crop-image { max-width: 100%; display: block; }
.crop-modal .crop-actions { display: flex; gap: 10px; margin-top: 15px; }
.crop-modal .crop-btn { flex: 1; background: var(--m-deep-green); color: white; border: none; padding: 12px; border-radius: var(--radius); font-size: 13px; cursor: pointer; }
.crop-modal .cancel-btn { background: var(--m-clay); color: white; }
.zoom-nav { position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0,0,0,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white; cursor: pointer; z-index: 10; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(2px); }
.zoom-nav.left { left: 10px; }
.zoom-nav.right { right: 10px; }
.zoom-nav:hover { background: rgba(0,0,0,0.7); }
.zoom-info { padding: 15px; background: #fafafa; border-top: 1px solid var(--m-clay); font-size: 12px; color: var(--text); display: flex; flex-wrap: wrap; gap: 0; margin-top: 10px; }
.zoom-info-item { border: 1px solid var(--m-clay); border-radius: 6px; padding: 6px 10px; flex: 1 1 auto; min-width: 0; background: transparent; margin: 0; }
.zoom-info-item strong { color: var(--m-brown); font-size: 11px; display: block; margin-bottom: 2px; }
.zoom-info-item span { font-weight: bold; color: var(--m-deep-green); }
.zoom-info-row { display: flex; gap: 0; width: 100%; flex-wrap: nowrap; }
.zoom-info-row .zoom-info-item { flex: 1; }
.tag-context-menu { position: fixed; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 5px 0; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; }
.tag-context-menu div { padding: 10px 20px; cursor: pointer; font-size: 13px; color: var(--text); }
.tag-context-menu div:hover { background: var(--m-clay); }
.stat-card { background:#fff; padding:20px; border-radius:var(--radius); border:1px solid var(--m-clay); margin-bottom: 20px; position: relative; }
.stat-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 15px; border-left: 4px solid var(--m-sage); padding-left: 10px; }
.overview-row { display: flex; gap: 20px; font-size: 20px; }
.overview-item { flex: 1; text-align: center; background: #ffffff; border-radius: var(--radius); padding: 15px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.overview-item strong { display: block; color: var(--m-brown); font-size: 14px; margin-bottom: 8px; }
.overview-item span { font-size: 28px; font-weight: bold; color: var(--m-deep-green); }
#monthlyChart, #roleChart, #roleCountChart, #typeCountChart { height: 250px !important; width: 100%; }
.rank-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.rank-table th { text-align: left; font-size: 11px; color: var(--m-brown); padding-bottom: 5px; border-bottom: 1px solid var(--m-clay); }
.rank-table td { padding: 8px 0; font-size: 12px; border-bottom: 1px solid #f0f0f0; }
.rank-table tr:last-child td { border-bottom: none; }
.rank-table .rank-1 { color: var(--m-deep-green); font-weight: bold; }
.rank-table .rank-2 { color: var(--m-sage); font-weight: bold; }
.rank-table .rank-3 { color: var(--m-brown); font-weight: bold; }
.image-pending-note { font-size: 11px; color: var(--m-deep-green); margin-top: 5px; font-weight: bold; }
.filter-btn-bottom { background: transparent; border: 1px solid var(--m-deep-green); border-radius: 6px; padding: 4px 12px; font-size: 13px; color: var(--m-deep-green); cursor: pointer; white-space: nowrap; font-weight: bold; }
.edit-toggle-btn { font-size: 13px; color: var(--m-deep-green); border: 1px solid var(--m-deep-green); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.grid-range-slider { -webkit-appearance: none; width: 80px; height: 4px; background: var(--m-clay); border-radius: 2px; outline: none; }
.grid-range-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--m-deep-green); border-radius: 50%; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.grid-range-slider::-moz-range-thumb { width: 16px; height: 16px; background: var(--m-deep-green); border-radius: 50%; cursor: pointer; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.grid-range-slider::-moz-range-track { height: 4px; background: var(--m-clay); border-radius: 2px; }
.version-tag { position: absolute; bottom: 10px; left: 10px; font-size: 10px; color: rgba(0,0,0,0.3); background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 4px; backdrop-filter: blur(2px); }
.theme-strip { width: 120px; height: 40px; display: flex; border-radius: 8px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
.theme-strip:hover { transform: scale(1.05); }
.theme-strip div { flex: 1; height: 100%; }
.theme-row { display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
</style>
</head>
<body class="theme-1">
<!-- 固定面板 (與先前相同) -->
<div id="batch-panel">
    <span id="batch-count" style="font-weight: bold;">已選擇0項</span>
    <div>
        <span onclick="setBatchMode(false)" style="cursor:pointer; margin-right:20px; font-size:14px; font-weight: bold;">取消</span>
        <button class="batch-btn" onclick="confirmBatchDelete()">刪除選中</button>
    </div>
</div>
<div class="overlay" id="overlay"></div>
<div id="success-modal">
    <div id="modal-icon" style="font-size: 40px; margin-bottom: 15px; color: var(--m-deep-green);"></div>
    <div id="modal-text" style="font-weight: bold; font-size: 16px;">操作成功</div>
    <button class="btn-main" onclick="closeModal()" style="margin-top: 25px;">確定</button>
</div>

<div class="filter-modal" id="filterModal">
    <div id="filterModalContent"></div>
    <button class="close-btn" onclick="closeFilterModal()">關閉</button>
</div>

<div class="crop-modal" id="cropModal">
    <div class="crop-container">
        <img id="cropImage" class="crop-image" src="">
        <div class="zoom-nav left" id="zoomPrev" style="display: none;">‹</div>
        <div class="zoom-nav right" id="zoomNext" style="display: none;">›</div>
    </div>
    <div id="zoomInfo" class="zoom-info" style="display: none;"></div>
    <div class="crop-actions">
        <button class="crop-btn" id="cropConfirmBtn" style="display: none;">確認裁剪</button>
        <button class="crop-btn cancel-btn" onclick="closeCropModal()">關閉</button>
    </div>
</div>

<div class="tag-context-menu" id="tagContextMenu">
    <div onclick="editTagFromMenu()">編輯標籤</div>
    <div onclick="deleteTagFromMenu()">刪除標籤</div>
</div>

<div id="cover-page">
    <div class="cover-upload-btn" onclick="document.getElementById('coverInput').click()">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--m-deep-green)"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>
    </div>
    <input type="file" id="coverInput" style="display:none;" accept="image/*" onchange="updateCover(this)">
    <div class="cover-menu">
        <h4 style="text-align:center; font-weight:400; letter-spacing:6px; margin-bottom:25px; color: var(--m-deep-green);">M.ARCHIVE</h4>
        <div class="menu-btn" onclick="openPage('page-gallery')">進入藏品庫</div>
        <div class="menu-btn" onclick="triggerQuickUpload()">上載藏品</div>
    </div>
    <div class="version-tag">v1.0.4-IndexedDB</div>
</div>
<input type="file" id="quickUploadInput" style="display:none;" accept="image/*" onchange="handleQuickUploadFile(this)">

<div class="main-content" id="main-content">
    <!-- 館藏頁、等候區、願望清單、新增/編輯、數據統計、系統設定 (與先前相同) -->
    <!-- 為節省篇幅，此處省略重複的 HTML 結構，請直接複製之前版本中的對應部分 -->
    <!-- 注意：必須保留所有頁面元素，這裡只顯示結構示意，實際使用時請補回完整內容 -->
    <div id="page-gallery" class="page">...</div>
    <div id="page-pending" class="page">...</div>
    <div id="page-wish" class="page">...</div>
    <div id="page-recent" class="page">...</div>
    <div id="page-stats" class="page">...</div>
    <div id="page-settings" class="page">...</div>
</div>

<nav class="nav-bar" id="bottom-nav" style="display:none;">
    <button class="nav-item active" onclick="switchTab('page-gallery', this)">館藏</button>
    <button class="nav-item" onclick="switchTab('page-pending', this)">等候</button>
    <button class="nav-item" onclick="switchTab('page-wish', this)">願望</button>
    <button class="nav-item" onclick="resetFormForNew(); switchTab('page-recent', this)">新增</button>
    <button class="nav-item" onclick="switchTab('page-stats', this)">數據</button>
    <button class="nav-item" onclick="switchTab('page-settings', this)">設定</button>
</nav>

<script>
// ========== IndexedDB 設定 ==========
const DB_NAME = 'MorandiArchiveDB';
const DB_VERSION = 1;
let dbInstance = null; // 資料庫連線實例

// 開啟資料庫
function openDB() {
    return new Promise((resolve, reject) => {
        if (dbInstance) {
            resolve(dbInstance);
            return;
        }
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = (e) => reject('無法開啟資料庫');
        request.onsuccess = (e) => {
            dbInstance = e.target.result;
            resolve(dbInstance);
        };
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('archive')) {
                db.createObjectStore('archive');
            }
        };
    });
}

// 讀取資料
async function loadFromDB() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction('archive', 'readonly');
        const store = tx.objectStore('archive');
        const request = store.get('main');
        request.onsuccess = () => resolve(request.result || { merchList: [], dict: { works: [], roles: [], types: [] } });
        request.onerror = () => reject('讀取失敗');
    });
}

// 寫入資料
async function saveToDB(data) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const tx = db.transaction('archive', 'readwrite');
        const store = tx.objectStore('archive');
        const request = store.put(data, 'main');
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

// ========== 全域變數 ==========
const STORAGE_KEY = 'archive_master'; // 不再使用，保留僅供參考
const DICT_KEY = 'archive_dict_master';
const COVER_KEY = 'archive_cover_bg';
const LAST_INPUT_KEY = 'archive_last_input';
const DEFAULT_WORKS = ['作品1', '作品2'];
const DEFAULT_TYPES = ['襟','色紙','掛件','立牌', '拍立得'];

const GRID_SIZES = [50, 72, 103, 109, 170];
const rates = { HKD: 1, RMB: 1.1, JPY: 0.053 };

let merchList = [], dict = { works: [], roles: [], types: [] };
let filters = { work: [], role: [], type: [] };
let sortMode = 'date', sortDesc = true, viewMode = 'grid', charts = {};
let isBatchMode = false, selectedIndices = [];
let currentFilterModalStatus = null;

let cropper = null;
let pendingCropImage = null;
let cropCallback = null;
let isZoomMode = false;
let currentZoomIndex = -1;

let longPressedTag = { key: null, value: null };
let isUpdatingGrid = false;
let lastActivePageBeforeEdit = 'page-gallery';

Chart.register(ChartDataLabels);

document.getElementById('overlay').addEventListener('click', function() {
    if (document.getElementById('success-modal').style.display === 'block') closeModal();
    if (document.getElementById('filterModal').style.display === 'block') closeFilterModal();
    if (document.getElementById('cropModal').style.display === 'flex') closeCropModal();
});

function setTheme(themeNum) {
    document.body.className = '';
    document.body.classList.add('theme-' + themeNum);
    localStorage.setItem('selected_theme', 'theme-' + themeNum);
}

function compressImage(base64, maxSize = 800, quality = 0.9) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > height) {
                if (width > maxSize) {
                    height *= maxSize / width;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width *= maxSize / height;
                    height = maxSize;
                }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const compressed = canvas.toDataURL('image/jpeg', quality);
            resolve(compressed);
        };
        img.onerror = () => resolve(base64);
    });
}

// ========== 初始化 (改為非同步) ==========
async function init() {
    try {
        const data = await loadFromDB();
        merchList = data.merchList || [];
        dict = data.dict || { works: [], roles: [], types: [] };
        if (!dict.works || dict.works.length === 0) dict.works = [...DEFAULT_WORKS];
        if (!dict.types || dict.types.length === 0) dict.types = [...DEFAULT_TYPES];
        if (!dict.roles) dict.roles = [];
    } catch (e) {
        console.warn('讀取資料庫失敗，使用預設值', e);
        merchList = [];
        dict = { works: [...DEFAULT_WORKS], roles: [], types: [...DEFAULT_TYPES] };
    }

    const savedCover = localStorage.getItem(COVER_KEY);
    if (savedCover) document.getElementById('cover-page').style.backgroundImage = `url(${savedCover})`;

    const savedTheme = localStorage.getItem('selected_theme');
    if (savedTheme) document.body.className = savedTheme;

    const savedGridSize = localStorage.getItem('archive_grid_size') || '160';
    const nearest = findNearestGridSize(parseInt(savedGridSize));
    updateGridSize(nearest);
    renderSelects(); 
    renderAll(); 
    updateToolUI();
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('tagContextMenu');
        if (menu.style.display === 'block' && !menu.contains(e.target)) menu.style.display = 'none';
    });
}

function findNearestGridSize(val) {
    return GRID_SIZES.reduce((prev, curr) => Math.abs(curr - val) < Math.abs(prev - val) ? curr : prev);
}

function handleGridSliderInput(slider) {
    if (isUpdatingGrid) return;
    const val = parseInt(slider.value);
    const nearest = findNearestGridSize(val);
    if (nearest !== val) {
        isUpdatingGrid = true;
        slider.value = nearest;
        isUpdatingGrid = false;
    }
    updateGridSize(nearest);
}

// 取代原本的 save()，現在非同步寫入 IndexedDB
async function commitToDB() {
    try {
        await saveToDB({ merchList, dict });
    } catch (e) {
        showModal("❌", "儲存失敗，可能圖片過大或空間不足");
        throw e;
    }
}

function showModal(icon, text) {
    document.getElementById('modal-icon').innerText = icon;
    document.getElementById('modal-text').innerText = text;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('success-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('success-modal').style.display = 'none';
}

function updateDateLabel() {
    const status = document.getElementById('status').value;
    const label = document.getElementById('dateLabel');
    if (status === '非現貨') label.innerText = '預計發售日期(選填)';
    else if (status === '願望') label.innerText = '發現日期(選填)';
    else label.innerText = '購買日期(選填)';
}

function setBatchMode(on) {
    isBatchMode = on; selectedIndices = [];
    document.getElementById('batch-panel').style.display = isBatchMode ? 'flex' : 'none';
    document.getElementById('bottom-nav').style.bottom = isBatchMode ? '-100px' : '25px';
    document.getElementById('main-content').style.marginTop = isBatchMode ? '50px' : '0px';
    renderAll();
}

function toggleSelectItem(idx) {
    const sIdx = selectedIndices.indexOf(idx);
    if (sIdx > -1) selectedIndices.splice(sIdx, 1); else selectedIndices.push(idx);
    document.getElementById('batch-count').innerText = `已選擇${selectedIndices.length}項`;
    renderAll();
}

async function confirmBatchDelete() {
    if (selectedIndices.length === 0) return;
    if (!confirm(`確定刪除選中的${selectedIndices.length}個藏品嗎?`)) return;
    const indicesToDelete = [...selectedIndices].sort((a, b) => b - a);
    let newList = [...merchList];
    indicesToDelete.forEach(idx => newList.splice(idx, 1));
    merchList = newList;
    try {
        await commitToDB();
    } catch (e) {
        showModal("❌", "儲存失敗，無法刪除");
        return;
    }
    renderSelects();
    renderAll();
    setBatchMode(false);
}

function setSort(mode) { sortMode = mode; updateToolUI(); renderAll(); }
function toggleOrder() { sortDesc = !sortDesc; updateToolUI(); renderAll(); }
function setView(v) { viewMode = v; updateToolUI(); renderAll(); }

function updateToolUI() {
    document.querySelectorAll('.symbol-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.sort-' + sortMode).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.view-' + viewMode).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.order-toggle').forEach(b => b.innerText = sortDesc ? "↓" : "↑");
}

function renderFiltersInModal(status) {
    const container = document.getElementById('filterModalContent');
    if (!container) return;
    container.innerHTML = '';

    const buildSection = (title, list, key) => {
        const section = document.createElement('div'); section.className = 'filter-section';
        const titleEl = document.createElement('div'); titleEl.className = 'filter-section-title'; 
        if (key === 'work') {
            titleEl.innerHTML = `${title} <span class="tip">長按編輯或刪除標籤</span>`;
        } else {
            titleEl.innerText = title;
        }
        section.appendChild(titleEl);
        const row = document.createElement('div'); row.className = 'filter-row';

        const allChip = document.createElement('div');
        allChip.className = `filter-chip ${filters[key].length === 0 ? 'active' : ''}`;
        const totalCount = status ? merchList.filter(i => i.status === status).length : 0;
        allChip.innerText = `全部 (${totalCount})`;
        allChip.onclick = () => { filters[key] = []; renderAll(); renderFiltersInModal(status); };
        row.appendChild(allChip);

        list.forEach(item => {
            const count = status ? merchList.filter(i => i.status === status && i[key] === item).length : 0;
            const chip = document.createElement('div');
            chip.className = `filter-chip ${filters[key].includes(item) ? 'active' : ''}`;
            chip.innerText = `${item} (${count})`;
            chip.onclick = () => {
                if (filters[key].includes(item)) filters[key] = filters[key].filter(v => v !== item);
                else filters[key] = [...filters[key], item];
                renderAll(); renderFiltersInModal(status);
            };
            handleLongPress(chip, () => {
                longPressedTag = { key, value: item };
                const rect = chip.getBoundingClientRect();
                const menu = document.getElementById('tagContextMenu');
                menu.style.left = rect.left + 'px';
                menu.style.top = rect.bottom + 'px';
                menu.style.display = 'block';
            });
            row.appendChild(chip);
        });
        section.appendChild(row);
        return section;
    };

    container.appendChild(buildSection('作品', dict.works, 'work'));
    container.appendChild(buildSection('角色', dict.roles, 'role'));
    container.appendChild(buildSection('類別', dict.types, 'type'));
}

async function editTagFromMenu() {
    const { key, value } = longPressedTag;
    if (!key || !value) return;
    const dictKey = key + 's';
    const newValue = prompt(`編輯 ${key} 標籤「${value}」為：`, value);
    if (!newValue || newValue === value) { document.getElementById('tagContextMenu').style.display = 'none'; return; }
    if (dict[dictKey].includes(newValue)) { alert('該標籤名稱已存在，請使用其他名稱'); return; }
    const index = dict[dictKey].indexOf(value);
    if (index !== -1) { dict[dictKey][index] = newValue; dict[dictKey].sort(); }
    merchList = merchList.map(item => { if (item[key] === value) item[key] = newValue; return item; });
    if (filters[key].includes(value)) filters[key] = filters[key].map(v => v === value ? newValue : v);
    try {
        await commitToDB();
    } catch (e) {
        showModal("❌", "儲存失敗");
    }
    renderSelects(); renderAll();
    document.getElementById('tagContextMenu').style.display = 'none'; longPressedTag = { key: null, value: null };
}

async function deleteTagFromMenu() {
    const { key, value } = longPressedTag;
    if (!key || !value) return;
    const dictKey = key + 's';
    if (!confirm(`確定刪除標籤「${value}」嗎？此操作不會影響現有藏品。`)) return;
    dict[dictKey] = dict[dictKey].filter(v => v !== value);
    if (filters[key].includes(value)) filters[key] = filters[key].filter(v => v !== value);
    try {
        await commitToDB();
    } catch (e) {
        showModal("⚠️", "儲存失敗");
    }
    renderSelects(); renderAll();
    document.getElementById('tagContextMenu').style.display = 'none'; longPressedTag = { key: null, value: null };
}

function openFilterModal(status) {
    currentFilterModalStatus = status;
    renderFiltersInModal(status);
    document.getElementById('filterModal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

function closeFilterModal() {
    document.getElementById('filterModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    currentFilterModalStatus = null;
}

function handleLongPress(element, callback) {
    let timer;
    const start = () => { timer = setTimeout(() => { if (window.navigator.vibrate) window.navigator.vibrate(60); callback(); }, 700); };
    const cancel = () => clearTimeout(timer);
    element.addEventListener('touchstart', start, { passive: true });
    element.addEventListener('touchend', cancel);
    element.addEventListener('mousedown', start);
    element.addEventListener('mouseup', cancel);
}

function switchTab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); btn.classList.add('active'); }
    if (id === 'page-stats') renderStats();
    closeFilterModal();
    if (isBatchMode) setBatchMode(false);
}

function openPage(id) {
    document.getElementById('cover-page').classList.add('open');
    document.getElementById('bottom-nav').style.display = 'flex';
    const index = ['page-gallery', 'page-pending', 'page-wish', 'page-stats', 'page-recent', 'page-settings'].indexOf(id);
    switchTab(id, document.querySelectorAll('.nav-item')[index]);
}

function handleBack() {
    const activePage = document.querySelector('.page.active')?.id;
    if (activePage === 'page-recent') switchTab('page-gallery', document.querySelector('.nav-item'));
    else {
        document.getElementById('cover-page').classList.remove('open');
        document.getElementById('bottom-nav').style.display = 'none';
    }
}

function toggleInput(sid, iid) {
    const s = document.getElementById(sid);
    const i = document.getElementById(iid);
    i.style.display = (s.value === 'NEW') ? 'block' : 'none';
}

function liveExchange() {
    const c = document.getElementById('currency').value;
    const p = parseFloat(document.getElementById('inputPrice').value) || 0;
    const q = parseInt(document.getElementById('qty').value) || 1;
    const total = (p * rates[c] * q).toFixed(2);
    document.getElementById('exchangePreview').innerText = `總額: HKD ${total}`;
}

async function deleteCurrentItem() {
    const idx = parseInt(document.getElementById('editIndex').value);
    if (idx > -1 && confirm("確定刪除此藏品？")) {
        let newList = [...merchList]; newList.splice(idx, 1);
        merchList = newList;
        try {
            await commitToDB();
        } catch (e) {
            showModal("❌", "刪除失敗，無法儲存");
            return;
        }
        renderSelects(); renderAll(); resetFormForNew();
        switchTab('page-gallery', document.querySelectorAll('.nav-item')[0]);
    }
}

function renderSelects() {
    const fill = (id, list) => {
        const s = document.getElementById(id);
        const combined = [...list].sort();
        s.innerHTML = '<option value="">請選擇...</option>' + combined.map(x => `<option value="${x}">${x}</option>`).join('') + '<option value="NEW">+ 新增標籤</option>';
    };
    fill('workSelect', dict.works);
    fill('roleSelect', dict.roles);
    fill('typeSelect', dict.types);
}

function updateGridSize(v) {
    document.documentElement.style.setProperty('--dynamic-grid', v + 'px');
    localStorage.setItem('archive_grid_size', v);
    isUpdatingGrid = true;
    document.querySelectorAll('.grid-range-slider').forEach(slider => slider.value = v);
    isUpdatingGrid = false;
    let scale = 1;
    if (v <= 106) scale = Math.max(0.7, v / 106);
    document.documentElement.style.setProperty('--info-scale', scale);
}

function updateCover(input) {
    if (input.files && input.files[0]) {
        const fr = new FileReader();
        fr.onload = (e) => {
            document.getElementById('cover-page').style.backgroundImage = `url(${e.target.result})`;
            localStorage.setItem(COVER_KEY, e.target.result);
        };
        fr.readAsDataURL(input.files[0]);
    }
}

function exportData() {
    // 匯出時從記憶體取得資料，也可從資料庫讀取，但記憶體已同步
    const data = JSON.stringify({ merchList, dict, cover: localStorage.getItem(COVER_KEY) });
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `archive_backup_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
}

async function importData(input) {
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = JSON.parse(e.target.result);
            merchList = data.merchList || [];
            dict = data.dict || { works: [], roles: [], types: [] };
            if (!dict.works) dict.works = [];
            if (!dict.roles) dict.roles = [];
            if (!dict.types) dict.types = [];
            if (data.cover) localStorage.setItem(COVER_KEY, data.cover);
            await commitToDB(); // 寫入資料庫
            location.reload();   // 重新載入以確保一切正常
        } catch (ex) { showModal("❌", "匯入檔案格式錯誤"); }
    };
    reader.readAsText(input.files[0]);
}

function renderStats() {
    if (charts.monthly) charts.monthly.destroy();
    if (charts.role) charts.role.destroy();
    if (charts.roleCount) charts.roleCount.destroy();
    if (charts.typeCount) charts.typeCount.destroy();

    const statsList = merchList.filter(i => i.status !== '願望');
    const totalExpense = statsList.reduce((sum, i) => sum + parseFloat(i.totalHkd || 0), 0).toFixed(2);

    document.getElementById('totalCountSpan').innerText = merchList.length;
    document.getElementById('totalExpenseSpan').innerText = `HKD ${totalExpense}`;

    const colors = ['#6b7a63', '#acc1ad', '#a68b7c', '#d5cabd', '#e5ddd5', '#c2b2a3'];

    const mData = {};
    statsList.forEach(i => {
        const d = new Date(i.timestamp);
        const k = `${d.getFullYear()}/${d.getMonth() + 1}`;
        mData[k] = (mData[k] || 0) + parseFloat(i.totalHkd);
    });
    charts.monthly = new Chart(document.getElementById('monthlyChart'), {
        type: 'line',
        data: { labels: Object.keys(mData), datasets: [{ label: 'HKD', data: Object.values(mData), borderColor: '#6b7a63', tension: 0.3 }] },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            plugins: { datalabels: { display: true, align: 'bottom', offset: 10, formatter: (value) => '$' + parseInt(value), font: { size: 9, weight: 'bold' }, color: '#6b7a63' } }
        }
    });

    const rData = {};
    statsList.forEach(i => { rData[i.role] = (rData[i.role] || 0) + parseFloat(i.totalHkd); });
    const rSorted = Object.entries(rData).sort((a, b) => b[1] - a[1]).slice(0, 3);
    const rColors = ['#6b7a63', '#acc1ad', '#a68b7c'];
    charts.role = new Chart(document.getElementById('roleChart'), {
        type: 'bar',
        data: { labels: rSorted.map(x => x[0]), datasets: [{ label: 'HKD', data: rSorted.map(x => x[1]), backgroundColor: rColors }] },
        options: { indexAxis: 'y', maintainAspectRatio: false, responsive: true, plugins: { datalabels: { anchor: 'end', align: 'right', offset: 4, color: '#333', font: { weight: 'bold', size: 11 }, formatter: (value) => '$ ' + parseInt(value) } } }
    });

    const rcData = {};
    statsList.forEach(i => { rcData[i.role] = (rcData[i.role] || 0) + 1; });
    const rcSorted = Object.entries(rcData).sort((a, b) => b[1] - a[1]).slice(0, 3);
    const rcColors = ['#6b7a63', '#acc1ad', '#a68b7c'];
    charts.roleCount = new Chart(document.getElementById('roleCountChart'), {
        type: 'bar',
        data: { labels: rcSorted.map(x => x[0]), datasets: [{ label: '數量', data: rcSorted.map(x => x[1]), backgroundColor: rcColors }] },
        options: { indexAxis: 'y', maintainAspectRatio: false, responsive: true, plugins: { datalabels: { anchor: 'end', align: 'right', offset: 4, color: '#333', font: { weight: 'bold', size: 11 }, formatter: (value) => value } } }
    });

    const tData = {};
    statsList.forEach(i => { tData[i.type] = (tData[i.type] || 0) + 1; });
    charts.typeCount = new Chart(document.getElementById('typeCountChart'), {
        type: 'doughnut',
        data: { labels: Object.keys(tData), datasets: [{ data: Object.values(tData), backgroundColor: colors }] },
        options: { maintainAspectRatio: false, responsive: true, plugins: { datalabels: { color: '#fff', font: { weight: 'bold', size: 11 }, formatter: (value, context) => { const total = context.dataset.data.reduce((a,b)=>a+b,0); return (value / total * 100).toFixed(1) + '%'; } } } }
    });

    const rankBody = document.getElementById('roleRankBody');
    if (rankBody) {
        const topRoles = Object.entries(rData).sort((a,b)=>b[1]-a[1]).slice(0,3);
        let html = '';
        topRoles.forEach(([role, total], index) => {
            const count = statsList.filter(i => i.role === role).length;
            const className = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : 'rank-3');
            html += `<tr><td class="${className}">${role}</td><td>${count}</td><td>$ ${parseInt(total)}</td></tr>`;
        });
        rankBody.innerHTML = html;
    }
}

// ========== 圖片處理 ==========
function triggerQuickUpload() { document.getElementById('quickUploadInput').click(); }

function handleQuickUploadFile(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) {
        showModal("❌", "圖片過大，請選擇小於 10MB 的圖片。");
        input.value = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        openCropModal(e.target.result, async (croppedBase64) => {
            pendingCropImage = await compressImage(croppedBase64, 800, 0.9);
            document.getElementById('pendingImageNote').style.display = 'block';
            resetFormForNew();
            openPage('page-recent');
        }, false);
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function handleImageFileSelect(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) {
        showModal("❌", "圖片過大，請選擇小於 10MB 的圖片。");
        input.value = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        openCropModal(e.target.result, async (croppedBase64) => {
            pendingCropImage = await compressImage(croppedBase64, 800, 0.9);
            document.getElementById('pendingImageNote').style.display = 'block';
            input.value = '';
        }, false);
    };
    reader.readAsDataURL(file);
}

function zoomImage(item, index) {
    currentZoomIndex = index;
    openCropModal(item.img, null, true, item);
}

function updateZoomDisplay(index) {
    const item = merchList[index];
    if (!item || !item.img) {
        document.getElementById('zoomInfo').style.display = 'none';
        return;
    }
    document.getElementById('zoomInfo').style.display = 'block';
    const img = document.getElementById('cropImage');
    if (cropper) {
        cropper.replace(item.img);
    } else {
        img.src = item.img;
    }
    const totalInt = parseInt(parseFloat(item.totalHkd));
    let unitPriceHKD = (parseFloat(item.price) * rates[item.currency]);
    let unitPriceStr = (unitPriceHKD % 1 === 0) ? unitPriceHKD.toString() : unitPriceHKD.toFixed(2);
    const infoDiv = document.getElementById('zoomInfo');
    infoDiv.innerHTML = `
        <div class="zoom-info-item"><strong>作品</strong><span>${item.work || '無'}</span></div>
        <div class="zoom-info-item"><strong>角色</strong><span>${item.role || '無'}</span></div>
        <div class="zoom-info-item"><strong>類別</strong><span>${item.type || '無'}</span></div>
        <div class="zoom-info-row">
            <div class="zoom-info-item"><strong>單價</strong><span>$ ${unitPriceStr}</span></div>
            <div class="zoom-info-item"><strong>數量</strong><span>${item.qty}</span></div>
        </div>
        <div class="zoom-info-item" style="flex: 0 0 100%;"><strong>總價</strong><span>$ ${totalInt}</span></div>
    `;
    document.getElementById('zoomPrev').style.display = 'flex';
    document.getElementById('zoomNext').style.display = 'flex';
}

function openCropModal(imageSrc, callback, isZoom = false, item = null) {
    const img = document.getElementById('cropImage');
    img.src = imageSrc;
    cropCallback = callback;
    isZoomMode = isZoom;

    document.getElementById('cropConfirmBtn').style.display = isZoom ? 'none' : 'block';
    document.getElementById('zoomPrev').style.display = 'none';
    document.getElementById('zoomNext').style.display = 'none';
    document.getElementById('zoomInfo').style.display = isZoom ? 'block' : 'none';

    document.getElementById('cropModal').style.display = 'flex';
    document.getElementById('overlay').style.display = 'block';

    if (cropper) cropper.destroy();

    if (isZoom) {
        cropper = new Cropper(img, { 
            viewMode: 1, 
            dragMode: 'move', 
            autoCrop: false, 
            cropBoxMovable: false, 
            cropBoxResizable: false, 
            toggleDragModeOnDblclick: false, 
            background: false, 
            zoomable: true, 
            zoomOnWheel: true 
        });
        if (item) {
            updateZoomDisplay(currentZoomIndex);
        }
    } else {
        cropper = new Cropper(img, { 
            aspectRatio: 1, 
            viewMode: 1, 
            autoCropArea: 0.8, 
            responsive: true, 
            zoomable: true, 
            zoomOnWheel: true, 
            movable: true, 
            cropBoxMovable: true, 
            cropBoxResizable: true, 
            toggleDragModeOnDblclick: false 
        });
    }

    document.getElementById('cropConfirmBtn').onclick = function () {
        if (!cropper || isZoomMode) return;
        const canvas = cropper.getCroppedCanvas({ width: 800, height: 800 });
        const croppedBase64 = canvas.toDataURL('image/jpeg', 0.9);
        if (cropCallback) cropCallback(croppedBase64);
        closeCropModal();
    };
}

function zoomPrev() {
    if (!merchList.length) return;
    let newIndex = currentZoomIndex - 1;
    if (newIndex < 0) newIndex = merchList.length - 1;
    while (newIndex !== currentZoomIndex && (!merchList[newIndex] || !merchList[newIndex].img)) {
        newIndex = (newIndex - 1 + merchList.length) % merchList.length;
    }
    if (merchList[newIndex] && merchList[newIndex].img) {
        currentZoomIndex = newIndex;
        updateZoomDisplay(currentZoomIndex);
    }
}

function zoomNext() {
    if (!merchList.length) return;
    let newIndex = (currentZoomIndex + 1) % merchList.length;
    while (newIndex !== currentZoomIndex && (!merchList[newIndex] || !merchList[newIndex].img)) {
        newIndex = (newIndex + 1) % merchList.length;
    }
    if (merchList[newIndex] && merchList[newIndex].img) {
        currentZoomIndex = newIndex;
        updateZoomDisplay(currentZoomIndex);
    }
}

document.getElementById('zoomPrev').addEventListener('click', zoomPrev);
document.getElementById('zoomNext').addEventListener('click', zoomNext);

function closeCropModal() {
    document.getElementById('cropModal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    if (cropper) { cropper.destroy(); cropper = null; }
    cropCallback = null;
    isZoomMode = false;
    currentZoomIndex = -1;
}

// ========== 編輯與表單提交 ==========
function editItem(idx) {
    const activePage = document.querySelector('.page.active')?.id;
    if (activePage) lastActivePageBeforeEdit = activePage;
    pendingCropImage = null;
    document.getElementById('pendingImageNote').style.display = 'none';
    const i = merchList[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('workSelect').value = i.work;
    document.getElementById('roleSelect').value = i.role;
    document.getElementById('typeSelect').value = i.type;
    document.getElementById('pattern').value = i.pattern;
    document.getElementById('note').value = i.note || "";
    document.getElementById('status').value = i.status;
    document.getElementById('qty').value = i.qty;
    document.getElementById('buyDate').value = i.buyDate || "";
    document.getElementById('currency').value = i.currency || "HKD";
    document.getElementById('inputPrice').value = i.price || 0;
    document.getElementById('submitBtn').innerText = "更新藏品資料";
    document.getElementById('delBtn').style.display = 'block';
    liveExchange();
    updateDateLabel();
    document.getElementById('recent-page-title').innerText = '編輯藏品';
    switchTab('page-recent');
}

function resetFormForNew() {
    document.getElementById('merchForm').reset();
    document.getElementById('editIndex').value = "-1";
    document.getElementById('submitBtn').innerText = "儲存至資料庫";
    document.getElementById('delBtn').style.display = 'none';
    document.getElementById('exchangePreview').innerText = "總額: HKD 0.00";
    const lastInput = JSON.parse(localStorage.getItem(LAST_INPUT_KEY) || '{}');
    if (lastInput.work) document.getElementById('workSelect').value = lastInput.work;
    if (lastInput.role) document.getElementById('roleSelect').value = lastInput.role;
    if (lastInput.type) document.getElementById('typeSelect').value = lastInput.type;
    if (lastInput.status) document.getElementById('status').value = lastInput.status;
    if (lastInput.currency) document.getElementById('currency').value = lastInput.currency;
    if (lastInput.pattern) document.getElementById('pattern').value = lastInput.pattern;
    if (lastInput.note) document.getElementById('note').value = lastInput.note;
    liveExchange();
    updateDateLabel();
    document.getElementById('recent-page-title').innerText = '新增藏品';
    if (pendingCropImage) document.getElementById('pendingImageNote').style.display = 'block';
    else document.getElementById('pendingImageNote').style.display = 'none';
}

document.getElementById('merchForm').onsubmit = async function (e) {
    e.preventDefault();
    const editIdx = parseInt(document.getElementById('editIndex').value);
    if (document.activeElement) document.activeElement.blur();

    const getV = (sid, iid, dk) => {
        let sVal = document.getElementById(sid).value;
        if (sVal === 'NEW') {
            let v = document.getElementById(iid).value.trim();
            if (v && !dict[dk].includes(v)) { dict[dk].push(v); dict[dk].sort(); }
            return v;
        }
        return sVal;
    };

    const work = getV('workSelect', 'workInput', 'works');
    const role = getV('roleSelect', 'roleInput', 'roles');
    const type = getV('typeSelect', 'typeInput', 'types');
    const status = document.getElementById('status').value;
    const pattern = document.getElementById('pattern').value;
    const note = document.getElementById('note').value;

    const done = async (imgBase64) => {
        const finalImg = imgBase64 || pendingCropImage || (editIdx > -1 ? merchList[editIdx].img : null);
        const data = {
            work, role, type, status,
            pattern: pattern,
            note: note,
            qty: parseInt(document.getElementById('qty').value),
            buyDate: document.getElementById('buyDate').value,
            currency: document.getElementById('currency').value,
            price: parseFloat(document.getElementById('inputPrice').value),
            totalHkd: document.getElementById('exchangePreview').innerText.replace('總額: HKD ', ''),
            img: finalImg,
            timestamp: (editIdx > -1) ? merchList[editIdx].timestamp : Date.now()
        };

        let newList;
        if (editIdx > -1) { newList = [...merchList]; newList[editIdx] = data; }
        else newList = [...merchList, data];

        merchList = newList; // 先更新記憶體

        // 壓縮並儲存
        try {
            let maxSize = 800;
            let quality = 0.9;
            for (let attempt = 0; attempt < 8; attempt++) {
                try {
                    await commitToDB();
                    break;
                } catch (e) {
                    if (attempt === 7) throw e;
                    maxSize = Math.max(50, Math.floor(maxSize / 1.5));
                    quality = Math.max(0.1, quality * 0.8);
                    if (data.img) {
                        const compressed = await compressImage(data.img, maxSize, quality);
                        data.img = compressed;
                        newList[editIdx > -1 ? editIdx : newList.length - 1] = data;
                        merchList = newList; // 更新壓縮後的圖片
                    }
                }
            }
        } catch (e) {
            if (e.name === 'QuotaExceededError' || e.code === 22) {
                showModal("💾", "儲存空間不足，請先備份資料後刪除部分藏品，或匯出後清除瀏覽器資料再重新匯入。");
            } else {
                showModal("❌", "圖片過大，即使極致壓縮仍無法儲存，請選擇更小的圖片 (建議小於 2MB)。");
            }
            return;
        }

        const lastInput = { work: data.work, role: data.role, type: data.type, status: data.status, currency: data.currency, pattern: data.pattern, note: data.note };
        localStorage.setItem(LAST_INPUT_KEY, JSON.stringify(lastInput));

        pendingCropImage = null;
        document.getElementById('pendingImageNote').style.display = 'none';

        renderSelects();
        renderAll();
        resetFormForNew();

        if (editIdx > -1) {
            switchTab(lastActivePageBeforeEdit, document.querySelector('.nav-item'));
        } else {
            setTimeout(() => { showModal("✨", "已存入庫"); }, 400);
        }
    };

    const f = document.getElementById('imgFile').files[0];
    if (f) {
        if (f.size > 10 * 1024 * 1024) {
            showModal("❌", "圖片過大，請選擇小於 10MB 的圖片。");
            return;
        }
        const fr = new FileReader();
        fr.onload = async () => {
            const compressed = await compressImage(fr.result, 800, 0.9);
            done(compressed);
        };
        fr.readAsDataURL(f);
    } else {
        done(null);
    }
};

// ========== renderAll ==========
function renderAll() {
    const conf = { '現貨': 'readyList', '非現貨': 'waitList', '願望': 'wishList' };
    const srch = { '現貨': 'lib-search', '非現貨': 'wait-search', '願望': 'wish-search' };
    Object.keys(conf).forEach(status => {
        const container = document.getElementById(conf[status]); if (!container) return;
        const sVal = document.getElementById(srch[status]) ? document.getElementById(srch[status]).value.toLowerCase() : "";
        let filtered = merchList.map((item, index) => ({ ...item, originalIndex: index }))
            .filter(i => i.status === status)
            .filter(i => filters.work.length === 0 || filters.work.includes(i.work))
            .filter(i => filters.role.length === 0 || filters.role.includes(i.role))
            .filter(i => filters.type.length === 0 || filters.type.includes(i.type))
            .filter(i => (i.pattern + (i.note || "") + (i.role || "")).toLowerCase().includes(sVal));

        const multi = sortDesc ? 1 : -1;
        filtered.sort((a, b) => {
            if (sortMode === 'date') return (b.timestamp - a.timestamp) * multi;
            if (sortMode === 'price') return (parseFloat(b.totalHkd) - parseFloat(a.totalHkd)) * multi;
            if (sortMode === 'name') return (a.pattern.localeCompare(b.pattern, 'zh-TW')) * multi;
            if (sortMode === 'qty') return (b.qty - a.qty) * multi;
            return 0;
        });

        container.innerHTML = ""; container.className = `list-container ${viewMode}`;
        filtered.forEach(i => {
            const card = document.createElement('div');
            card.className = `item-card ${isBatchMode && selectedIndices.includes(i.originalIndex) ? 'selected' : ""}`;
            const noteHtml = i.note ? `<div class="note" style="font-size:calc(9px * var(--info-scale,1)); margin-top:calc(4px * var(--info-scale,1));">📝 ${i.note}</div>` : '';
            const imgHtml = `<div class="img-box"><img src="${i.img || ""}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'%23ccc\\'%3E%3Cpath d=\\'M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6z\\'/%3E%3C/svg%3E'; this.style.objectFit='contain'; this.style.backgroundColor='#f0f0f0';"></div>`;

            const totalInt = parseInt(parseFloat(i.totalHkd));
            let unitPriceHKD = (parseFloat(i.price) * rates[i.currency]);
            let unitPriceStr = (unitPriceHKD % 1 === 0) ? unitPriceHKD.toString() : unitPriceHKD.toFixed(2);

            let infoHtml;
            if (viewMode === 'grid') {
                infoHtml = `
                    <div class="info">
                        <div style="font-size:calc(9px * var(--info-scale,1)); color:var(--m-brown);">${i.role || ""} ${i.type ? '| ' + i.type : ""}</div>
                        <div style="font-weight:bold; font-size:calc(12px * var(--info-scale,1)); margin:calc(4px * var(--info-scale,1)) 0;">${i.pattern || '無名'}</div>
                        <div style="color:#999; font-size: calc(9px * var(--info-scale,1));">單價 $ ${unitPriceStr}</div>
                        <div style="color:var(--m-deep-green); font-size: calc(13px * var(--info-scale,1)); font-weight:bold; margin-top: auto;">$ ${totalInt}</div>
                        ${noteHtml}
                    </div>
                    <div class="card-qty">x${i.qty}</div>
                `;
            } else if (viewMode === 'list') {
                infoHtml = `
                    <div class="info">
                        <div style="font-size:calc(9px * var(--info-scale,1)); color:var(--m-brown);">${i.role || ""} ${i.type ? '| ' + i.type : ""}</div>
                        <div style="font-weight:bold; font-size:calc(12px * var(--info-scale,1)); margin:calc(4px * var(--info-scale,1)) 0;">${i.pattern || '無名'}</div>
                        <div style="color:#999; font-size: calc(9px * var(--info-scale,1)); margin-bottom: 2px;">單價 $ ${unitPriceStr}</div>
                        <div style="color:var(--m-deep-green); font-size: calc(13px * var(--info-scale,1)); font-weight:bold;">$ ${totalInt} <span style="color:#aaa;font-weight:normal;font-size:calc(9px * var(--info-scale,1));">x${i.qty}</span></div>
                        ${noteHtml}
                    </div>
                `;
            } else {
                infoHtml = '';
            }

            card.innerHTML = imgHtml + infoHtml;
            card.onclick = () => isBatchMode ? toggleSelectItem(i.originalIndex) : editItem(i.originalIndex);
            handleLongPress(card, () => {
                if (!isBatchMode && i.img) zoomImage(i, i.originalIndex);
            });
            container.appendChild(card);
        });
        const cld = status === '現貨' ? 'lib-count' : (status === '非現貨' ? 'wait-count' : 'wish-count');
        const countLabel = document.getElementById(cld);
        if (countLabel) {
            const total = merchList.filter(x => x.status === status).length;
            countLabel.innerHTML = `<span>顯示:</span><span class="number">${filtered.length}/${total}</span>`;
        }
    });
    if (currentFilterModalStatus) renderFiltersInModal(currentFilterModalStatus);
}

// 啟動
init();
</script>
</body>
</html>
