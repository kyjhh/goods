<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Collection Archive v10</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --m-blue: #92a8d1; --m-green: #88b04b; --m-grey: #b5b5b5;
            --m-sage: #acc1ad; --m-sand: #d5cabd; --bg: #f8f8f7;
            --text: #555; --card-bg: #ffffff;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', sans-serif; background: var(--bg); color: var(--text); }

        /* é«˜æ¸…å°é¢ */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #eee; background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #cover-page.open { transform: translateY(-100%); }
        .cover-upload-label { position: absolute; top: 30px; left: 30px; background: rgba(255,255,255,0.8); padding: 8px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid var(--m-grey); }

        /* å…§å®¹å€ */
        .main-content { padding: 20px; padding-bottom: 120px; max-width: 600px; margin: 0 auto; min-height: 100vh; }
        .back-to-cover { margin-bottom: 20px; cursor: pointer; color: var(--m-blue); font-size: 14px; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* åˆ†é¡ç¯©é¸å™¨ */
        .filter-section { margin-bottom: 15px; }
        .filter-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .filter-chip { background: #eee; border: 1px solid #ddd; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; color: #888; }
        .filter-chip.active { background: var(--m-blue); color: white; border-color: var(--m-blue); }

        .glass-card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #efefef; }

        label { display: block; font-size: 13px; margin: 12px 0 5px; color: var(--m-blue); font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; color: var(--text); box-sizing: border-box; font-size: 14px; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .item-card { background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #eee; position: relative; }
        .item-img { width: 100%; height: 160px; object-fit: cover; background: #fafafa; }
        .item-info { padding: 12px; }
        .price-tag { color: var(--m-green); font-weight: bold; font-size: 15px; margin: 4px 0; }
        .checkbox-arrival { position: absolute; top: 10px; right: 10px; transform: scale(1.3); z-index: 10; accent-color: var(--m-green); }

        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #fff; display: flex; justify-content: space-around; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 1000; border: 1px solid #eee; }
        .nav-item { border: none; background: none; color: #bbb; font-size: 22px; cursor: pointer; }
        .nav-item.active { color: var(--m-blue); }

        .btn-main { background: var(--m-sage); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="cover-page">
        <label class="cover-upload-label">ğŸ“¸ å°å…¥é«˜æ¸…å°é¢ <input type="file" id="cover-upload" hidden accept="image/*"></label>
        <div class="cover-menu" style="display: flex; flex-direction: column; gap: 12px; width: 250px;">
            <h2 style="text-align:center; font-weight:300; letter-spacing:2px; margin-bottom:20px;">MORANDI ARCHIVE</h2>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-gallery')">é€²å…¥è—å“åº«</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-stats')">æ•¸æ“šèˆ‡æ”¯å‡º</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-recent')">æ–°å¢å‘¨é‚Š</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-pending')">æŸ¥çœ‹éç¾è²¨</div>
        </div>
    </div>

    <div class="main-content">
        <div class="back-to-cover" onclick="closePage()">â—€ è¿”å›å°é¢</div>

        <div id="page-gallery" class="page">
            <div class="filter-section">
                <div class="filter-group" id="mainFilter">
                    <div class="filter-chip active" onclick="setFilterMode('all', this)">å…¨éƒ¨</div>
                    <div class="filter-chip" onclick="setFilterMode('work', this)">æŒ‰ä½œå“</div>
                    <div class="filter-chip" onclick="setFilterMode('role', this)">æŒ‰è§’è‰²</div>
                    <div class="filter-chip" onclick="setFilterMode('type', this)">æŒ‰ç¨®é¡</div>
                </div>
                <div class="filter-group" id="subFilter" style="margin-top:8px;"></div>
            </div>
            <div class="gallery" id="readyList"></div>
        </div>

        <div id="page-stats" class="page">
            <div class="glass-card">
                <h3 style="color:var(--m-sage)">ğŸ’° æ”¯å‡ºæ¦‚è¦½</h3>
                <div style="font-size:11px; color:#aaa; margin-bottom:10px;">ç³»çµ±åŒ¯ç‡åƒè€ƒï¼š1 RMB = 1.08 HKD | 100 JPY = 5.2 HKD</div>
                <div id="totalSpend" style="font-size: 26px; font-weight: bold; color: var(--m-green);">HKD 0</div>
                <div style="height: 250px;"><canvas id="charPieChart"></canvas></div>
            </div>
            <div class="glass-card">
                <h4 style="color:var(--m-blue)">ğŸ“… æ¯æœˆæ”¯å‡º</h4>
                <div id="monthlyStats"></div>
            </div>
        </div>

        <div id="page-recent" class="page">
            <div class="glass-card">
                <h3 id="formTitle">ğŸ“ ç´€éŒ„æˆå“¡</h3>
                <form id="merchForm">
                    <input type="hidden" id="editIndex" value="-1">
                    <label>ä½œå“åç¨±</label><input type="text" id="work" placeholder="ä¾‹ï¼šä¸–ç•Œè¨ˆç•«">
                    <label>è§’è‰²</label><input type="text" id="role" required>
                    <label>æŸ„åœ–åç¨±</label><input type="text" id="pattern">
                    <label>å‘¨é‚Šç¨®é¡</label><input type="text" id="type" placeholder="ä¾‹ï¼šå¾½ç« ã€ç«‹ç‰Œ">
                    <label>å‘¨é‚Šå…·é«”åå­—</label><input type="text" id="name" required>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>ç‹€æ…‹</label>
                            <select id="status" onchange="toggleArrivalDate(this.value)">
                                <option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option>
                            </select>
                        </div>
                        <div><label>æ•¸é‡</label><input type="number" id="qty" value="1" min="1"></div>
                    </div>

                    <div id="arrivalGroup" style="display:none;">
                        <label>é è¨ˆåˆ°è²¨æ—¥æœŸ/æœˆä»½</label><input type="text" id="arrivalDate" placeholder="ä¾‹ï¼š2025å¹´6æœˆ">
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                        <div><label>å¹£ç¨®</label><select id="currency"><option value="HKD">HKD</option><option value="RMB">RMB</option><option value="JPY">JPY</option></select></div>
                        <div><label>å–®åƒ¹ (åŸå¹£)</label><input type="number" id="inputPrice" step="0.01" required></div>
                    </div>

                    <label>è³¼å…¥æ—¥æœŸ</label><input type="date" id="buyDate">
                    <label>ç…§ç‰‡ (ç•™ç©ºä¿ç•™)</label><input type="file" id="imgFile">
                    
                    <button type="submit" id="submitBtn" class="btn-main">ç¢ºèªå­˜æª”</button>
                    <button type="button" id="cancelBtn" onclick="resetForm()" style="width:100%; background:none; border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:8px; display:none;">å–æ¶ˆç·¨è¼¯</button>
                </form>
            </div>
        </div>

        <div id="page-pending" class="page">
            <h3 style="color:var(--m-grey)">âŒ› éç¾è²¨å¾…æ”¶ (å‹¾é¸å¯è½‰ç¾è²¨)</h3>
            <div class="gallery" id="waitList"></div>
        </div>
    </div>

    <nav class="nav-bar" id="bottom-nav" style="display:none;">
        <button class="nav-item active" onclick="switchTab('page-gallery', this)">ğŸ–¼ï¸</button>
        <button class="nav-item" onclick="switchTab('page-stats', this)">ğŸ“Š</button>
        <button class="nav-item" onclick="switchTab('page-recent', this)">â•</button>
        <button class="nav-item" onclick="switchTab('page-pending', this)">ğŸ“¦</button>
    </nav>

<script>
    let merchList = JSON.parse(localStorage.getItem('mm25_morandi_v10')) || [];
    const rates = { RMB: 1.08, JPY: 0.052, HKD: 1.0 };
    let myChart = null;
    let currentMode = 'all';
    let currentSub = '';

    // å°é¢è™•ç†
    const coverPage = document.getElementById('cover-page');
    const storedCover = localStorage.getItem('mm25_hd_cover');
    if(storedCover) coverPage.style.backgroundImage = `url(${storedCover})`;
    document.getElementById('cover-upload').onchange = e => {
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('mm25_hd_cover', r.result); coverPage.style.backgroundImage = `url(${r.result})`; };
        r.readAsDataURL(e.target.files[0]);
    };

    function toggleArrivalDate(val) { document.getElementById('arrivalGroup').style.display = (val === 'éç¾è²¨') ? 'block' : 'none'; }
    function openPage(id) { document.getElementById('cover-page').classList.add('open'); document.getElementById('bottom-nav').style.display = 'flex'; switchTab(id, document.querySelector(`[onclick*="${id}"]`)); }
    function closePage() { document.getElementById('cover-page').classList.remove('open'); document.getElementById('bottom-nav').style.display = 'none'; }

    function switchTab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(id === 'page-stats') renderStats();
        renderAll();
    }

    // åˆ†é¡é‚è¼¯
    function setFilterMode(mode, btn) {
        currentMode = mode; currentSub = '';
        document.querySelectorAll('#mainFilter .filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        const subBox = document.getElementById('subFilter');
        if(mode === 'all') { subBox.innerHTML = ''; } 
        else {
            const keys = [...new Set(merchList.filter(i => i.status === 'ç¾è²¨').map(i => i[mode] || 'æœªåˆ†é¡'))];
            subBox.innerHTML = keys.map(k => `<div class="filter-chip" onclick="currentSub='${k}';renderAll();updateSubUI(this)">${k}</div>`).join('');
        }
        renderAll();
    }
    function updateSubUI(btn) { document.querySelectorAll('#subFilter .filter-chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); }

    function renderAll() {
        const genHTML = (item, idx) => `
            <div class="item-card">
                ${item.status === 'éç¾è²¨' ? `<input type="checkbox" class="checkbox-arrival" onclick="markArrived(${idx})">` : ''}
                <img src="${item.img || 'https://via.placeholder.com/150/efefef/999999?text=Photo'}" class="item-img">
                <div class="item-info">
                    <div style="font-size:10px; color:var(--m-blue)">${item.role} | ${item.type || 'æœªåˆ†é¡'}</div>
                    <div style="font-weight:bold; font-size:13px; margin:2px 0;">${item.name}</div>
                    <div class="price-tag">HK$ ${Number(item.totalHkd).toLocaleString()}</div>
                    <div style="font-size:10px; opacity:0.6;">x ${item.qty} (${item.pattern || 'ç„¡æŸ„åœ–'})</div>
                    ${item.arrivalDate ? `<div style="font-size:9px; color:var(--m-grey)">é è¨ˆåˆ°è²¨ï¼š${item.arrivalDate}</div>` : ''}
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <span style="font-size:11px; cursor:pointer; color:var(--m-blue)" onclick="editItem(${idx})">ç·¨è¼¯</span>
                        <span style="font-size:11px; cursor:pointer; color:#d9534f" onclick="deleteItem(${idx})">åˆªé™¤</span>
                    </div>
                </div>
            </div>`;

        // æ¸²æŸ“ç¾è²¨åº«
        document.getElementById('readyList').innerHTML = merchList.map((item, index) => ({item, index}))
            .filter(o => {
                if(o.item.status !== 'ç¾è²¨') return false;
                if(currentMode !== 'all' && currentSub && (o.item[currentMode] || 'æœªåˆ†é¡') !== currentSub) return false;
                return true;
            }).map(o => genHTML(o.item, o.index)).join('');

        // æ¸²æŸ“éç¾è²¨
        document.getElementById('waitList').innerHTML = merchList.map((item, index) => ({item, index}))
            .filter(o => o.item.status === 'éç¾è²¨')
            .map(o => genHTML(o.item, o.index)).join('');
    }

    function markArrived(idx) { merchList[idx].status = 'ç¾è²¨'; save(); renderAll(); }
    
    function editItem(idx) {
        const item = merchList[idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('work').value = item.work || '';
        document.getElementById('role').value = item.role;
        document.getElementById('pattern').value = item.pattern || '';
        document.getElementById('type').value = item.type || '';
        document.getElementById('name').value = item.name;
        document.getElementById('status').value = item.status;
        document.getElementById('qty').value = item.qty;
        document.getElementById('currency').value = item.originalCur;
        document.getElementById('inputPrice').value = item.originalPrice;
        document.getElementById('buyDate').value = item.buyDate || '';
        document.getElementById('arrivalDate').value = item.arrivalDate || '';
        
        toggleArrivalDate(item.status);
        document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯ä¸­...";
        document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™";
        document.getElementById('cancelBtn').style.display = "block";
        switchTab('page-recent', document.querySelector(`[onclick*="page-recent"]`));
    }

    function resetForm() {
        document.getElementById('merchForm').reset();
        document.getElementById('editIndex').value = "-1";
        document.getElementById('formTitle').innerText = "ğŸ“ ç´€éŒ„æˆå“¡";
        document.getElementById('submitBtn').innerText = "ç¢ºèªå­˜æª”";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('arrivalGroup').style.display = "none";
    }

    function deleteItem(idx) { if(confirm('åˆªé™¤ï¼Ÿ')) { merchList.splice(idx,1); save(); renderAll(); } }
    function save() { localStorage.setItem('mm25_morandi_v10', JSON.stringify(merchList)); }

    document.getElementById('merchForm').onsubmit = function(e) {
        e.preventDefault();
        const editIdx = parseInt(document.getElementById('editIndex').value);
        const cur = document.getElementById('currency').value;
        const price = parseFloat(document.getElementById('inputPrice').value);
        const qty = parseInt(document.getElementById('qty').value);
        const totalHkd = (price * rates[cur] * qty).toFixed(2);
        const file = document.getElementById('imgFile').files[0];

        const doSave = (b64) => {
            const data = {
                work: document.getElementById('work').value,
                role: document.getElementById('role').value,
                pattern: document.getElementById('pattern').value,
                type: document.getElementById('type').value,
                name: document.getElementById('name').value,
                status: document.getElementById('status').value,
                qty: qty,
                originalPrice: price,
                originalCur: cur,
                totalHkd: totalHkd,
                buyDate: document.getElementById('buyDate').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                img: b64 || (editIdx !== -1 ? merchList[editIdx].img : null)
            };
            if(editIdx === -1) merchList.unshift(data); else merchList[editIdx] = data;
            save(); resetForm(); renderAll(); alert('å­˜æª”æˆåŠŸï¼');
            switchTab('page-gallery', document.querySelector(`[onclick*="page-gallery"]`));
        };

        if(file) { const r = new FileReader(); r.onload = () => doSave(r.result); r.readAsDataURL(file); }
        else doSave(null);
    };

    function renderStats() {
        let total = 0, charData = {}, monthData = {};
        merchList.forEach(i => {
            const v = parseFloat(i.totalHkd); total += v;
            charData[i.role] = (charData[i.role] || 0) + v;
            if(i.buyDate) { const m = i.buyDate.substring(0, 7); monthData[m] = (monthData[m] || 0) + v; }
        });
        document.getElementById('totalSpend').innerText = `HKD ${total.toLocaleString()}`;
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('charPieChart').getContext('2d'), {
            type: 'pie',
            data: { labels: Object.keys(charData), datasets: [{ data: Object.values(charData), backgroundColor: ['#92a8d1', '#acc1ad', '#d5cabd', '#b5b5b5', '#e1bee7'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        document.getElementById('monthlyStats').innerHTML = Object.keys(monthData).sort().reverse().map(m => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee;"><span>${m}</span><b>HK$ ${monthData[m].toLocaleString()}</b></div>`).join('');
    }

    renderAll();
</script>
</body>
</html>
