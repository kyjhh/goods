<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Morandi Archive - Master V47</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --m-deep-green: #6b7a63; --m-sage: #acc1ad; --m-brown: #a68b7c;
    --m-sand: #d5cabd; --m-clay: #e5ddd5; --bg: #f2efeb;
    --text: #4a4a4a; --radius: 8px; --dynamic-grid: 160px;
}
body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
#batch-panel { display: none; background: var(--m-deep-green); color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 2500; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: 0.3s; }
.batch-btn { background: #cc9999; border: none; color: white; padding: 6px 15px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: bold; }
.edit-toggle-btn { font-size: 11px; color: var(--m-deep-green); border: 1px solid var(--m-deep-green); padding: 3px 10px; border-radius: 6px; cursor: pointer; margin-left: 10px; font-weight: bold; transition: 0.2s; }
#cover-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d2cdc1; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
#cover-page.open { transform: translateY(-100%); }
.cover-upload-btn { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2100; border: 1px solid rgba(255,255,255,0.3); }
.cover-menu { width: 160px; margin-bottom: 70px; display: flex; flex-direction: column; gap: 8px; }
.menu-btn { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(12px); padding: 14px; text-align: center; cursor: pointer; border-radius: var(--radius); font-size: 11px; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.2); }
.nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 5px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); z-index: 1000; transition: bottom 0.3s; }
.nav-item { border: none; background: none; color: #b5b5b5; font-size: 10px; font-weight: 600; cursor: pointer; padding: 10px; flex-grow: 1; text-align: center; }
.nav-item.active { color: var(--m-deep-green); }
.main-content { padding: 25px; padding-bottom: 120px; max-width: 800px; margin: 0 auto; transition: margin-top 0.3s; }
.page { display: none; }
.page.active { display: block; }
.control-panel { background: #fff; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--m-clay); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
.symbol-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; }
.symbol-group { display: flex; gap: 12px; color: #ccc; align-items: center; }
.symbol-btn { cursor: pointer; transition: color 0.3s; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 2px; }
.symbol-btn svg { width: 18px; height: 18px; fill: currentColor; }
.symbol-btn span { font-size: 8px; font-weight: bold; }
.symbol-btn.active { color: var(--m-deep-green); }
.order-toggle { font-size: 11px; font-weight: bold; padding: 4px 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; color: var(--m-brown); background: #fafafa; }
.search-input { margin-bottom: 12px; padding: 10px 12px; font-size: 12px; border: 1px solid #eee; background: #fafafa; border-radius: 6px; width: 100%; box-sizing: border-box; outline: none; }
.filter-row { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; margin-bottom: 10px; scrollbar-width: none; }
.filter-chip { background: var(--m-clay); padding: 6px 14px; border-radius: 15px; font-size: 11px; cursor: pointer; color: #8a8a8a; user-select: none; transition: 0.2s; }
.filter-chip.active { background: var(--m-sage); color: white; }
.count-tag { font-size: 10px; color: #aaa; text-align: right; margin-bottom: 5px; }
.list-container.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr)); gap: 15px; }
.list-container.list { display: flex; flex-direction: column; gap: 12px; }
.item-card { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--m-clay); user-select: none; display: flex; flex-direction: column; cursor: pointer; position: relative; transition: 0.2s; }
.item-card.selected { border: 3px solid var(--m-deep-green); transform: scale(0.96); }
.item-card.selected::after { content: "âœ“"; position: absolute; top: 10px; right: 10px; background: var(--m-deep-green); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 10; }
.list .item-card { flex-direction: row; height: 95px; }
.list .img-box { width: 95px; height: 95px; }
.img-box { width: 100%; aspect-ratio: 1; background: #f5f5f5; pointer-events: none; }
.img-box img { width: 100%; height: 100%; object-fit: cover; }
.info { padding: 10px; flex-grow: 1; overflow: hidden; pointer-events: none; }
.input-group { margin-bottom: 15px; }
.input-label { font-size: 11px; color: var(--m-brown); font-weight: bold; margin-bottom: 5px; display: block; }
.btn-main { background: var(--m-deep-green); color: white; border: none; padding: 15px; width: 100%; font-size: 13px; cursor: pointer; border-radius: var(--radius); margin-top: 15px; font-weight: bold; }
input, select, textarea { width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid var(--m-clay); background: #fafafa; font-size: 14px; box-sizing: border-box; outline: none; }
#success-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 15px; text-align: center; z-index: 9999; display: none; width: 240px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); }
.overlay { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9998; display: none; backdrop-filter: blur(3px); }
.stat-card { background:#fff; padding:20px; border-radius:var(--radius); border:1px solid var(--m-clay); margin-bottom: 20px; }
.stat-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 15px; border-left: 4px solid var(--m-sage); padding-left: 10px; }
</style>
</head>
<body>
<div id="batch-panel">
    <span id="batch-count" style="font-weight: bold;">å·²é¸æ“‡0é …</span>
    <div>
        <span onclick="setBatchMode(false)" style="cursor:pointer; margin-right:20px; font-size:14px; font-weight: bold;">å–æ¶ˆ</span>
        <button class="batch-btn" onclick="confirmBatchDelete()">åˆªé™¤é¸ä¸­</button>
    </div>
</div>
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="success-modal">
    <div id="modal-icon" style="font-size: 40px; margin-bottom: 15px; color: var(--m-deep-green);"></div>
    <div id="modal-text" style="font-weight: bold; font-size: 16px;">æ“ä½œæˆåŠŸ</div>
    <button class="btn-main" onclick="closeModal()" style="margin-top: 25px;">ç¢ºå®š</button>
</div>

<div id="cover-page">
    <div class="cover-upload-btn" onclick="document.getElementById('coverInput').click()">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--m-deep-green)"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>
    </div>
    <input type="file" id="coverInput" style="display:none;" accept="image/*" onchange="updateCover(this)">
    <div class="cover-menu">
        <h4 style="text-align:center; font-weight:400; letter-spacing:6px; margin-bottom:25px; color: var(--m-deep-green);">M.ARCHIVE</h4>
        <div class="menu-btn" onclick="openPage('page-gallery')">åœ–æ›¸é¤¨</div>
        <div class="menu-btn" onclick="openPage('page-pending')">ç­‰å€™å€</div>
        <div class="menu-btn" onclick="openPage('page-wish')">é¡˜æœ›æ¸…å–®</div>
        <div class="menu-btn" onclick="openPage('page-stats')">æ•¸æ“šçµ±è¨ˆ</div>
        <div class="menu-btn" onclick="resetFormForNew(); openPage('page-recent')">æ–°å¢è—å“</div>
        <div class="menu-btn" onclick="openPage('page-settings')">ç³»çµ±è¨­å®š</div>
    </div>
</div>

<div class="main-content" id="main-content">
    <div id="back-btn" onclick="closePage()" style="font-size:11px; color: var(--m-brown); cursor:pointer; margin-bottom:25px; font-weight: bold;">â† è¿”å›é¦–é </div>
    
    <div id="page-gallery" class="page">
        <div class="control-panel">
            <input type="text" class="search-input" id="lib-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div class="symbol-row">
                <div class="symbol-group">
                    <span class="symbol-btn sort-date" onclick="setSort('date')">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg><span>æ™‚é–“</span>
                    </span>
                    <span class="symbol-btn sort-price" onclick="setSort('price')">
                        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 2.01-1.79 2.7-1.79 2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><span>é‡‘é¡</span>
                    </span>
                    <span class="symbol-btn sort-name" onclick="setSort('name')">
                        <svg viewBox="0 0 24 24"><path d="M12.75 3h-1.5L6.5 14h1.5l1.12-3h5.75l1.12 3h1.5L12.75 3zm-3.13 6.5L12 3.25l2.38 6.25H9.62zM18 17H6v2h12v-2z"/></svg><span>åç¨±</span>
                    </span>
                    <span class="symbol-btn sort-qty" onclick="setSort('qty')">
                        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg><span>æ•¸é‡</span>
                    </span>
                    <span class="order-toggle" onclick="toggleOrder()">å€’åºâ†“</span>
                </div>
                <div class="symbol-group">
                    <span class="symbol-btn view-grid" onclick="setView('grid')"><svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm7 0h5v-6h-5v6zm0-13v6h5V5h-5z"/></svg></span>
                    <span class="symbol-btn view-list" onclick="setView('list')"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg></span>
                </div>
            </div>
            <div id="lib-filter-box"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div id="lib-count" class="count-tag" style="margin:0;">é¡¯ç¤º:0/0</div>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="readyList" class="list-container grid"></div>
    </div>

    <div id="page-pending" class="page">
        <div class="control-panel">
            <input type="text" class="search-input" id="wait-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div id="wait-filter-box"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div id="wait-count" class="count-tag" style="margin: 0;">é¡¯ç¤º: 0/0</div>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="waitList" class="list-container grid"></div>
    </div>

    <div id="page-wish" class="page">
        <div class="control-panel">
            <input type="text" class="search-input" id="wish-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div id="wish-filter-box"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <div id="wish-count" class="count-tag" style="margin: 0;">é¡¯ç¤º:0/0</div>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="wishList" class="list-container grid"></div>
    </div>

    <div id="page-recent" class="page">
        <div style="background:#fff; padding:25px; border-radius: var(--radius); border:1px solid var(--m-clay);">
            <form id="merchForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="input-group"><label class="input-label">ä½œå“åç¨±</label><select id="workSelect" onchange="toggleInput('workSelect', 'workInput')"></select><input type="text" id="workInput" style="display:none;" placeholder="è¼¸å…¥æ–°ä½œå“åç¨±"></div>
                <div class="input-group"><label class="input-label">è§’è‰²åç¨±</label><select id="roleSelect" onchange="toggleInput('roleSelect', 'roleInput')"></select><input type="text" id="roleInput" style="display:none;" placeholder="è¼¸å…¥æ–°è§’è‰²åç¨±"></div>
                <div class="input-group"><label class="input-label">è—å“é¡åˆ¥</label><select id="typeSelect" onchange="toggleInput('typeSelect', 'typeInput')"></select><input type="text" id="typeInput" style="display:none;" placeholder="å¾½ç« /ç«‹ç‰Œ/ç‰¹å…¸"></div>
                <div class="input-group"><label class="input-label">æ¬¾å¼åç¨±</label><input type="text" id="pattern" required> </div>
                <div class="input-group"><label class="input-label">å‚™è¨»</label><textarea id="note"></textarea></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 15px;">
                    <div><label class="input-label">ç‹€æ…‹</label><select id="status" onchange="updateDateLabel()"><option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option><option value="é¡˜æœ›">é¡˜æœ›</option></select></div>
                    <div><label class="input-label">æ•¸é‡</label><input type="number" id="qty" value="1" min="1"></div>
                </div>
                <div class="input-group"><label class="input-label" id="dateLabel">è³¼è²·æ—¥æœŸ(é¸å¡«)</label><input type="date" id="buyDate"></div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px; margin-bottom: 8px;">
                    <div><label class="input-label">å¹£ç¨®</label><select id="currency" onchange="liveExchange()"><option value="HKD">HKD</option><option value="RMB">RMB</option><option value="JPY">JPY</option></select></div>
                    <div><label class="input-label">å–®åƒ¹</label><input type="number" id="inputPrice" step="0.01" value="0" oninput="liveExchange()"></div>
                </div>
                <div id="exchangePreview" style="margin-bottom: 15px; font-size:12px; color:var(--m-deep-green); font-weight:bold;">ç¸½é¡: HKD 0.00</div>
                <div class="input-group"><label class="input-label">è—å“ç…§ç‰‡</label><input type="file" id="imgFile" accept="image/*"></div>
                <button type="submit" class="btn-main" id="submitBtn">å„²å­˜è‡³è³‡æ–™åº«</button>
                <button type="button" id="delBtn" class="btn-main" style="background:#cc9999; display:none;" onclick="deleteCurrentItem()">åˆªé™¤å–®é …è—å“</button>
            </form>
        </div>
    </div>

    <div id="page-stats" class="page">
        <div class="stat-card"><div class="stat-title">æ¯æœˆæ”¯å‡ºèµ°å‹¢(HKD)</div><canvas id="monthlyChart"></canvas></div>
        <div class="stat-card"><div class="stat-title">ä½œå“ä½”æ¯”åˆ†æ</div><canvas id="workChart"></canvas></div>
        <div class="stat-card"><div class="stat-title">è§’è‰²æ”¯å‡ºæ’è¡Œ</div><canvas id="roleChart"></canvas></div>
    </div>

    <div id="page-settings" class="page">
        <div class="stat-card">
            <label class="input-label">ç¶²æ ¼å¤§å°: <span id="gridVal">160</span>px</label>
            <input type="range" id="gridRange" min="120" max="220" value="160" oninput="updateGridSize(this.value)">
            <hr style="border: 0.5px solid #f0f0f0; margin: 25px 0;">
            <button onclick="exportData()" class="btn-main" style="background:var(--m-brown);">åŒ¯å‡ºè³‡æ–™å‚™ä»½(.json)</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
            <button onclick="document.getElementById('importFile').click()" class="btn-main" style="background:var(--m-sage); margin-top: 10px;">åŒ¯å…¥è³‡æ–™å‚™ä»½</button>
        </div>
    </div>
</div>

<nav class="nav-bar" id="bottom-nav" style="display:none;">
    <button class="nav-item active" onclick="switchTab('page-gallery', this)">é¤¨è—</button>
    <button class="nav-item" onclick="switchTab('page-pending', this)">ç­‰å€™</button>
    <button class="nav-item" onclick="switchTab('page-wish', this)">é¡˜æœ›</button>
    <button class="nav-item" onclick="resetFormForNew(); switchTab('page-recent', this)">æ–°å¢</button>
    <button class="nav-item" onclick="switchTab('page-stats', this)">æ•¸æ“š</button>
    <button class="nav-item" onclick="switchTab('page-settings', this)">è¨­å®š</button>
</nav>

<script>
const STORAGE_KEY = 'archive_master'; 
const DICT_KEY = 'archive_dict_master';
const COVER_KEY = 'archive_cover_bg';
const DEFAULT_WORKS = ['ä¸–ç•Œè¨ˆç•«', 'Vå®¶', 'Alien Stage'];
const DEFAULT_TYPES = ['è¥Ÿ','è‰²ç´™','æ›ä»¶','ç«‹ç‰Œ', 'æ‹ç«‹å¾—'];

let merchList = [], dict = { works: [], roles: [], types: [] }, filters = { work: 'all', role: 'all', type: 'all' };
let sortMode = 'date', sortDesc = true, viewMode = 'grid', charts = {};
let isBatchMode = false, selectedIndices = [];

// å£“ç¸®åœ–ç‰‡å‡½æ•¸ (æ–°å¢)
function compressImage(base64, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const compressed = canvas.toDataURL('image/jpeg', quality);
            resolve(compressed);
        };
    });
}

function init() {
    merchList = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    dict = JSON.parse(localStorage.getItem(DICT_KEY)) || { works: [], roles: [], types: [] };
    const savedCover = localStorage.getItem(COVER_KEY);
    if (savedCover) document.getElementById('cover-page').style.backgroundImage = `url(${savedCover})`;
    updateGridSize(localStorage.getItem('archive_grid_size') || '160');
    renderSelects(); 
    renderFilters(); 
    renderAll(); 
    updateToolUI();
}

function save() { 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merchList)); 
    localStorage.setItem(DICT_KEY, JSON.stringify(dict)); 
}

function showModal(icon, text) {
    document.getElementById('modal-icon').innerText = icon;
    document.getElementById('modal-text').innerText = text;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('success-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('success-modal').style.display = 'none';
}

function updateDateLabel() {
    const status = document.getElementById('status').value;
    const label = document.getElementById('dateLabel');
    if (status === 'éç¾è²¨') label.innerText='é è¨ˆç™¼å”®æ—¥æœŸ(é¸å¡«)';
    else if (status === 'é¡˜æœ›') label.innerText='ç™¼ç¾æ—¥æœŸ(é¸å¡«)';
    else label.innerText='è³¼è²·æ—¥æœŸ(é¸å¡«)';
}

function setBatchMode(on) {
    isBatchMode = on; selectedIndices = [];
    document.getElementById('batch-panel').style.display = isBatchMode? 'flex': 'none';
    document.getElementById('bottom-nav').style.bottom = isBatchMode? '-100px': '25px';
    document.getElementById('main-content').style.marginTop = isBatchMode? '50px': '0px';
    renderAll();
}

function toggleSelectItem(idx) {
    const sIdx = selectedIndices.indexOf(idx);
    if (sIdx > -1) selectedIndices.splice(sIdx, 1); else selectedIndices.push(idx);
    document.getElementById('batch-count').innerText = `å·²é¸æ“‡${selectedIndices.length}é …`;
    renderAll();
}

function confirmBatchDelete() {
    if (selectedIndices.length === 0) return;
    if (confirm(`ç¢ºå®šåˆªé™¤é¸ä¸­çš„${selectedIndices.length}å€‹è—å“å—?`)) {
        selectedIndices.sort((a, b) => b - a).forEach(idx => merchList.splice(idx, 1));
        save(); updateDictData(); setBatchMode(false);
        setTimeout(() => { showModal("ğŸ—‘ï¸","å·²æ‰¹é‡åˆªé™¤"); }, 150);
    }
}

function updateDictData() {
    dict.works = [...new Set(merchList.map(i => i.work))].filter(w => w && !DEFAULT_WORKS.includes(w)).sort();
    dict.roles = [...new Set(merchList.map(i => i.role))].filter(Boolean).sort();
    dict.types = [...new Set(merchList.map(i => i.type))].filter(t => t && !DEFAULT_TYPES.includes(t)).sort();
    save(); renderSelects(); renderFilters();
}

function renderAll() {
    const conf = { 'ç¾è²¨': 'readyList', 'éç¾è²¨': 'waitList', 'é¡˜æœ›': 'wishList' };
    const srch = { 'ç¾è²¨': 'lib-search', 'éç¾è²¨': 'wait-search', 'é¡˜æœ›': 'wish-search' };
    Object.keys(conf).forEach(status => {
        const container = document.getElementById(conf[status]); if(!container) return;
        const sVal = document.getElementById(srch[status]) ? document.getElementById(srch[status]).value.toLowerCase() : "";
        let filtered = merchList.map((item, index) => ({...item, originalIndex: index}))
            .filter(i => i.status === status)
            .filter(i => (filters.work==='all' || i.work===filters.work) && (filters.role==='all' || i.role===filters.role) && (filters.type==='all' || i.type===filters.type))
            .filter(i => (i.pattern + (i.note || "") + (i.role || "")).toLowerCase().includes(sVal));

        const multi = sortDesc? 1:-1;
        filtered.sort((a,b) => {
            if(sortMode === 'date') return (b.timestamp - a.timestamp) * multi;
            if(sortMode === 'price') return (parseFloat(b.totalHkd) - parseFloat(a.totalHkd)) * multi;
            if(sortMode === 'name') return (a.pattern.localeCompare(b.pattern, 'zh-TW')) * multi;
            if(sortMode === 'qty') return (b.qty - a.qty)* multi;
            return 0;
        });

        container.innerHTML = ""; container.className = `list-container ${viewMode}`;
        filtered.forEach(i => {
            const card = document.createElement('div');
            card.className = `item-card ${isBatchMode && selectedIndices.includes(i.originalIndex)? 'selected' : ""}`;
            card.innerHTML = `<div class="img-box"><img src="${i.img || ""}"></div>
                <div class="info">
                    <div style="font-size:9px;color:var(--m-brown);">${i.role || ""} ${i.type? '| '+i.type : ""}</div>
                    <div style="font-weight:bold; font-size:12px; margin:4px 0;">${i.pattern || 'ç„¡å'}</div>
                    <div style="color:var(--m-deep-green); font-size: 11px; font-weight:bold;">HK$ ${i.totalHkd} <span style="color:#aaa;font-weight:normal;font-size:9px;">x${i.qty}</span></div>
                </div>`;
            card.onclick = () => isBatchMode? toggleSelectItem(i.originalIndex): editItem(i.originalIndex);
            handleLongPress(card, () => { if (!isBatchMode) { setBatchMode(true); toggleSelectItem(i.originalIndex); } });
            container.appendChild(card);
        });
        const cld = status==='ç¾è²¨'?'lib-count':(status==='éç¾è²¨'?'wait-count':'wish-count');
        const countLabel = document.getElementById(cld);
        if(countLabel) countLabel.innerText = `é¡¯ç¤º: ${filtered.length} / ${merchList.filter(x=>x.status===status).length}`;
    });
}

function setSort(mode) { sortMode = mode; updateToolUI(); renderAll(); }
function toggleOrder() { sortDesc = !sortDesc; updateToolUI(); renderAll(); }
function setView(v) { viewMode = v; updateToolUI(); renderAll(); }

function updateToolUI() {
    document.querySelectorAll('.symbol-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.sort-'+sortMode).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.view-'+viewMode).forEach(b => b.classList.add('active'));
    document.querySelectorAll('.order-toggle').forEach(b => b.innerText = sortDesc?"å€’åºâ†“":"æ­£åºâ†‘");
}

function renderFilters() {
    const build = (list, key, defaults) => {
        const combined = [...new Set([...defaults, ...list])];
        let row = document.createElement('div'); row.className = 'filter-row';
        let all = document.createElement('div'); all.className = `filter-chip ${filters[key]==='all'?'active':''}`;
        all.innerText = 'å…¨éƒ¨'; all.onclick = () => { filters[key] = 'all'; renderFilters(); renderAll(); };
        row.appendChild(all);
        combined.forEach(item => {
            let chip = document.createElement('div');
            chip.className = `filter-chip ${filters[key]===item?'active':''}`;
            chip.innerText = item;
            chip.onclick = () => { filters[key] = item; renderFilters(); renderAll(); };
            handleLongPress(chip, () => {
                if(confirm(`ç¢ºå®šåˆªé™¤æ¨™ç±¤ã€Œ${item}ã€å—ï¼Ÿ`)) {
                    const dk = key==='work'?'works':(key==='role'?'roles':'types');
                    dict[dk] = dict[dk].filter(x => x !== item);
                    save(); renderFilters(); renderSelects();
                }
            });
            row.appendChild(chip);
        });
        return row;
    };
    ['lib-filter-box', 'wait-filter-box', 'wish-filter-box'].forEach(id => {
        const box = document.getElementById(id); if(!box) return; box.innerHTML = '';
        box.appendChild(build(dict.works, 'work', DEFAULT_WORKS));
        box.appendChild(build(dict.roles, 'role', []));
        box.appendChild(build(dict.types, 'type', DEFAULT_TYPES));
    });
}

function editItem(idx) {
    const i = merchList[idx];
    document.getElementById('editIndex').value = idx;
    document.getElementById('workSelect').value = i.work;
    document.getElementById('roleSelect').value = i.role;
    document.getElementById('typeSelect').value = i.type;
    document.getElementById('pattern').value = i.pattern;
    document.getElementById('note').value = i.note || "";
    document.getElementById('status').value = i.status;
    document.getElementById('qty').value = i.qty;
    document.getElementById('buyDate').value = i.buyDate || "";
    document.getElementById('currency').value = i.currency || "HKD";
    document.getElementById('inputPrice').value = i.price || 0;
    
    document.getElementById('submitBtn').innerText = "æ›´æ–°è—å“è³‡æ–™";
    document.getElementById('delBtn').style.display = 'block';
    liveExchange();
    updateDateLabel();
    switchTab('page-recent');
}

function resetFormForNew() {
    document.getElementById('merchForm').reset();
    document.getElementById('editIndex').value = "-1";
    document.getElementById('submitBtn').innerText = "å„²å­˜è‡³è³‡æ–™åº«";
    document.getElementById('delBtn').style.display = 'none';
    document.getElementById('exchangePreview').innerText = "ç¸½é¡: HKD 0.00";
}

function handleLongPress(element, callback) {
    let timer;
    const start = () => { timer = setTimeout(() => { if (window.navigator.vibrate) window.navigator.vibrate(60); callback(); }, 800); };
    const cancel = () => clearTimeout(timer);
    element.addEventListener('touchstart', start, {passive: true});
    element.addEventListener('touchend', cancel);
    element.addEventListener('mousedown', start);
    element.addEventListener('mouseup', cancel);
}

function switchTab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); btn.classList.add('active'); }
    if(id === 'page-stats') renderStats();
    if(isBatchMode) setBatchMode(false);
}

function openPage(id) {
    document.getElementById('cover-page').classList.add('open');
    document.getElementById('bottom-nav').style.display = 'flex';
    switchTab(id, document.querySelectorAll('.nav-item')[['page-gallery','page-pending','page-wish','page-stats','page-recent','page-settings'].indexOf(id)]);
}

function closePage() {
    document.getElementById('cover-page').classList.remove('open');
    document.getElementById('bottom-nav').style.display = 'none';
}

function toggleInput(sid, iid) {
    const s = document.getElementById(sid);
    const i = document.getElementById(iid);
    i.style.display = (s.value === 'NEW') ? 'block' : 'none';
}

function liveExchange() {
    const rates = { HKD: 1, RMB: 1.1, JPY: 0.053 };
    const c = document.getElementById('currency').value;
    const p = parseFloat(document.getElementById('inputPrice').value) || 0;
    const q = parseInt(document.getElementById('qty').value) || 1;
    const total = (p * rates[c] * q).toFixed(2);
    document.getElementById('exchangePreview').innerText = `ç¸½é¡: HKD ${total}`;
}

// ä¿®æ”¹å¾Œçš„è¡¨å–®æäº¤äº‹ä»¶ï¼ˆåŒ…å«åœ–ç‰‡å£“ç¸®ï¼‰
document.getElementById('merchForm').onsubmit = function(e) {
    e.preventDefault();
    const editIdx = parseInt(document.getElementById('editIndex').value);
    if(document.activeElement) document.activeElement.blur();

    const getV = (sid, iid, dk, def) => {
        let sVal = document.getElementById(sid).value;
        if(sVal === 'NEW') {
            let v = document.getElementById(iid).value.trim();
            if(v && !def.includes(v) && !dict[dk].includes(v)) { dict[dk].push(v); dict[dk].sort(); }
            return v;
        }
        return sVal;
    };

    const work = getV('workSelect', 'workInput', 'works', DEFAULT_WORKS);
    const role = getV('roleSelect', 'roleInput', 'roles', []);
    const type = getV('typeSelect', 'typeInput', 'types', DEFAULT_TYPES);
    const status = document.getElementById('status').value;

    const done = (imgBase64) => {
        const existingImg = (editIdx > -1) ? merchList[editIdx].img : null;
        const data = {
            work, role, type, status,
            pattern: document.getElementById('pattern').value,
            note: document.getElementById('note').value,
            qty: parseInt(document.getElementById('qty').value),
            buyDate: document.getElementById('buyDate').value,
            currency: document.getElementById('currency').value,
            price: parseFloat(document.getElementById('inputPrice').value),
            totalHkd: document.getElementById('exchangePreview').innerText.replace('ç¸½é¡: HKD ', ''),
            img: imgBase64 || existingImg,
            timestamp: (editIdx > -1) ? merchList[editIdx].timestamp : Date.now()
        };

        if(editIdx > -1) merchList[editIdx] = data; else merchList.push(data);
        save(); updateDictData(); renderAll();
        resetFormForNew();
        switchTab('page-gallery', document.querySelectorAll('.nav-item')[0]);
        setTimeout(() => { showModal("âœ¨", editIdx > -1 ? "æ›´æ–°æˆåŠŸ" : "å·²å­˜å…¥åº«"); }, 400);
    };

    const f = document.getElementById('imgFile').files[0];
    if (f) {
        const fr = new FileReader();
        fr.onload = async () => {
            const compressed = await compressImage(fr.result);  // å£“ç¸®åœ–ç‰‡
            done(compressed);
        };
        fr.readAsDataURL(f);
    } else {
        done(null);
    }
};

function deleteCurrentItem() {
    const idx = parseInt(document.getElementById('editIndex').value);
    if(idx > -1 && confirm("ç¢ºå®šåˆªé™¤æ­¤è—å“ï¼Ÿ")) {
        merchList.splice(idx, 1);
        save(); updateDictData(); renderAll();
        resetFormForNew();
        switchTab('page-gallery', document.querySelectorAll('.nav-item')[0]);
    }
}

function renderSelects() {
    const fill = (id, list, defaults) => {
        const s = document.getElementById(id);
        const combined = [...new Set([...defaults, ...list])].sort();
        s.innerHTML = '<option value="">è«‹é¸æ“‡...</option>' + combined.map(x => `<option value="${x}">${x}</option>`).join('') + '<option value="NEW">+ æ–°å¢æ¨™ç±¤</option>';
    };
    fill('workSelect', dict.works, DEFAULT_WORKS);
    fill('roleSelect', dict.roles, []);
    fill('typeSelect', dict.types, DEFAULT_TYPES);
}

function updateGridSize(v) {
    document.documentElement.style.setProperty('--dynamic-grid', v + 'px');
    document.getElementById('gridVal').innerText = v;
    localStorage.setItem('archive_grid_size', v);
}

function updateCover(input) {
    if (input.files && input.files[0]) {
        const fr = new FileReader();
        fr.onload = (e) => {
            document.getElementById('cover-page').style.backgroundImage = `url(${e.target.result})`;
            localStorage.setItem(COVER_KEY, e.target.result);
        };
        fr.readAsDataURL(input.files[0]);
    }
}

function exportData() {
    const data = JSON.stringify({ merchList, dict, cover: localStorage.getItem(COVER_KEY) });
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `archive_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function importData(input) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        merchList = data.merchList || [];
        dict = data.dict || { works: [], roles: [], types: [] };
        if(data.cover) localStorage.setItem(COVER_KEY, data.cover);
        save(); location.reload();
    };
    reader.readAsText(input.files[0]);
}

function renderStats() {
    Object.values(charts).forEach(c => c.destroy());
    const statsList = merchList.filter(i => i.status !== 'é¡˜æœ›');
    const colors = ['#6b7a63', '#acc1ad', '#a68b7c', '#d5cabd', '#e5ddd5', '#c2b2a3'];
    
    // æ”¯å‡ºèµ°å‹¢
    const mData = {}; 
    statsList.forEach(i => { 
        const d = new Date(i.timestamp); 
        const k = `${d.getFullYear()}/${d.getMonth()+1}`; 
        mData[k] = (mData[k] || 0) + parseFloat(i.totalHkd); 
    });
    charts.monthly = new Chart(document.getElementById('monthlyChart'), {
        type: 'line',
        data: { labels: Object.keys(mData), datasets: [{ label: 'HKD', data: Object.values(mData), borderColor: '#6b7a63', tension: 0.3 }] }
    });

    // ä½œå“ä½”æ¯”
    const wData = {}; statsList.forEach(i => { wData[i.work] = (wData[i.work] || 0) + 1; });
    charts.work = new Chart(document.getElementById('workChart'), {
        type: 'doughnut',
        data: { labels: Object.keys(wData), datasets: [{ data: Object.values(wData), backgroundColor: colors }] }
    });

    // è§’è‰²æ’è¡Œ
    const rData = {}; statsList.forEach(i => { rData[i.role] = (rData[i.role] || 0) + parseFloat(i.totalHkd); });
    const rSorted = Object.entries(rData).sort((a,b) => b[1]-a[1]).slice(0, 5);
    charts.role = new Chart(document.getElementById('roleChart'), {
        type: 'bar',
        data: { labels: rSorted.map(x=>x[0]), datasets: [{ label: 'HKD', data: rSorted.map(x=>x[1]), backgroundColor: '#acc1ad' }] },
        options: { indexAxis: 'y' }
    });
}

window.onload = init;
</script>
</body>
                                             </html>
