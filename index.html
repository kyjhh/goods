<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Morandi Archive - æœ€çµ‚ç‰ˆ</title>
<!-- Cropper.js æ¨£å¼èˆ‡è…³æœ¬ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
    --m-deep-green: #6b7a63; --m-sage: #acc1ad; --m-brown: #a68b7c;
    --m-sand: #d5cabd; --m-clay: #e5ddd5; --bg: #f2efeb;
    --text: #4a4a4a; --radius: 8px; --dynamic-grid: 160px;
    --info-scale: 1;
}
body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
#batch-panel { display: none; background: var(--m-deep-green); color: white; padding: 15px 20px; position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 2500; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: 0.3s; }
.batch-btn { background: #cc9999; border: none; color: white; padding: 6px 15px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: bold; }
.edit-toggle-btn { font-size: 11px; color: var(--m-deep-green); border: 1px solid var(--m-deep-green); padding: 3px 10px; border-radius: 6px; cursor: pointer; margin-left: 10px; font-weight: bold; transition: 0.2s; }
#cover-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d2cdc1; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
#cover-page.open { transform: translateY(-100%); }
.cover-upload-btn { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2100; border: 1px solid rgba(255,255,255,0.3); }
.cover-menu { width: 160px; margin-bottom: 70px; display: flex; flex-direction: column; gap: 8px; }
.menu-btn { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(12px); padding: 14px; text-align: center; cursor: pointer; border-radius: var(--radius); font-size: 11px; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.2); }
.nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 5px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); z-index: 1000; transition: bottom 0.3s; }
.nav-item { border: none; background: none; color: #b5b5b5; font-size: 10px; font-weight: 600; cursor: pointer; padding: 10px; flex-grow: 1; text-align: center; }
.nav-item.active { color: var(--m-deep-green); }
.main-content { padding: 25px; padding-bottom: 120px; max-width: 800px; margin: 0 auto; transition: margin-top 0.3s; }
.page { display: none; }
.page.active { display: block; }
/* é é¢é ‚æ¬„ */
.page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
.back-btn-header { font-size: 20px; cursor: pointer; color: var(--m-brown); width: 40px; text-align: left; }
.page-title { font-size: 18px; font-weight: bold; color: var(--m-deep-green); text-align: center; flex: 1; }
.control-panel { background: #fff; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--m-clay); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
.symbol-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; }
.symbol-group { display: flex; gap: 12px; color: #ccc; align-items: center; }
.symbol-btn { cursor: pointer; transition: color 0.3s; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 2px; }
.symbol-btn svg { width: 18px; height: 18px; fill: currentColor; }
.symbol-btn span { font-size: 8px; font-weight: bold; }
.symbol-btn.active { color: var(--m-deep-green); }
.order-toggle { font-size: 11px; font-weight: bold; padding: 4px 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; color: var(--m-brown); background: #fafafa; }
.search-input { margin-bottom: 12px; padding: 10px 12px; font-size: 12px; border: 1px solid #eee; background: #fafafa; border-radius: 6px; width: 100%; box-sizing: border-box; outline: none; }
.filter-row { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; margin-bottom: 10px; scrollbar-width: none; }
.filter-chip { background: var(--m-clay); padding: 6px 14px; border-radius: 15px; font-size: 11px; cursor: pointer; color: #8a8a8a; user-select: none; transition: 0.2s; }
.filter-chip.active { 
    background: var(--m-sage); 
    color: white; 
    box-shadow: 0 0 0 2px var(--m-deep-green);
}
.count-tag { font-size: 10px; color: #aaa; text-align: right; margin-bottom: 5px; }
/* é–“è·æ¸›åŠ */
.list-container.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr)); gap: 7px; }
.list-container.list { display: flex; flex-direction: column; gap: 7px; }
.list-container.list .item-card { min-height: 95px; height: auto; flex-direction: row; }
.list-container.list .img-box { width: 95px; height: 95px; flex-shrink: 0; }
.list-container.list .info { padding: 10px; overflow: hidden; }
.list-container.list .note { display: block; font-size: calc(9px * var(--info-scale)); color: #999; margin-top: calc(4px * var(--info-scale)); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-container.image {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr));
    gap: 7px;
}
.list-container.image .item-card .info {
    display: none;
}
.item-card { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--m-clay); user-select: none; display: flex; flex-direction: column; cursor: pointer; position: relative; transition: 0.2s; }
.item-card.selected { border: 3px solid var(--m-deep-green); transform: scale(0.96); }
.item-card.selected::after { content: "âœ“"; position: absolute; top: 10px; right: 10px; background: var(--m-deep-green); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; z-index: 10; }
.img-box { width: 100%; aspect-ratio: 1; background: #f5f5f5; pointer-events: none; }
.img-box img { width: 100%; height: 100%; object-fit: cover; }
/* å¡ç‰‡å…§æ•¸é‡æ¨£å¼ï¼ˆç¶²æ ¼æ¨¡å¼ï¼‰ */
.card-qty {
    position: absolute;
    bottom: 8px;
    right: 10px;
    font-size: calc(12px * var(--info-scale,1));
    color: var(--m-deep-green);
    font-weight: bold;
    z-index: 2;
}
.info { padding: 10px; flex-grow: 1; overflow: hidden; pointer-events: none; }
.info .note { display: none; }

/* æ–°å¢é è¡Œè·æ¸›åŠï¼Œè¼¸å…¥æ¡†é«˜åº¦å†æ¸›2ï¼ˆ6pxï¼‰ */
.input-group { margin-bottom: 5px; }
.input-label { font-size: 11px; color: var(--m-brown); font-weight: bold; margin-bottom: 5px; display: block; }
#exchangePreview { margin-bottom: 8px; }
.btn-main { background: var(--m-deep-green); color: white; border: none; padding: 12px; width: 100%; font-size: 13px; cursor: pointer; border-radius: var(--radius); margin-top: 5px; font-weight: bold; }
input, select, textarea { width: 100%; padding: 6px; border-radius: var(--radius); border: 1px solid var(--m-clay); background: #fafafa; font-size: 14px; box-sizing: border-box; outline: none; }

#success-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 15px; text-align: center; z-index: 9999; display: none; width: 240px; box-shadow: 0 10px 50px rgba(0,0,0,0.3); }
.overlay { position: fixed; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9998; display: none; backdrop-filter: blur(3px); }

/* éæ¿¾æ¨¡æ…‹æ¡† */
.filter-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: var(--radius); z-index: 10000; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; }
.filter-modal .filter-section { margin-bottom: 20px; }
.filter-modal .filter-section-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 10px; border-left: 4px solid var(--m-sage); padding-left: 8px; }
.filter-modal .filter-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px; }
.filter-modal .filter-chip { margin: 2px; }
.filter-modal .close-btn { background: var(--m-clay); border: none; padding: 10px; width: 100%; border-radius: var(--radius); font-size: 13px; cursor: pointer; margin-top: 10px; }

/* è£å‰ª/æ”¾å¤§æ¨¡æ…‹æ¡† */
.crop-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: var(--radius); z-index: 10000; width: 90%; max-width: 600px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column; }
.crop-modal .crop-container { max-height: 60vh; overflow: hidden; margin-bottom: 15px; }
.crop-modal .crop-image { max-width: 100%; display: block; }
.crop-modal .crop-actions { display: flex; gap: 10px; }
.crop-modal .crop-btn { flex: 1; background: var(--m-deep-green); color: white; border: none; padding: 12px; border-radius: var(--radius); font-size: 13px; cursor: pointer; }
.crop-modal .cancel-btn { background: var(--m-clay); color: var(--text); }

/* æ¨™ç±¤å³éµé¸å–® */
.tag-context-menu {
    position: fixed;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 5px 0;
    z-index: 10001;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none;
}
.tag-context-menu div {
    padding: 10px 20px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text);
}
.tag-context-menu div:hover {
    background: var(--m-clay);
}

.stat-card { background:#fff; padding:20px; border-radius:var(--radius); border:1px solid var(--m-clay); margin-bottom: 20px; position: relative; }
.stat-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 15px; border-left: 4px solid var(--m-sage); padding-left: 10px; }
.total-expense { position: absolute; top: 20px; right: 20px; background: var(--m-sage); color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; }
/* æ–°å¢åœ–ç‰‡æç¤º */
.image-pending-note { font-size: 11px; color: var(--m-deep-green); margin-top: 5px; font-weight: bold; }
/* æ¢ä»¶æª¢ç´¢æŒ‰éˆ•ï¼ˆåº•éƒ¨ï¼‰ */
.filter-btn-bottom {
    background: var(--m-clay);
    border: none;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--text);
    cursor: pointer;
    white-space: nowrap;
}
/* è‡ªè¨‚æ»‘æ¡¿æ¨£å¼ï¼Œèåˆä¸»é¡Œ */
.grid-range-slider {
    -webkit-appearance: none;
    width: 80px;
    height: 4px;
    background: var(--m-clay);
    border-radius: 2px;
    outline: none;
}
.grid-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--m-deep-green);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.grid-range-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--m-deep-green);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.grid-range-slider::-moz-range-track {
    height: 4px;
    background: var(--m-clay);
    border-radius: 2px;
}
</style>
</head>
<body>
<div id="batch-panel">
    <span id="batch-count" style="font-weight: bold;">å·²é¸æ“‡0é …</span>
    <div>
        <span onclick="setBatchMode(false)" style="cursor:pointer; margin-right:20px; font-size:14px; font-weight: bold;">å–æ¶ˆ</span>
        <button class="batch-btn" onclick="confirmBatchDelete()">åˆªé™¤é¸ä¸­</button>
    </div>
</div>
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="success-modal">
    <div id="modal-icon" style="font-size: 40px; margin-bottom: 15px; color: var(--m-deep-green);"></div>
    <div id="modal-text" style="font-weight: bold; font-size: 16px;">æ“ä½œæˆåŠŸ</div>
    <button class="btn-main" onclick="closeModal()" style="margin-top: 25px;">ç¢ºå®š</button>
</div>

<!-- éæ¿¾æ¢ä»¶æ¨¡æ…‹æ¡† -->
<div class="filter-modal" id="filterModal">
    <div id="filterModalContent"></div>
    <button class="close-btn" onclick="closeFilterModal()">é—œé–‰</button>
</div>

<!-- è£å‰ª/æ”¾å¤§æ¨¡æ…‹æ¡†ï¼ˆå…±ç”¨ï¼‰ -->
<div class="crop-modal" id="cropModal">
    <div class="crop-container">
        <img id="cropImage" class="crop-image" src="">
    </div>
    <div class="crop-actions">
        <button class="crop-btn" id="cropConfirmBtn" style="display: none;">ç¢ºèªè£å‰ª</button>
        <button class="crop-btn cancel-btn" onclick="closeCropModal()">é—œé–‰</button>
    </div>
</div>

<!-- æ¨™ç±¤é•·æŒ‰é¸å–® -->
<div class="tag-context-menu" id="tagContextMenu">
    <div onclick="editTagFromMenu()">ç·¨è¼¯æ¨™ç±¤</div>
    <div onclick="deleteTagFromMenu()">åˆªé™¤æ¨™ç±¤</div>
</div>

<div id="cover-page">
    <div class="cover-upload-btn" onclick="document.getElementById('coverInput').click()">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="var(--m-deep-green)"><path d="M4 4h3l2-2h6l2 2h3a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm8 3a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"/></svg>
    </div>
    <input type="file" id="coverInput" style="display:none;" accept="image/*" onchange="updateCover(this)">
    <div class="cover-menu">
        <h4 style="text-align:center; font-weight:400; letter-spacing:6px; margin-bottom:25px; color: var(--m-deep-green);">M.ARCHIVE</h4>
        <div class="menu-btn" onclick="openPage('page-gallery')">é€²å…¥è—å“åº«</div>
        <div class="menu-btn" onclick="triggerQuickUpload()">ä¸Šè¼‰è—å“</div>
    </div>
    <input type="file" id="quickUploadInput" style="display:none;" accept="image/*" onchange="handleQuickUploadFile(this)">
</div>

<div class="main-content" id="main-content">
    <!-- é¤¨è—é  -->
    <div id="page-gallery" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title">é¤¨è—</div>
        </div>
        <div class="control-panel">
            <input type="text" class="search-input" id="lib-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div class="symbol-row">
                <div class="symbol-group">
                    <span class="symbol-btn sort-date" onclick="setSort('date')">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg><span>æ™‚é–“</span>
                    </span>
                    <span class="symbol-btn sort-price" onclick="setSort('price')">
                        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 2.01-1.79 2.7-1.79 2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><span>é‡‘é¡</span>
                    </span>
                    <span class="symbol-btn sort-name" onclick="setSort('name')">
                        <svg viewBox="0 0 24 24"><path d="M12.75 3h-1.5L6.5 14h1.5l1.12-3h5.75l1.12 3h1.5L12.75 3zm-3.13 6.5L12 3.25l2.38 6.25H9.62zM18 17H6v2h12v-2z"/></svg><span>åç¨±</span>
                    </span>
                    <span class="symbol-btn sort-qty" onclick="setSort('qty')">
                        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg><span>æ•¸é‡</span>
                    </span>
                    <span class="order-toggle" onclick="toggleOrder()">å€’åºâ†“</span>
                </div>
                <div class="symbol-group">
                    <span class="symbol-btn view-grid" onclick="setView('grid')"><svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm7 0h5v-6h-5v6zm0-13v6h5V5h-5z"/></svg></span>
                    <span class="symbol-btn view-list" onclick="setView('list')"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg></span>
                    <span class="symbol-btn view-image" onclick="setView('image')"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><span>åœ–ç‰‡</span></span>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px;">
                <div id="lib-count" class="count-tag" style="margin:0;">é¡¯ç¤º:0/0</div>
                <input type="range" class="grid-range-slider" min="50" max="170" value="160" oninput="handleGridSliderInput(this)">
                <button class="filter-btn-bottom" onclick="openFilterModal('ç¾è²¨')">æ¢ä»¶æª¢ç´¢</button>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="readyList" class="list-container grid"></div>
    </div>

    <!-- ç­‰å€™å€é  -->
    <div id="page-pending" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title">ç­‰å€™å€</div>
        </div>
        <div class="control-panel">
            <input type="text" class="search-input" id="wait-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div class="symbol-row">
                <div class="symbol-group">
                    <span class="symbol-btn sort-date" onclick="setSort('date')">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg><span>æ™‚é–“</span>
                    </span>
                    <span class="symbol-btn sort-price" onclick="setSort('price')">
                        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 2.01-1.79 2.7-1.79 2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><span>é‡‘é¡</span>
                    </span>
                    <span class="symbol-btn sort-name" onclick="setSort('name')">
                        <svg viewBox="0 0 24 24"><path d="M12.75 3h-1.5L6.5 14h1.5l1.12-3h5.75l1.12 3h1.5L12.75 3zm-3.13 6.5L12 3.25l2.38 6.25H9.62zM18 17H6v2h12v-2z"/></svg><span>åç¨±</span>
                    </span>
                    <span class="symbol-btn sort-qty" onclick="setSort('qty')">
                        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg><span>æ•¸é‡</span>
                    </span>
                    <span class="order-toggle" onclick="toggleOrder()">å€’åºâ†“</span>
                </div>
                <div class="symbol-group">
                    <span class="symbol-btn view-grid" onclick="setView('grid')"><svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm7 0h5v-6h-5v6zm0-13v6h5V5h-5z"/></svg></span>
                    <span class="symbol-btn view-list" onclick="setView('list')"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg></span>
                    <span class="symbol-btn view-image" onclick="setView('image')"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><span>åœ–ç‰‡</span></span>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px;">
                <div id="wait-count" class="count-tag" style="margin:0;">é¡¯ç¤º:0/0</div>
                <input type="range" class="grid-range-slider" min="50" max="170" value="160" oninput="handleGridSliderInput(this)">
                <button class="filter-btn-bottom" onclick="openFilterModal('éç¾è²¨')">æ¢ä»¶æª¢ç´¢</button>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="waitList" class="list-container grid"></div>
    </div>

    <!-- é¡˜æœ›æ¸…å–®é  -->
    <div id="page-wish" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title">é¡˜æœ›æ¸…å–®</div>
        </div>
        <div class="control-panel">
            <input type="text" class="search-input" id="wish-search" placeholder="æœå°‹æ¬¾å¼æˆ–å‚™è¨»..." oninput="renderAll()">
            <div class="symbol-row">
                <div class="symbol-group">
                    <span class="symbol-btn sort-date" onclick="setSort('date')">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg><span>æ™‚é–“</span>
                    </span>
                    <span class="symbol-btn sort-price" onclick="setSort('price')">
                        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 2.01-1.79 2.7-1.79 2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg><span>é‡‘é¡</span>
                    </span>
                    <span class="symbol-btn sort-name" onclick="setSort('name')">
                        <svg viewBox="0 0 24 24"><path d="M12.75 3h-1.5L6.5 14h1.5l1.12-3h5.75l1.12 3h1.5L12.75 3zm-3.13 6.5L12 3.25l2.38 6.25H9.62zM18 17H6v2h12v-2z"/></svg><span>åç¨±</span>
                    </span>
                    <span class="symbol-btn sort-qty" onclick="setSort('qty')">
                        <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg><span>æ•¸é‡</span>
                    </span>
                    <span class="order-toggle" onclick="toggleOrder()">å€’åºâ†“</span>
                </div>
                <div class="symbol-group">
                    <span class="symbol-btn view-grid" onclick="setView('grid')"><svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm7 0h5v-6h-5v6zm0-13v6h5V5h-5z"/></svg></span>
                    <span class="symbol-btn view-list" onclick="setView('list')"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-10v2h14V7H7z"/></svg></span>
                    <span class="symbol-btn view-image" onclick="setView('image')"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><span>åœ–ç‰‡</span></span>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px;">
                <div id="wish-count" class="count-tag" style="margin:0;">é¡¯ç¤º:0/0</div>
                <input type="range" class="grid-range-slider" min="50" max="170" value="160" oninput="handleGridSliderInput(this)">
                <button class="filter-btn-bottom" onclick="openFilterModal('é¡˜æœ›')">æ¢ä»¶æª¢ç´¢</button>
                <span class="edit-toggle-btn" onclick="setBatchMode(true)">ç·¨è¼¯ç®¡ç†</span>
            </div>
        </div>
        <div id="wishList" class="list-container grid"></div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯é  -->
    <div id="page-recent" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title" id="recent-page-title">æ–°å¢è—å“</div>
            <div style="width:40px;"></div>
        </div>
        <div style="background:#fff; padding:15px; border-radius: var(--radius); border:1px solid var(--m-clay);">
            <form id="merchForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="input-group"><label class="input-label">ä½œå“åç¨±</label><select id="workSelect" onchange="toggleInput('workSelect', 'workInput')"></select><input type="text" id="workInput" style="display:none;" placeholder="è¼¸å…¥æ–°ä½œå“åç¨±"></div>
                
                <!-- è§’è‰²åç¨±èˆ‡å‘¨é‚Šé¡åˆ¥ä¸¦æ’ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 5px;">
                    <div class="input-group" style="margin-bottom: 0;">
                        <label class="input-label">è§’è‰²åç¨±</label>
                        <select id="roleSelect" onchange="toggleInput('roleSelect', 'roleInput')"></select>
                        <input type="text" id="roleInput" style="display:none;" placeholder="è¼¸å…¥æ–°è§’è‰²åç¨±">
                    </div>
                    <div class="input-group" style="margin-bottom: 0;">
                        <label class="input-label">å‘¨é‚Šé¡åˆ¥</label>
                        <select id="typeSelect" onchange="toggleInput('typeSelect', 'typeInput')"></select>
                        <input type="text" id="typeInput" style="display:none;" placeholder="å¾½ç« /ç«‹ç‰Œ/ç‰¹å…¸">
                    </div>
                </div>

                <div class="input-group"><label class="input-label">æ¬¾å¼åç¨±</label><input type="text" id="pattern" required> </div>
                <div class="input-group"><label class="input-label">å‚™è¨»</label><textarea id="note"></textarea></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom: 15px;">
                    <div><label class="input-label">ç‹€æ…‹</label><select id="status" onchange="updateDateLabel()"><option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option><option value="é¡˜æœ›">é¡˜æœ›</option></select></div>
                    <div><label class="input-label">æ•¸é‡</label><input type="number" id="qty" value="1" min="1"></div>
                </div>
                <div class="input-group"><label class="input-label" id="dateLabel">è³¼è²·æ—¥æœŸ(é¸å¡«)</label><input type="date" id="buyDate"></div>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px; margin-bottom: 8px;">
                    <div><label class="input-label">å¹£ç¨®</label><select id="currency" onchange="liveExchange()"><option value="HKD">HKD</option><option value="RMB">RMB</option><option value="JPY">JPY</option></select></div>
                    <div><label class="input-label">å–®åƒ¹</label><input type="number" id="inputPrice" step="0.01" value="0" oninput="liveExchange()"></div>
                </div>
                <div id="exchangePreview" style="margin-bottom: 8px; font-size:12px; color:var(--m-deep-green); font-weight:bold;">ç¸½é¡: HKD 0.00</div>
                <div class="input-group">
                    <label class="input-label">è—å“ç…§ç‰‡</label>
                    <input type="file" id="imgFile" accept="image/*" onchange="handleImageFileSelect(this)">
                    <div id="pendingImageNote" class="image-pending-note" style="display: none;">ğŸ“· å·²æº–å‚™è£å‰ªåœ–ç‰‡ï¼Œå¯ç¹¼çºŒé¸æ“‡å…¶ä»–æª”æ¡ˆè¦†è“‹</div>
                </div>
                <button type="submit" class="btn-main" id="submitBtn">å„²å­˜è‡³è³‡æ–™åº«</button>
                <button type="button" id="delBtn" class="btn-main" style="background:#cc9999; display:none;" onclick="deleteCurrentItem()">åˆªé™¤å–®é …è—å“</button>
            </form>
        </div>
    </div>

    <!-- æ•¸æ“šçµ±è¨ˆé  -->
    <div id="page-stats" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title">æ•¸æ“šçµ±è¨ˆ</div>
            <div style="width:40px;"></div>
        </div>
        <div class="stat-card">
            <div class="stat-title">æ¯æœˆæ”¯å‡ºèµ°å‹¢(HKD)</div>
            <div id="totalExpense" class="total-expense">ç¸½è¨ˆ: HKD 0</div>
            <canvas id="monthlyChart"></canvas>
        </div>
        <div class="stat-card">
            <div class="stat-title">ä½œå“ä½”æ¯”åˆ†æ(HKD)</div>
            <canvas id="workChart"></canvas>
        </div>
        <div class="stat-card">
            <div class="stat-title">è§’è‰²æ”¯å‡ºæ’è¡Œ(HKD)</div>
            <canvas id="roleChart"></canvas>
        </div>
        <div class="stat-card">
            <div class="stat-title">é¡åˆ¥æ•¸é‡åˆ†ä½ˆ</div>
            <canvas id="typeCountChart"></canvas>
        </div>
        <div class="stat-card">
            <div class="stat-title">è§’è‰²æ•¸é‡çµ±è¨ˆ</div>
            <canvas id="roleCountChart"></canvas>
        </div>
    </div>

    <!-- ç³»çµ±è¨­å®šé  -->
    <div id="page-settings" class="page">
        <div class="page-header">
            <div class="back-btn-header" onclick="handleBack()">â†</div>
            <div class="page-title">ç³»çµ±è¨­å®š</div>
            <div style="width:40px;"></div>
        </div>
        <div class="stat-card">
            <label class="input-label">ç¶²æ ¼å¤§å°</label>
            <input type="range" id="gridRange" min="50" max="170" value="160" oninput="handleGridSliderInput(this)" class="grid-range-slider">
            <hr style="border: 0.5px solid #f0f0f0; margin: 25px 0;">
            <button onclick="exportData()" class="btn-main" style="background:var(--m-brown);">åŒ¯å‡ºè³‡æ–™å‚™ä»½(.json)</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(this)">
            <button onclick="document.getElementById('importFile').click()" class="btn-main" style="background:var(--m-sage); margin-top: 10px;">åŒ¯å…¥è³‡æ–™å‚™ä»½</button>
        </div>
    </div>
</div>

<nav class="nav-bar" id="bottom-nav" style="display:none;">
    <button class="nav-item active" onclick="switchTab('page-gallery', this)">é¤¨è—</button>
    <button class="nav-item" onclick="switchTab('page-pending', this)">ç­‰å€™</button>
    <button class="nav-item" onclick="switchTab('page-wish', this)">é¡˜æœ›</button>
    <button class="nav-item" onclick="resetFormForNew(); switchTab('page-recent', this)">æ–°å¢</button>
    <button class="nav-item" onclick="switchTab('page-stats', this)">æ•¸æ“š</button>
    <button class="nav-item" onclick="switchTab('page-settings', this)">è¨­å®š</button>
</nav>

<script>
const STORAGE_KEY = 'archive_master'; 
const DICT_KEY = 'archive_dict_master';
const COVER_KEY = 'archive_cover_bg';
const LAST_INPUT_KEY = 'archive_last_input';
const DEFAULT_WORKS = ['ä¸–ç•Œè¨ˆç•«', 'Vå®¶', 'Alien Stage'];
const DEFAULT_TYPES = ['è¥Ÿ','è‰²ç´™','æ›ä»¶','ç«‹ç‰Œ', 'æ‹ç«‹å¾—'];

// å›ºå®šçš„ç¶²æ ¼å¤§å°é¸é …
const GRID_SIZES = [50, 72, 103, 109, 170];

let merchList = [], dict = { works: [], roles: [], types: [] };
let filters = { work: [], role: [], type: [] };
let sortMode = 'date', sortDesc = true, viewMode = 'grid', charts = {};
let isBatchMode = false, selectedIndices = [];
let currentFilterModalStatus = null;

// è£å‰ª/æ”¾å¤§ç›¸é—œè®Šæ•¸
let cropper = null;
let pendingCropImage = null;
let cropCallback = null;
let isZoomMode = false;

// é•·æŒ‰æ¨™ç±¤é¸å–®
let longPressedTag = { key: null, value: null };

// é˜²æ­¢æ»‘æ¡¿äº‹ä»¶å¾ªç’°
let isUpdatingGrid = false;

// å£“ç¸®åœ–ç‰‡å‡½æ•¸
function compressImage(base64, maxWidth = 800, quality = 0.8) {
    return new Promise((resolve) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const compressed = canvas.toDataURL('image/jpeg', quality);
            resolve(compressed);
        };
        img.onerror = () => {
            resolve(base64);
        };
    });
}

function init() {
    merchList = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

    const savedDict = JSON.parse(localStorage.getItem(DICT_KEY));
    if (savedDict) {
        dict = {
            works: savedDict.works || [],
            roles: savedDict.roles || [],
            types: savedDict.types || []
        };
    } else {
        dict = {
            works: [...DEFAULT_WORKS],
            roles: [],
            types: [...DEFAULT_TYPES]
        };
    }

    const savedCover = localStorage.getItem(COVER_KEY);
    if (savedCover) document.getElementById('cover-page').style.backgroundImage = `url(${savedCover})`;
    
    const savedGridSize = localStorage.getItem('archive_grid_size') || '160';
    const nearest = findNearestGridSize(parseInt(savedGridSize));
    updateGridSize(nearest);
    
    renderSelects(); 
    renderAll(); 
    updateToolUI();

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('tagContextMenu');
        if (menu.style.display === 'block' && !menu.contains(e.target)) {
            menu.style.display = 'none';
        }
    });
}

function findNearestGridSize(val) {
    return GRID_SIZES.reduce((prev, curr) => {
        return (Math.abs(curr - val) < Math.abs(prev - val) ? curr : prev);
    });
}

function handleGridSliderInput(slider) {
    if (isUpdatingGrid) return;
    const val = parseInt(slider.value);
    const nearest = findNearestGridSize(val);
    if (nearest !== val) {
        isUpdatingGrid = true;
        slider.value = nearest;
        isUpdatingGrid = false;
    }
    updateGridSize(nearest);
}

function save() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(merchList));
        localStorage.setItem(DICT_KEY, JSON.stringify(dict));
    } catch (e) {
        showModal("âŒ", "å„²å­˜å¤±æ•—ï¼Œå¯èƒ½åœ–ç‰‡éå¤§æˆ–ç©ºé–“ä¸è¶³");
        throw e;
    }
}

function showModal(icon, text) {
    document.getElementById('modal-icon').innerText = icon;
    document.getElementById('modal-text').innerText = text;
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('success-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('success-modal').style.display = 'none';
}

function updateDateLabel() {
    const status = document.getElementById('status').value;
    const label = document.getElementById('dateLabel');
    if (status === 'éç¾è²¨') label.innerText='é è¨ˆç™¼å”®æ—¥æœŸ(é¸å¡«)';
    else if (status === 'é¡˜æœ›') label.innerText='ç™¼ç¾æ—¥æœŸ(é¸å¡«)';
    else label.innerText='è³¼è²·æ—¥æœŸ(é¸å¡«)';
}

function setBatchMode(on) {
    isBatchMode = on; selectedIndices = [];
    document.getElementById('batch-panel').style.display = isBatchMode? 'flex': 'none';
    document.getElementById('bottom-nav').style.bottom = isBatchMode? '-100px': '25px';
    document.getElementById('main-content').style.marginTop = isBatchMode? '50px': '0px';
    renderAll();
}

function toggleSelectItem(idx) {
    const sIdx = selectedIndices.indexOf(idx);
    if (sIdx > -1) selectedIndices.splice(sIdx, 1); else selectedIndices.push(idx);
    document.getElementById('batch-count').innerText = `å·²é¸æ“‡${selectedIndices.length}é …`;
    renderAll();
}

function confirmBatchDelete() {
    if (selectedIndices.length === 0) return;
    if (!confirm(`ç¢ºå®šåˆªé™¤é¸ä¸­çš„${selectedIndices.length}å€‹è—å“å—?`)) return;

    const indicesToDelete = [...selectedIndices].sort((a, b) => b - a);
    let newList = [...merchList];
    indicesToDelete.forEach(idx => newList.splice(idx, 1));

    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newList));
        localStorage.setItem(DICT_KEY, JSON.stringify(dict));
    } catch (e) {
        showModal("âŒ", "å„²å­˜å¤±æ•—ï¼Œç„¡æ³•åˆªé™¤");
        return;
    }

    merchList = newList;
    renderSelects();
    renderAll();
    setBatchMode(false);
}

function renderAll() {
    const conf = { 'ç¾è²¨': 'readyList', 'éç¾è²¨': 'waitList', 'é¡˜æœ›': 'wishList' };
    const srch = { 'ç¾è²¨': 'lib-search', 'éç¾è²¨': 'wait-search', 'é¡˜æœ›': 'wish-search' };
    Object.keys(conf).forEach(status => {
        const container = document.getElementById(conf[status]); if(!container) return;
        const sVal = document.getElementById(srch[status]) ? document.getElementById(srch[status]).value.toLowerCase() : "";
        let filtered = merchList.map((item, index) => ({...item, originalIndex: index}))
            .filter(i => i.status === status)
            .filter(i => filters.work.length === 0 || filters.work.includes(i.work))
            .filter(i => filters.role.length === 0 || filters.role.includes(i.role))
            .filter(i => filters.type.length === 0 || filters.type.includes(i.type))
           
