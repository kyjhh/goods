<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Archive - V36 Final Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --m-deep-green: #6b7a63; --m-sage: #acc1ad; --m-brown: #a68b7c;
            --m-sand: #d5cabd; --m-clay: #e5ddd5; --bg: #f2efeb;
            --text: #4a4a4a; --radius: 12px; --dynamic-grid: 160px;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* å°é¢é  */
        #cover-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #d2cdc1; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        #cover-page.open { transform: translateY(-100%); }
        .cover-upload-btn { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.4); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2100; }
        
        /* ç·¨è¼¯æ¨¡å¼åˆ— (å¤šé¸) */
        .edit-mode-bar { position: fixed; top: 0; left: 0; width: 100%; background: var(--m-deep-green); color: white; padding: 15px 20px; box-sizing: border-box; display: none; justify-content: space-between; align-items: center; z-index: 1500; font-size: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        .main-content { padding: 25px; padding-bottom: 150px; max-width: 900px; margin: 0 auto; transition: margin-top 0.3s; }
        .page { display: none; }
        .page.active { display: block; }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: #fff; padding: 18px; border-radius: var(--radius); margin-bottom: 25px; border: 1px solid var(--m-clay); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #eee; background: #fafafa; margin-bottom: 15px; box-sizing: border-box; outline: none; font-size: 14px; }
        .symbol-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
        .symbol-group { display: flex; gap: 15px; color: #ccc; align-items: center; }
        .symbol-btn { cursor: pointer; display: flex; align-items: center; }
        .symbol-btn svg { width: 22px; height: 22px; fill: currentColor; }
        .symbol-btn.active { color: var(--m-deep-green); }
        
        .filter-box { display: flex; flex-direction: column; gap: 8px; }
        .filter-row { display: flex; overflow-x: auto; white-space: nowrap; gap: 8px; scrollbar-width: none; padding-bottom: 4px; }
        .filter-chip { background: var(--m-clay); padding: 6px 14px; border-radius: 20px; font-size: 11px; cursor: pointer; color: #777; transition: 0.2s; }
        .filter-chip.active { background: var(--m-sage); color: white; }

        /* å¡ç‰‡ä½ˆå±€ */
        .list-container.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--dynamic-grid), 1fr)); gap: 15px; }
        .item-card { background: #fff; border-radius: var(--radius); overflow: hidden; border: 1px solid var(--m-clay); position: relative; cursor: pointer; transition: transform 0.2s, border 0.2s; user-select: none; }
        .item-card.selected { border: 4px solid var(--m-sage); transform: scale(0.96); }
        .item-card.selected::after { content: "âœ“"; position: absolute; top: 10px; right: 10px; background: var(--m-sage); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; z-index: 5; }

        .img-box { width: 100%; aspect-ratio: 1; background: #f0f0f0; pointer-events: none; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
        .info { padding: 12px; pointer-events: none; }

        /* è¡¨å–® */
        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 11px; color: var(--m-brown); font-weight: bold; margin-bottom: 5px; display: block; letter-spacing: 1px; }
        .btn-main { background: var(--m-deep-green); color: white; border: none; padding: 15px; width: 100%; font-size: 14px; cursor: pointer; border-radius: var(--radius); font-weight: bold; margin-top: 10px; transition: opacity 0.2s; }
        .btn-main:active { opacity: 0.8; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--m-clay); background: #fafafa; font-size: 14px; box-sizing: border-box; outline: none; }
        
        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 5px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 1000; transition: bottom 0.3s; }
        .nav-item { border: none; background: none; color: #b5b5b5; font-size: 10px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--m-deep-green); }
        .nav-item svg { width: 20px; height: 20px; fill: currentColor; }

        /* çµ±è¨ˆ */
        .stat-card { background: #fff; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; border: 1px solid var(--m-clay); }
        .stat-title { font-size: 13px; font-weight: bold; color: var(--m-brown); margin-bottom: 15px; border-left: 4px solid var(--m-sage); padding-left: 10px; }

        /* å½ˆçª— */
        #success-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 35px; border-radius: 20px; text-align: center; z-index: 4000; display: none; width: 250px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 3500; display: none; backdrop-filter: blur(3px); }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="success-modal">
        <div id="modal-icon" style="font-size: 45px; margin-bottom: 15px;">âœ“</div>
        <div id="modal-text" style="font-weight: bold; font-size: 16px;">å·²å®Œæˆ</div>
        <button class="btn-main" onclick="closeModal()">ç¢ºå®š</button>
    </div>

    <div class="edit-mode-bar" id="edit-bar">
        <span onclick="exitEditMode()" style="cursor:pointer;">å–æ¶ˆ</span>
        <span id="select-count" style="font-weight:bold;">å·²é¸æ“‡ 0 é …</span>
        <span onclick="deleteBatch()" style="color: #ffb3b3; font-weight: bold; cursor:pointer;">åˆªé™¤</span>
    </div>

    <div id="cover-page">
        <div class="cover-upload-btn" onclick="document.getElementById('coverInput').click()">
            <svg viewBox="0 0 24 24" width="20" fill="#6b7a63"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
        </div>
        <input type="file" id="coverInput" style="display:none;" onchange="updateCover(this)">
        <div style="margin-bottom: 80px; text-align: center;">
            <h1 style="letter-spacing: 10px; font-weight: 300; color: var(--m-deep-green); margin-bottom: 40px;">M.ARCHIVE</h1>
            <div style="display: flex; flex-direction: column; gap: 15px; width: 200px;">
                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 12px; cursor: pointer; font-size: 13px; letter-spacing: 3px;" onclick="openPage('page-gallery')">é€²å…¥åœ–æ›¸é¤¨</div>
                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 12px; cursor: pointer; font-size: 13px; letter-spacing: 3px;" onclick="openPage('page-pending')">ç­‰å€™æ¸…å–®</div>
                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 12px; cursor: pointer; font-size: 13px; letter-spacing: 3px;" onclick="openPage('page-stats')">æ•¸æ“šçµ±è¨ˆ</div>
            </div>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <div id="back-btn" onclick="closePage()" style="font-size:12px; color: var(--m-brown); cursor:pointer; margin-bottom:25px; display:inline-block;">â† è¿”å›å°é¢</div>

        <div id="page-gallery" class="page">
            <div class="control-panel">
                <input type="text" class="search-input" id="lib-search" placeholder="æœå°‹é—œéµå­—..." oninput="renderAll()">
                <div class="symbol-row">
                    <div class="symbol-group">
                        <span class="symbol-btn sort-date active" onclick="setSort('date')"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg></span>
                        <span class="symbol-btn sort-price" onclick="setSort('price')"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></span>
                        <div style="font-size:11px; cursor:pointer; color:var(--m-brown);" onclick="toggleOrder()" id="order-txt">å€’åº â†“</div>
                    </div>
                    <div style="font-size:11px; color:var(--m-sage); font-weight:bold; cursor:pointer;" onclick="enterEditMode()">æ‰¹é‡ç®¡ç†</div>
                </div>
                <div class="filter-box" id="lib-filters"></div>
            </div>
            <div id="readyList" class="list-container grid"></div>
        </div>

        <div id="page-pending" class="page">
            <div class="control-panel">
                <input type="text" class="search-input" id="wait-search" placeholder="æœå°‹ç­‰å€™ä¸­é …ç›®..." oninput="renderAll()">
                <div class="filter-box" id="wait-filters"></div>
            </div>
            <div id="waitList" class="list-container grid"></div>
        </div>

        <div id="page-recent" class="page">
            <div style="background:#fff; padding:30px; border-radius: var(--radius); border:1px solid var(--m-clay);">
                <form id="merchForm">
                    <input type="hidden" id="editIndex" value="-1">
                    <div class="input-group">
                        <label class="input-label">ä½œå“åç¨±</label>
                        <select id="workSelect" onchange="toggleNewInput('workSelect', 'workInput')"></select>
                        <input type="text" id="workInput" style="display:none; margin-top:8px;" placeholder="è¼¸å…¥æ–°ä½œå“åç¨±">
                    </div>
                    <div class="input-group">
                        <label class="input-label">è§’è‰²åç¨±</label>
                        <select id="roleSelect" onchange="toggleNewInput('roleSelect', 'roleInput')"></select>
                        <input type="text" id="roleInput" style="display:none; margin-top:8px;" placeholder="è¼¸å…¥æ–°è§’è‰²åç¨±">
                    </div>
                    <div class="input-group"><label class="input-label">æ¬¾å¼åç¨±</label><input type="text" id="pattern" required></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-group"><label class="input-label">æ”¶è—ç‹€æ…‹</label><select id="status"><option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option></select></div>
                        <div class="input-group"><label class="input-label">åƒ¹æ ¼ (HKD)</label><input type="number" id="inputPrice" step="0.1" value="0"></div>
                    </div>
                    <div class="input-group"><label class="input-label">ä¸Šå‚³ç…§ç‰‡</label><input type="file" id="imgFile" accept="image/*"></div>
                    <button type="submit" class="btn-main" id="submitBtn">ç¢ºèªå„²å­˜</button>
                    <button type="button" class="btn-main" id="delBtn" style="display:none; background:#cc9999;" onclick="deleteSingle()">åˆªé™¤æ­¤è—å“</button>
                </form>
            </div>
        </div>

        <div id="page-stats" class="page">
            <div class="stat-card"><div class="stat-title">æ¶ˆè²»è¶¨å‹¢ (HKD)</div><canvas id="monthlyChart"></canvas></div>
            <div style="display:grid; grid-template-columns: 1fr; gap:15px;">
                <div class="stat-card"><div class="stat-title">ä½œå“åˆ†ä½ˆ</div><canvas id="workChart"></canvas></div>
                <div class="stat-card"><div class="stat-title">ç†±é–€è§’è‰²æ’è¡Œ</div><canvas id="roleChart"></canvas></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar" id="bottom-nav" style="display:none;">
        <button class="nav-item active" onclick="switchTab('page-gallery', this)"><svg viewBox="0 0 24 24"><path d="M4 10v7h3v-7H4zm6 0v7h3v-7h-3zm6 0v7h3v-7h-3zM2 22h19v-2H2v2zm1-12l8.5-9L20 10V22H3V10z"/></svg>é¤¨è—</button>
        <button class="nav-item" onclick="switchTab('page-pending', this)"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>ç­‰å€™</button>
        <button class="nav-item" onclick="switchTab('page-recent', this)"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>æ–°å¢</button>
        <button class="nav-item" onclick="switchTab('page-stats', this)"><svg viewBox="0 0 24 24"><path d="M10 20h4V4h-4v16zm-6 0h4v-8H4v8zM16 9v11h4V9h-4z"/></svg>æ•¸æ“š</button>
    </nav>

<script>
    const STORAGE_KEY = 'archive_master';
    let merchList = [], dict = { works: [], roles: [] }, filters = { work: 'all', role: 'all' };
    let editMode = false, selectedItems = [], sortMode = 'date', sortDesc = true;

    function init() {
        const saved = localStorage.getItem(STORAGE_KEY);
        merchList = saved ? JSON.parse(saved) : [];
        updateDict();
        renderAll();
        renderFilterChips();
        updateSelects();
        const cover = localStorage.getItem('archive_cover');
        if(cover) document.getElementById('cover-page').style.backgroundImage = `url(${cover})`;
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(merchList)); }

    // --- æ‰¹é‡ç®¡ç†é‚è¼¯ ---
    function enterEditMode() {
        editMode = true; 
        selectedItems = [];
        document.getElementById('edit-bar').style.display = 'flex';
        document.getElementById('bottom-nav').style.bottom = '-100px';
        document.getElementById('main-content').style.marginTop = '60px';
        renderAll();
    }
    function exitEditMode() {
        editMode = false; 
        selectedItems = [];
        document.getElementById('edit-bar').style.display = 'none';
        document.getElementById('bottom-nav').style.bottom = '25px';
        document.getElementById('main-content').style.marginTop = '0';
        renderAll();
    }
    function toggleItem(idx) {
        const p = selectedItems.indexOf(idx);
        if(p === -1) selectedItems.push(idx); else selectedItems.splice(p, 1);
        document.getElementById('select-count').innerText = `å·²é¸æ“‡ ${selectedItems.length} é …`;
        renderAll();
    }
    function deleteBatch() {
        if(!selectedItems.length) return;
        if(confirm(`ç¢ºå®šè¦åˆªé™¤é¸ä¸­çš„ ${selectedItems.length} å€‹è—å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚`)) {
            selectedItems.sort((a,b) => b - a);
            selectedItems.forEach(idx => merchList.splice(idx, 1));
            save(); 
            updateDict(); 
            exitEditMode(); 
            showModal("ğŸ—‘ï¸", "å·²æ‰¹é‡åˆªé™¤");
        }
    }

    // --- æ¸²æŸ“æ ¸å¿ƒ ---
    function renderAll() {
        const containers = { 'ç¾è²¨': 'readyList', 'éç¾è²¨': 'waitList' };
        Object.keys(containers).forEach(status => {
            const box = document.getElementById(containers[status]);
            if(!box) return;
            const searchInput = document.getElementById(status==='ç¾è²¨'?'lib-search':'wait-search');
            const search = (searchInput ? searchInput.value : "").toLowerCase();
            
            let data = merchList.map((item, index) => ({...item, originalIndex: index}))
                .filter(i => i.status === status)
                .filter(i => (filters.work==='all' || i.work===filters.work) && (filters.role==='all' || i.role===filters.role))
                .filter(i => (i.pattern + (i.role||"") + (i.work||"")).toLowerCase().includes(search));

            const m = sortDesc ? 1 : -1;
            data.sort((a,b) => (sortMode==='date' ? (b.timestamp-a.timestamp) : (b.totalHkd-a.totalHkd)) * m);

            box.innerHTML = '';
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = `item-card ${selectedItems.includes(item.originalIndex)?'selected':''}`;
                card.innerHTML = `<div class="img-box"><img src="${item.img||''}"></div>
                    <div class="info"><div style="font-size:9px;color:var(--m-brown);">${item.role||'æœªåˆ†é…'}</div>
                    <div style="font-weight:bold;font-size:11px;margin:3px 0;">${item.pattern}</div>
                    <div style="color:var(--m-deep-green);font-size:11px;">HK$ ${item.totalHkd}</div></div>`;
                card.onclick = () => editMode ? toggleItem(item.originalIndex) : openEdit(item.originalIndex);
                box.appendChild(card);
            });
        });
    }

    function renderFilterChips() {
        const build = (id) => {
            const box = document.getElementById(id); box.innerHTML = '';
            ['work', 'role'].forEach(type => {
                const row = document.createElement('div'); row.className = 'filter-row';
                const items = ['all', ...dict[type+'s']];
                items.forEach(v => {
                    const chip = document.createElement('div');
                    chip.className = `filter-chip ${filters[type]===v?'active':''}`;
                    chip.innerText = v === 'all' ? (type==='work'?'å…¨éƒ¨ä½œå“':'å…¨éƒ¨è§’è‰²') : v;
                    chip.onclick = () => { filters[type] = v; renderFilterChips(); renderAll(); };
                    row.appendChild(chip);
                });
                box.appendChild(row);
            });
        };
        build('lib-filters'); build('wait-filters');
    }

    // --- æ•¸æ“šåœ–è¡¨ ---
    let myCharts = {};
    function renderCharts() {
        const ctxM = document.getElementById('monthlyChart').getContext('2d');
        const ctxW = document.getElementById('workChart').getContext('2d');
        const ctxR = document.getElementById('roleChart').getContext('2d');
        Object.values(myCharts).forEach(c => c.destroy());

        const statsData = merchList.filter(i => i.status === 'ç¾è²¨');
        
        // æ¶ˆè²»è¶¨å‹¢
        const mData = {}; statsData.forEach(i => { const d = new Date(i.timestamp); const k = `${d.getFullYear()}/${d.getMonth()+1}`; mData[k] = (mData[k]||0) + parseFloat(i.totalHkd); });
        myCharts.m = new Chart(ctxM, { type: 'line', data: { labels: Object.keys(mData), datasets: [{ label: 'HKD', data: Object.values(mData), borderColor: '#6b7a63', tension: 0.3 }] } });

        // ä½œå“æ¯”ä¾‹
        const wData = {}; statsData.forEach(i => { if(i.work) wData[i.work] = (wData[i.work]||0) + 1; });
        myCharts.w = new Chart(ctxW, { type: 'doughnut', data: { labels: Object.keys(wData), datasets: [{ data: Object.values(wData), backgroundColor: ['#acc1ad','#a68b7c','#d5cabd','#6b7a63','#e5ddd5'] }] } });

        // è§’è‰²æ’è¡Œ
        const rData = {}; statsData.forEach(i => { if(i.role) rData[i.role] = (rData[i.role]||0) + 1; });
        const topR = Object.entries(rData).sort((a,b)=>b[1]-a[1]).slice(0,5);
        myCharts.r = new Chart(ctxR, { type: 'bar', data: { labels: topR.map(x=>x[0]), datasets: [{ label: 'ä»¶æ•¸', data: topR.map(x=>x[1]), backgroundColor: '#acc1ad' }] }, options: { indexAxis: 'y' } });
    }

    // --- åŸºç¤å·¥å…· ---
    function updateDict() {
        dict.works = [...new Set(merchList.map(i => i.work).filter(Boolean))].sort();
        dict.roles = [...new Set(merchList.map(i => i.role).filter(Boolean))].sort();
    }
    function updateSelects() {
        const fill = (id, list) => {
            const s = document.getElementById(id);
            s.innerHTML = '<option value="">è«‹é¸æ“‡...</option>' + list.map(v => `<option value="${v}">${v}</option>`).join('') + '<option value="NEW">+ æ–°å¢é …</option>';
        };
        fill('workSelect', dict.works); fill('roleSelect', dict.roles);
    }
    function toggleNewInput(sid, iid) { document.getElementById(iid).style.display = document.getElementById(sid).value === 'NEW' ? 'block' : 'none'; }
    function setSort(s) { sortMode = s; document.querySelectorAll('.symbol-btn').forEach(b=>b.classList.remove('active')); document.querySelector(`.sort-${s}`).classList.add('active'); renderAll(); }
    function toggleOrder() { sortDesc = !sortDesc; document.getElementById('order-txt').innerText = sortDesc ? "å€’åº â†“" : "æ­£åº â†‘"; renderAll(); }
    function openPage(id) { document.getElementById('cover-page').classList.add('open'); document.getElementById('bottom-nav').style.display='flex'; switchTab(id, document.querySelector(`button[onclick*="${id}"]`)); }
    function closePage() { document.getElementById('cover-page').classList.remove('open'); document.getElementById('bottom-nav').style.display='none'; exitEditMode(); }
    function switchTab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(id === 'page-stats') renderCharts();
        exitEditMode();
    }
    function updateCover(input) {
        const f = input.files[0]; if(!f) return;
        const fr = new FileReader(); fr.onload = (e) => { document.getElementById('cover-page').style.backgroundImage = `url(${e.target.result})`; localStorage.setItem('archive_cover', e.target.result); };
        fr.readAsDataURL(f);
    }

    function openEdit(idx) {
        const i = merchList[idx]; document.getElementById('editIndex').value = idx;
        document.getElementById('workSelect').value = i.work; document.getElementById('roleSelect').value = i.role;
        document.getElementById('pattern').value = i.pattern; document.getElementById('status').value = i.status;
        document.getElementById('inputPrice').value = i.totalHkd;
        document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™";
        document.getElementById('delBtn').style.display = 'block';
        openPage('page-recent');
    }
    function deleteSingle() {
        const idx = parseInt(document.getElementById('editIndex').value);
        if(idx !== -1 && confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»¶è—å“å—ï¼Ÿ")) { merchList.splice(idx, 1); save(); updateDict(); showModal("ğŸ—‘ï¸", "é …ç›®å·²åˆªé™¤"); switchTab('page-gallery'); }
    }

    // --- æ ¸å¿ƒå„²å­˜é‚è¼¯ (å„ªåŒ–åŒæ­¥åé¥‹) ---
    document.getElementById('merchForm').onsubmit = function(e) {
        e.preventDefault();
        const editIdx = parseInt(document.getElementById('editIndex').value);
        const getV = (sid, iid) => {
            const s = document.getElementById(sid).value;
            return s === 'NEW' ? document.getElementById(iid).value : s;
        };
        const data = {
            work: getV('workSelect', 'workInput'), role: getV('roleSelect', 'roleInput'),
            pattern: document.getElementById('pattern').value, status: document.getElementById('status').value,
            totalHkd: parseFloat(document.getElementById('inputPrice').value || 0).toFixed(2),
            timestamp: editIdx === -1 ? Date.now() : merchList[editIdx].timestamp
        };
        
        const f = document.getElementById('imgFile').files[0];
        const done = (b64) => {
            data.img = b64 || (editIdx !== -1 ? merchList[editIdx].img : "");
            if(editIdx === -1) merchList.unshift(data); else merchList[editIdx] = data;
            
            save(); 
            updateDict(); 
            updateSelects(); 
            renderFilterChips(); 
            renderAll();
            
            // ç¢ºä¿ UI åé¥‹åœ¨å„²å­˜å¾Œç«‹å³è§¸ç™¼
            showModal("âœ“", editIdx === -1 ? "å­˜æª”æˆåŠŸ" : "æ›´æ–°æˆåŠŸ"); 
            this.reset();
            document.getElementById('editIndex').value = "-1";
            document.getElementById('delBtn').style.display = 'none';
            switchTab('page-gallery', document.querySelector('.nav-item')); 
        };

        if(f) { 
            const fr = new FileReader(); 
            fr.onload = () => done(fr.result); 
            fr.readAsDataURL(f); 
        } else {
            done(null);
        }
    };

    function showModal(icon, text) { document.getElementById('modal-icon').innerText=icon; document.getElementById('modal-text').innerText=text; document.getElementById('overlay').style.display='block'; document.getElementById('success-modal').style.display='block'; }
    function closeModal() { document.getElementById('overlay').style.display='none'; document.getElementById('success-modal').style.display='none'; }

    window.onload = init;
</script>
</body>
</html>
