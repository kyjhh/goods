<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Morandi Collection Archive v14</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --m-blue: #92a8d1; --m-green: #88b04b; --m-grey: #b5b5b5;
            --m-sage: #acc1ad; --m-sand: #d5cabd; --bg: #f8f8f7;
            --text: #555; --card-bg: #ffffff;
            --grid-size: 160px;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'PingFang HK', sans-serif; background: var(--bg); color: var(--text); }

        /* é«˜æ¸…å°é¢ */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #eee; background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #cover-page.open { transform: translateY(-100%); }
        .cover-upload-label { position: absolute; top: 30px; left: 30px; background: rgba(255,255,255,0.8); padding: 8px 15px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid var(--m-grey); }

        /* å…§å®¹å€ */
        .main-content { padding: 20px; padding-bottom: 120px; max-width: 800px; margin: 0 auto; min-height: 100vh; }
        .back-to-cover { margin-bottom: 20px; cursor: pointer; color: var(--m-blue); font-size: 14px; font-weight: bold; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        .search-box { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; margin-bottom: 15px; box-sizing: border-box; font-size: 14px; outline: none; }
        .filter-label { font-size: 11px; color: var(--m-blue); font-weight: bold; margin: 10px 0 5px; display: flex; justify-content: space-between; }
        .filter-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; align-items: center; }
        .filter-chip { background: #f0f0f0; border: 1px solid #ddd; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; color: #888; position: relative; }
        .filter-chip.active { background: var(--m-blue); color: white; border-color: var(--m-blue); }
        .delete-btn { color: #ff6b6b; font-size: 10px; margin-left: 5px; font-weight: bold; }
        
        /* åˆ—è¡¨å¡ç‰‡ä½ˆå±€ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--grid-size), 1fr)); gap: 12px; }
        .item-card { background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #eee; position: relative; display: flex; flex-direction: column; }
        .item-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #fafafa; }
        .item-info { padding: 10px; flex-grow: 1; }
        .price-tag { color: var(--m-green); font-weight: bold; font-size: 14px; margin: 2px 0; }
        .checkbox-arrival { position: absolute; top: 8px; right: 8px; transform: scale(1.2); z-index: 10; accent-color: var(--m-green); }

        /* è¡¨å–®æ¨£å¼ */
        .glass-card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #efefef; }
        label { display: block; font-size: 13px; margin: 12px 0 5px; color: var(--m-blue); font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #fff; color: var(--text); box-sizing: border-box; font-size: 14px; }
        .rate-preview { margin-top: 8px; padding: 10px; background: #f9fbf9; border-radius: 8px; border: 1px solid #edf2ed; font-size: 13px; color: var(--m-green); font-weight: bold; }

        .nav-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #fff; display: flex; justify-content: space-around; padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 1000; border: 1px solid #eee; }
        .nav-item { border: none; background: none; color: #bbb; font-size: 22px; cursor: pointer; }
        .nav-item.active { color: var(--m-blue); }
        .btn-main { background: var(--m-sage); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="cover-page">
        <label class="cover-upload-label">ğŸ“¸ å°å…¥é«˜æ¸…å°é¢ <input type="file" id="cover-upload" hidden accept="image/*"></label>
        <div class="cover-menu" style="display: flex; flex-direction: column; gap: 12px; width: 250px;">
            <h2 style="text-align:center; font-weight:300; letter-spacing:2px; margin-bottom:20px;">MORANDI ARCHIVE</h2>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-gallery')">é€²å…¥è—å“åº«</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-stats')">æ•¸æ“šèˆ‡æ”¯å‡º</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-recent')">æ–°å¢å‘¨é‚Š</div>
            <div class="menu-btn" style="background:#fff; border:1px solid #ddd; padding:15px; text-align:center; cursor:pointer; border-radius:8px;" onclick="openPage('page-pending')">æŸ¥çœ‹éç¾è²¨</div>
        </div>
    </div>

    <div class="main-content">
        <div class="back-to-cover" onclick="closePage()">â—€ è¿”å›å°é¢</div>

        <div id="page-gallery" class="page">
            <div class="control-panel">
                <input type="text" class="search-box" id="keywordSearch" placeholder="ğŸ” æœç´¢è§’è‰²ã€æŸ„åœ–ã€ç¨®é¡..." oninput="renderAll()">
                
                <div class="filter-label">
                    <span>ä½œå“åˆ†é¡ (é»æ“Šç¯©é¸ / é•·æŒ‰ä½œå“åå¯åˆªé™¤)</span>
                </div>
                <div class="filter-group" id="workFilter"></div>
                
                <div id="roleFilterSection" style="display:none; margin-top:10px;">
                    <span class="filter-label">è§’è‰²ç´°åˆ†</span>
                    <div class="filter-group" id="roleFilter"></div>
                </div>

                <div class="size-slider-container" style="display:flex; align-items:center; gap:10px; margin-top:10px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:11px; color:#999; margin:0;">ç¸®æ”¾</label>
                    <input type="range" id="gridSlider" min="100" max="350" value="160" oninput="updateGridSize(this.value)" style="flex-grow:1; accent-color:var(--m-sage);">
                </div>
            </div>
            <div class="gallery" id="readyList"></div>
        </div>

        <div id="page-recent" class="page">
            <div class="glass-card">
                <h3 id="formTitle">ğŸ“ ç´€éŒ„å‘¨é‚Š</h3>
                <form id="merchForm">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <label>ä½œå“åç¨±</label>
                    <select id="workSelect" onchange="checkOtherWork(this.value)">
                        </select>
                    <div id="otherWorkInput" style="display:none; margin-top:10px;">
                        <input type="text" id="newWorkName" placeholder="è«‹è¼¸å…¥æ–°ä½œå“åç¨±">
                    </div>

                    <label>è§’è‰²</label><input type="text" id="role" required placeholder="ä¾‹å¦‚ï¼šå®µå´å¥">
                    <label>æŸ„åœ–åç¨±</label><input type="text" id="pattern" placeholder="ä¾‹å¦‚ï¼š25æ™‚ä¸‰é€±å¹´">
                    <label>å‘¨é‚Šç¨®é¡</label><input type="text" id="type" placeholder="ä¾‹å¦‚ï¼šå¾½ç« ">
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>ç‹€æ…‹</label>
                            <select id="status" onchange="toggleArrivalDate(this.value)"><option value="ç¾è²¨">ç¾è²¨</option><option value="éç¾è²¨">éç¾è²¨</option></select>
                        </div>
                        <div><label>æ•¸é‡</label><input type="number" id="qty" value="1" min="1" oninput="liveExchange()"></div>
                    </div>

                    <div id="arrivalGroup" style="display:none;"><label>é è¨ˆåˆ°è²¨æ™‚é–“</label><input type="text" id="arrivalDate" placeholder="ä¾‹ï¼š25å¹´8æœˆ"></div>

                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
                        <div><label>å¹£ç¨®</label><select id="currency" onchange="liveExchange()"><option value="HKD">HKD</option><option value="RMB">RMB</option><option value="JPY">JPY</option></select></div>
                        <div><label>å–®åƒ¹</label><input type="number" id="inputPrice" step="0.01" required oninput="liveExchange()"></div>
                    </div>

                    <div id="exchangePreview" class="rate-preview">ç¸½é¡æ›ç®—: HKD 0.00</div>

                    <label>è³¼å…¥æ—¥æœŸ</label><input type="date" id="buyDate">
                    <label>ç…§ç‰‡</label><input type="file" id="imgFile">
                    
                    <button type="submit" id="submitBtn" class="btn-main">ç¢ºèªå­˜æª”</button>
                    <button type="button" id="cancelBtn" onclick="resetForm()" style="width:100%; background:none; border:1px solid #ccc; padding:10px; margin-top:10px; border-radius:8px; display:none;">å–æ¶ˆç·¨è¼¯</button>
                </form>
            </div>
        </div>

        <div id="page-stats" class="page">
            <div class="glass-card">
                <h3 style="color:var(--m-sage)">ğŸ’° æ”¯å‡ºæ¦‚è¦½</h3>
                <div id="totalSpend" style="font-size: 26px; font-weight: bold; color: var(--m-green);">HKD 0</div>
                <div style="height: 250px;"><canvas id="charPieChart"></canvas></div>
            </div>
            <div class="glass-card"><h4 style="color:var(--m-blue)">ğŸ“… æ¯æœˆæ”¯å‡º</h4><div id="monthlyStats"></div></div>
        </div>

        <div id="page-pending" class="page">
            <h3 style="color:var(--m-grey)">âŒ› éç¾è²¨å¾…æ”¶</h3>
            <div class="gallery" id="waitList"></div>
        </div>
    </div>

    <nav class="nav-bar" id="bottom-nav" style="display:none;">
        <button class="nav-item active" onclick="switchTab('page-gallery', this)">ğŸ–¼ï¸</button>
        <button class="nav-item" onclick="switchTab('page-stats', this)">ğŸ“Š</button>
        <button class="nav-item" onclick="switchTab('page-recent', this)">â•</button>
        <button class="nav-item" onclick="switchTab('page-pending', this)">ğŸ“¦</button>
    </nav>

<script>
    let merchList = JSON.parse(localStorage.getItem('mm25_morandi_v14')) || [];
    let customWorks = JSON.parse(localStorage.getItem('mm25_works')) || ["ä¸–ç•Œè¨ˆç•«", "Vå®¶", "ç•°å½¢èˆå°"];
    const rates = { RMB: 1.08, JPY: 0.052, HKD: 1.0 };
    let myChart = null;
    let currentWork = 'all';
    let currentRole = '';

    // åˆå§‹åŒ–èˆ‡å­˜æª”
    function saveAll() {
        localStorage.setItem('mm25_morandi_v14', JSON.stringify(merchList));
        localStorage.setItem('mm25_works', JSON.stringify(customWorks));
    }

    // ä½œå“é¸å–®æ¸²æŸ“
    function renderWorkOptions() {
        const select = document.getElementById('workSelect');
        let html = customWorks.map(w => `<option value="${w}">${w}</option>`).join('');
        html += `<option value="other">+ æ–°å¢å…¶ä»–ä½œå“</option>`;
        select.innerHTML = html;
    }

    function checkOtherWork(val) {
        document.getElementById('otherWorkInput').style.display = (val === 'other') ? 'block' : 'none';
    }

    // ä½œå“ç¯©é¸æŒ‰éˆ•æ¸²æŸ“
    function renderWorkFilters() {
        const filterBox = document.getElementById('workFilter');
        let html = `<div class="filter-chip ${currentWork==='all'?'active':''}" onclick="setWorkFilter('all', this)">å…¨éƒ¨</div>`;
        html += customWorks.map(w => `
            <div class="filter-chip ${currentWork===w?'active':''}" 
                 onclick="setWorkFilter('${w}', this)" 
                 oncontextmenu="deleteWorkPrompt('${w}'); return false;">
                ${w}
            </div>
        `).join('');
        filterBox.innerHTML = html;
    }

    function deleteWorkPrompt(work) {
        if (confirm(`ç¢ºå®šè¦å¾åˆ—è¡¨ä¸­åˆªé™¤ä½œå“åç¨±ã€Œ${work}ã€å—ï¼Ÿ\n(é€™ä¸æœƒåˆªé™¤å·²æœ‰çš„è—å“ï¼Œä½†ä¸‹æ¬¡å°‡ç„¡æ³•é¸æ“‡æ­¤ä½œå“)`)) {
            customWorks = customWorks.filter(w => w !== work);
            saveAll();
            renderWorkFilters();
            renderWorkOptions();
        }
    }

    function setWorkFilter(work, btn) {
        currentWork = work; currentRole = '';
        renderWorkFilters();
        const roleSection = document.getElementById('roleFilterSection');
        if(work === 'all') {
            roleSection.style.display = 'none';
        } else {
            const roles = [...new Set(merchList.filter(i => i.work === work && i.status === 'ç¾è²¨').map(i => i.role))];
            if(roles.length > 0) {
                roleSection.style.display = 'block';
                document.getElementById('roleFilter').innerHTML = roles.map(r => `<div class="filter-chip" onclick="currentRole='${r}';renderAll();updateRoleUI(this)">${r}</div>`).join('');
            } else {
                roleSection.style.display = 'none';
            }
        }
        renderAll();
    }

    function updateRoleUI(btn) { document.querySelectorAll('#roleFilter .filter-chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); }

    // å…¶é¤˜é‚è¼¯ (åŒ¯ç‡ã€æ¸²æŸ“ã€è¡¨å–®)
    function liveExchange() {
        const cur = document.getElementById('currency').value;
        const price = parseFloat(document.getElementById('inputPrice').value) || 0;
        const qty = parseInt(document.getElementById('qty').value) || 1;
        const totalHkd = (price * rates[cur] * qty).toFixed(2);
        document.getElementById('exchangePreview').innerText = `ç¸½é¡æ›ç®—: HKD ${totalHkd}`;
        return totalHkd;
    }

    function renderAll() {
        const search = document.getElementById('keywordSearch').value.toLowerCase();
        const genHTML = (item, idx) => `
            <div class="item-card">
                ${item.status === 'éç¾è²¨' ? `<input type="checkbox" class="checkbox-arrival" onclick="markArrived(${idx})">` : ''}
                <img src="${item.img || 'https://via.placeholder.com/200/efefef/999999?text=Photo'}" class="item-img">
                <div class="item-info">
                    <div style="font-size:10px; color:var(--m-blue)">${item.work} | ${item.role}</div>
                    <div style="font-weight:bold; font-size:13px; margin:2px 0;">${item.pattern || 'ç„¡æŸ„åœ–'}</div>
                    <div class="price-tag">HK$ ${Number(item.totalHkd).toLocaleString()}</div>
                    <div style="font-size:10px; opacity:0.6;">x${item.qty} ${item.type ? `(${item.type})` : ''}</div>
                    <div style="margin-top:10px; display:flex; justify-content:space-between;">
                        <span style="font-size:11px; cursor:pointer; color:var(--m-blue)" onclick="editItem(${idx})">ç·¨è¼¯</span>
                        <span style="font-size:11px; cursor:pointer; color:#d9534f" onclick="deleteItem(${idx})">åˆªé™¤</span>
                    </div>
                </div>
            </div>`;

        document.getElementById('readyList').innerHTML = merchList.map((item, index) => ({item, index}))
            .filter(o => o.item.status === 'ç¾è²¨' && 
                (currentWork === 'all' || o.item.work === currentWork) && 
                (!currentRole || o.item.role === currentRole) &&
                (!search || o.item.role.toLowerCase().includes(search) || (o.item.pattern && o.item.pattern.toLowerCase().includes(search)))
            ).map(o => genHTML(o.item, o.index)).join('');

        document.getElementById('waitList').innerHTML = merchList.map((item, index) => ({item, index}))
            .filter(o => o.item.status === 'éç¾è²¨').map(o => genHTML(o.item, o.index)).join('');
    }

    document.getElementById('merchForm').onsubmit = function(e) {
        e.preventDefault();
        const editIdx = parseInt(document.getElementById('editIndex').value);
        let workName = document.getElementById('workSelect').value;
        
        if(workName === 'other') {
            workName = document.getElementById('newWorkName').value.trim();
            if(!workName) { alert("è«‹è¼¸å…¥ä½œå“åç¨±"); return; }
            if(!customWorks.includes(workName)) {
                customWorks.push(workName);
                renderWorkOptions();
                renderWorkFilters();
            }
        }

        const doSave = (b64) => {
            const data = {
                work: workName,
                role: document.getElementById('role').value,
                pattern: document.getElementById('pattern').value,
                type: document.getElementById('type').value,
                status: document.getElementById('status').value,
                qty: parseInt(document.getElementById('qty').value),
                originalPrice: parseFloat(document.getElementById('inputPrice').value),
                originalCur: document.getElementById('currency').value,
                totalHkd: liveExchange(),
                buyDate: document.getElementById('buyDate').value,
                arrivalDate: document.getElementById('arrivalDate').value,
                img: b64 || (editIdx !== -1 ? merchList[editIdx].img : null)
            };
            if(editIdx === -1) merchList.unshift(data); else merchList[editIdx] = data;
            saveAll(); resetForm(); renderAll(); switchTab('page-gallery', document.querySelector(`[onclick*="page-gallery"]`));
        };

        const file = document.getElementById('imgFile').files[0];
        if(file) { const r = new FileReader(); r.onload = () => doSave(r.result); r.readAsDataURL(file); }
        else doSave(null);
    };

    // å…¶ä»–åŸºç¤åŠŸèƒ½
    function updateGridSize(val) { document.documentElement.style.setProperty('--grid-size', val + 'px'); localStorage.setItem('mm25_grid_size', val); }
    function markArrived(idx) { merchList[idx].status = 'ç¾è²¨'; saveAll(); renderAll(); }
    function deleteItem(idx) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { merchList.splice(idx,1); saveAll(); renderAll(); } }
    function resetForm() {
        document.getElementById('merchForm').reset();
        document.getElementById('editIndex').value = "-1";
        document.getElementById('otherWorkInput').style.display = 'none';
        document.getElementById('formTitle').innerText = "ğŸ“ ç´€éŒ„å‘¨é‚Š";
        document.getElementById('submitBtn').innerText = "ç¢ºèªå­˜æª”";
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('arrivalGroup').style.display = "none";
        document.getElementById('exchangePreview').innerText = "ç¸½é¡æ›ç®—: HKD 0.00";
    }
    function editItem(idx) {
        const item = merchList[idx];
        document.getElementById('editIndex').value = idx;
        document.getElementById('workSelect').value = item.work;
        document.getElementById('role').value = item.role;
        document.getElementById('pattern').value = item.pattern || '';
        document.getElementById('type').value = item.type || '';
        document.getElementById('status').value = item.status;
        document.getElementById('qty').value = item.qty;
        document.getElementById('currency').value = item.originalCur;
        document.getElementById('inputPrice').value = item.originalPrice;
        document.getElementById('buyDate').value = item.buyDate || '';
        document.getElementById('arrivalDate').value = item.arrivalDate || '';
        toggleArrivalDate(item.status);
        liveExchange();
        document.getElementById('formTitle').innerText = "âœï¸ ç·¨è¼¯è—å“";
        document.getElementById('submitBtn').innerText = "æ›´æ–°è³‡æ–™";
        document.getElementById('cancelBtn').style.display = "block";
        switchTab('page-recent', document.querySelector(`[onclick*="page-recent"]`));
    }
    function toggleArrivalDate(val) { document.getElementById('arrivalGroup').style.display = (val === 'éç¾è²¨') ? 'block' : 'none'; }
    function switchTab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(id === 'page-stats') renderStats();
        renderAll();
    }
    function openPage(id) { document.getElementById('cover-page').classList.add('open'); document.getElementById('bottom-nav').style.display = 'flex'; switchTab(id, document.querySelector(`[onclick*="${id}"]`)); }
    function closePage() { document.getElementById('cover-page').classList.remove('open'); document.getElementById('bottom-nav').style.display = 'none'; }
    function renderStats() {
        let total = 0, charData = {}, monthData = {};
        merchList.forEach(i => {
            const v = parseFloat(i.totalHkd); total += v;
            charData[i.role] = (charData[i.role] || 0) + v;
            if(i.buyDate) { const m = i.buyDate.substring(0, 7); monthData[m] = (monthData[m] || 0) + v; }
        });
        document.getElementById('totalSpend').innerText = `HKD ${total.toLocaleString()}`;
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('charPieChart').getContext('2d'), {
            type: 'pie',
            data: { labels: Object.keys(charData), datasets: [{ data: Object.values(charData), backgroundColor: ['#92a8d1', '#acc1ad', '#d5cabd', '#b5b5b5', '#e1bee7'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
        document.getElementById('monthlyStats').innerHTML = Object.keys(monthData).sort().reverse().map(m => `
            <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee;"><span>${m}</span><b>HK$ ${monthData[m].toLocaleString()}</b></div>`).join('');
    }

    // åˆå§‹åŒ–å°é¢
    const coverPage = document.getElementById('cover-page');
    const storedCover = localStorage.getItem('mm25_hd_cover');
    if(storedCover) coverPage.style.backgroundImage = `url(${storedCover})`;
    document.getElementById('cover-upload').onchange = e => {
        const r = new FileReader();
        r.onload = () => { localStorage.setItem('mm25_hd_cover', r.result); coverPage.style.backgroundImage = `url(${r.result})`; };
        r.readAsDataURL(e.target.files[0]);
    };

    // å•Ÿå‹•æ¸²æŸ“
    renderWorkOptions();
    renderWorkFilters();
    updateGridSize(savedGridSize);
    renderAll();
</script>
</body>
</html>
